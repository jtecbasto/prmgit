{
	"orderInfo": [
		{
			"index": 43,
			"field": "estatusentrega",
			"expr": "solicitudes.idsolicitud",
			"asc": false
		}
	],
	"sql": "SELECT\n\tsolicitudes.idtipoventa,\n\tsolicitudes.fecha,\n\tsolicitudes.fechacaptura,\n\tsolicitudes.idcliente,\n\tsolicitudes.idproducto,\n\tsolicitudes.idplan,\n\tsolicitudes.usuario,\n\tsolicitudes.idtienda,\n\tsolicitudes.fechamodif,\n\tsolicitudes.orden,\n\tsolicitudes.solicitudimg,\n\tsolicitudes.estatus,\n\tsolicitudes.idsolrazon,\n\tsolicitudes.importeatt,\n\tsolicitudes.importesms,\n\tsolicitudes.plazo,\n\tsolicitudes.observaciones,\n\tsolicitudes.equipoincluido,\n\tsolicitudes.rfc,\n\tsolicitudes.idtratamiento,\n\tsolicitudes.riesgo,\n\tsolicitudes.observacionest,\n\tsolicitudes.idcli,\n\tsolicitudes.fecha1avta,\n\tsolicitudes.idplan1avta,\n\tsolicitudes.dn1avta,\n\tsolicitudes.idproceso,\n\tsolicitudes.idorigenventa,\n\tsolicitudes.estatusentrega,\n\tcte.nombre,\n\tcte.paterno,\n\tcte.materno,\n\tev.estado,\n\tev.ciudad,\n\tev.cp,\n\tev.calle,\n\tev.numeroext,\n\tev.numeroint,\n\tev.colonia,\n\tp.descripcion,\n\tCONCAT('https://www.google.com/maps/search/?api=1&query=', REPLACE(TRIM(CONCAT_WS(' ',\n             IFNULL(ev.numeroext,''),IFNULL(ev.calle,''),IFNULL(ev.numeroint,''),\n             IFNULL(ev.colonia,''),IFNULL(ev.cp,''),IFNULL(ev.ciudad,''),IFNULL(ev.estado,'')\n           )),' ','+')) AS maps_url,\n\tCONCAT(TRIM(CONCAT_WS(' ',\n      IF(IFNULL(ev.calle,'')='','', CONCAT('C.',ev.calle)),\n      IFNULL(CONCAT('No.',ev.numeroext),''),\n      IFNULL(CONCAT('Int.',ev.numeroint),''),\n      IFNULL(ev.colonia,''), IFNULL(CONCAT('C.P.',ev.cp),''),\n      IFNULL(ev.ciudad,''), IFNULL(ev.estado,'')\n    ))) AS direccion,\n\tsolicitudes.idsolicitud AS idsolicitud,\n\tss.equipo AS noserie,\n\tss.chip,\n\tev.lat,\n\tev.lng,\n\tsolicitudes.dn AS dn,\n\tsolicitudes.dnpreferido AS dnpreferido,\n\tsolicitudes.cuenta AS cuenta,\n\tsolicitudes.contrato AS contrato,\n\tsolicitudes.contratoportal AS contratoportal,\n\tsolicitudes.plazopendiente AS plazopendiente,\n\tsolicitudes.Factura AS factura,\n\tsolicitudes.fechavenci AS fechavenci,\n\tsolicitudes.ciclo AS ciclo\nFROM\n\tsolicitudes AS solicitudes\n\tLEFT OUTER JOIN clientes AS cte ON cte.idcliente = solicitudes.idcliente\n\tLEFT OUTER JOIN entregasvnp AS ev ON ev.idsolicitud = solicitudes.idsolicitud\n\tLEFT OUTER JOIN productos AS p ON p.idproducto = solicitudes.idproducto\n\tLEFT OUTER JOIN (SELECT\n\tss.idsolicitud,\n\tMAX(CASE WHEN pr.clasif = 'Equipo' THEN ss.esnimei END) AS equipo,\n\tMAX(CASE WHEN pr.clasif = 'Chip'   THEN ss.esnimei END) AS chip\nFROM\n\tseriessolicitadas AS ss\n\tINNER JOIN compras AS cp ON cp.noserie = ss.esnimei\n\tINNER JOIN productos AS pr ON pr.codigoIUSA = cp.codigoproducto\nGROUP BY\n\tss.idsolicitud\n) AS ss ON ss.idsolicitud = solicitudes.idsolicitud\nORDER BY\n\tsolicitudes.idsolicitud DESC\n",
	"connId": "conn",
	"originalTable": "solicitudes",
	"name": "solicitudes",
	"shortTableName": "solicitudes",
	"dbType": 0,
	"tableOwnerIdField": "idsolicitud",
	"usersOwnerIdField": "ID",
	"pageSizeRecords": 50,
	"pageSizeSelectorRecords": [
		"20",
		"30",
		"50",
		"100",
		"500",
		"all"
	],
	"keyFields": [
		"idsolicitud"
	],
	"detailsBadgeColor": "1e90ff",
	"detailsTables": [
		3847630651
	],
	"fields": [
		{
			"name": "idsolicitud",
			"sqlExpression": "solicitudes.idsolicitud",
			"index": 43,
			"strField": "idsolicitud",
			"type": 3,
			"autoinc": true,
			"viewFormats": [
				{}
			],
			"editFormats": [
				{}
			],
			"label": {
				"English": "Idsolicitud"
			},
			"tableName": "solicitudes"
		},
		{
			"name": "idtipoventa",
			"sqlExpression": "solicitudes.idtipoventa",
			"index": 1,
			"strField": "idtipoventa",
			"type": 3,
			"viewFormats": [
				{}
			],
			"editFormats": [
				{
					"format": "Lookup wizard",
					"lookupType": 2,
					"lookupTable": "tiposventa",
					"lookupTableConnection": "conn",
					"lookupLinkField": "idtipoventa",
					"lookupDisplayField": "tipoventa",
					"lookupOrderBy": "tipoventa",
					"lookupWhere": "uso='VIGENTE'"
				}
			],
			"label": {
				"English": "Idtipoventa",
				"Spanish": "Tipo de Venta"
			},
			"tableName": "solicitudes"
		},
		{
			"name": "fecha",
			"sqlExpression": "solicitudes.fecha",
			"index": 2,
			"strField": "fecha",
			"type": 7,
			"separateEditViewFormats": true,
			"viewFormats": [
				{
					"format": "Short Date"
				},
				{
					"format": "Short Date",
					"pageType": "list"
				},
				{
					"format": "Short Date",
					"pageType": "print"
				},
				{
					"format": "Short Date",
					"pageType": "export"
				}
			],
			"editFormats": [
				{
					"format": "Readonly",
					"dateEditType": 11
				},
				{
					"format": "Readonly",
					"pageType": "add",
					"dateEditType": 11
				},
				{
					"format": "Date",
					"pageType": "search",
					"dateEditType": 11,
					"dateLastYearFactor": 1
				}
			],
			"defaultSearchOption": "Between",
			"searchOptions": [
				"Between"
			],
			"label": {
				"English": "Fecha"
			},
			"tableName": "solicitudes"
		},
		{
			"name": "fechacaptura",
			"sqlExpression": "solicitudes.fechacaptura",
			"index": 3,
			"strField": "fechacaptura",
			"type": 135,
			"viewFormats": [
				{
					"format": "Short Date"
				}
			],
			"editFormats": [
				{
					"format": "Date",
					"dateEditType": 11
				}
			],
			"label": {
				"English": "Fechacaptura"
			},
			"tableName": "solicitudes"
		},
		{
			"name": "idcliente",
			"sqlExpression": "solicitudes.idcliente",
			"index": 4,
			"strField": "idcliente",
			"type": 3,
			"viewFormats": [
				{}
			],
			"editFormats": [
				{
					"format": "Lookup wizard",
					"denyDuplicateMessage": {
						"text": "El cliente %value% ya existe",
						"type": 0
					},
					"lookupType": 2,
					"lookupTable": "clientes",
					"lookupTableConnection": "conn",
					"lookupLinkField": "idcliente",
					"lookupDisplayField": "nombre_completo",
					"lookupAllowAdd": true,
					"lookupAllowEdit": true,
					"lookupControlType": 2,
					"lookupListPage": "list",
					"lookupAddPage": "add",
					"lookupEditPage": "edit",
					"lookupAutofillFields": [
						{
							"masterField": "nombre",
							"lookupField": "nombre"
						},
						{
							"masterField": "paterno",
							"lookupField": "paterno"
						},
						{
							"masterField": "materno",
							"lookupField": "materno"
						},
						{
							"masterField": "rfc",
							"lookupField": "rfc"
						},
						{
							"masterField": "cliente_id",
							"lookupField": "idcliente"
						}
					]
				}
			],
			"label": {
				"English": "Idcliente",
				"Spanish": "Cliente"
			},
			"placeholder": {
				"Spanish": "Seleccione al cliente"
			},
			"tableName": "solicitudes"
		},
		{
			"name": "idproducto",
			"sqlExpression": "solicitudes.idproducto",
			"index": 5,
			"strField": "idproducto",
			"type": 3,
			"viewFormats": [
				{
					"textShowFirstN": 20
				}
			],
			"editFormats": [
				{
					"format": "Lookup wizard",
					"required": true,
					"lookupType": 2,
					"lookupTable": "productos",
					"lookupTableConnection": "conn",
					"lookupLinkField": "idproducto",
					"lookupDisplayField": "descripcion",
					"lookupControlType": 2,
					"lookupListPage": "list"
				}
			],
			"filterFormat": {
				"format": "Values list"
			},
			"label": {
				"English": "Idproducto",
				"Spanish": "Producto"
			},
			"placeholder": {
				"Spanish": "Seleccione el equipo"
			},
			"tableName": "solicitudes"
		},
		{
			"name": "idplan",
			"sqlExpression": "solicitudes.idplan",
			"index": 6,
			"strField": "idplan",
			"type": 3,
			"viewFormats": [
				{}
			],
			"editFormats": [
				{
					"format": "Lookup wizard",
					"required": true,
					"lookupType": 2,
					"lookupTable": "planes",
					"lookupTableConnection": "conn",
					"lookupLinkField": "idplan",
					"lookupDisplayField": "plan",
					"lookupWhere": "uso = 'Vigente' and tipo='Masivo'"
				}
			],
			"label": {
				"English": "Idplan",
				"Spanish": "Plan"
			},
			"placeholder": {
				"Spanish": "Seleccione el plan"
			},
			"tableName": "solicitudes"
		},
		{
			"name": "usuario",
			"sqlExpression": "solicitudes.usuario",
			"index": 7,
			"strField": "usuario",
			"type": 200,
			"viewFormats": [
				{}
			],
			"editFormats": [
				{}
			],
			"label": {
				"English": "Usuario"
			},
			"tableName": "solicitudes"
		},
		{
			"name": "idtienda",
			"sqlExpression": "solicitudes.idtienda",
			"index": 8,
			"strField": "idtienda",
			"type": 3,
			"viewFormats": [
				{}
			],
			"editFormats": [
				{}
			],
			"label": {
				"English": "Idtienda"
			},
			"tableName": "solicitudes"
		},
		{
			"name": "fechamodif",
			"sqlExpression": "solicitudes.fechamodif",
			"index": 9,
			"strField": "fechamodif",
			"type": 135,
			"viewFormats": [
				{
					"format": "Short Date"
				}
			],
			"editFormats": [
				{
					"format": "Date",
					"dateEditType": 11
				}
			],
			"label": {
				"English": "Fechamodif"
			},
			"tableName": "solicitudes"
		},
		{
			"name": "orden",
			"sqlExpression": "solicitudes.orden",
			"index": 10,
			"strField": "orden",
			"type": 200,
			"viewFormats": [
				{}
			],
			"editFormats": [
				{
					"required": true,
					"validateAs": "Regular expression",
					"validateRegex": "^[A-Z0-9]{11}$",
					"validateRegexMessage": {
						"text": "El valor es inválido",
						"type": 0
					},
					"textboxMaxLenth": 11
				}
			],
			"label": {
				"English": "Orden"
			},
			"placeholder": {
				"Spanish": "Ingrese la orden"
			},
			"tableName": "solicitudes"
		},
		{
			"name": "solicitudimg",
			"sqlExpression": "solicitudes.solicitudimg",
			"index": 11,
			"strField": "solicitudimg",
			"type": 201,
			"viewFormats": [
				{}
			],
			"editFormats": [
				{
					"format": "Text area"
				}
			],
			"label": {
				"English": "Solicitudimg"
			},
			"tableName": "solicitudes"
		},
		{
			"name": "estatus",
			"sqlExpression": "solicitudes.estatus",
			"index": 12,
			"strField": "estatus",
			"type": 200,
			"viewFormats": [
				{}
			],
			"editFormats": [
				{
					"format": "Lookup wizard",
					"lookupTable": "decisionessolicitud_lookup",
					"lookupTableConnection": "conn",
					"lookupLinkField": "decisionsolicitud",
					"lookupDisplayField": "decisionsolicitud",
					"lookupOrderBy": "decisionsolicitud"
				}
			],
			"label": {
				"English": "Estatus"
			},
			"tableName": "solicitudes"
		},
		{
			"name": "idsolrazon",
			"sqlExpression": "solicitudes.idsolrazon",
			"index": 13,
			"strField": "idsolrazon",
			"type": 3,
			"viewFormats": [
				{}
			],
			"editFormats": [
				{}
			],
			"label": {
				"English": "Idsolrazon"
			},
			"tableName": "solicitudes"
		},
		{
			"name": "importeatt",
			"sqlExpression": "solicitudes.importeatt",
			"index": 14,
			"strField": "importeatt",
			"type": 5,
			"viewFormats": [
				{
					"format": "Number"
				}
			],
			"editFormats": [
				{}
			],
			"label": {
				"English": "Importeatt"
			},
			"tableName": "solicitudes"
		},
		{
			"name": "importesms",
			"sqlExpression": "solicitudes.importesms",
			"index": 15,
			"strField": "importesms",
			"type": 5,
			"viewFormats": [
				{
					"format": "Number"
				}
			],
			"editFormats": [
				{}
			],
			"label": {
				"English": "Importesms"
			},
			"tableName": "solicitudes"
		},
		{
			"name": "plazo",
			"sqlExpression": "solicitudes.plazo",
			"index": 16,
			"strField": "plazo",
			"type": 2,
			"separateEditViewFormats": true,
			"viewFormats": [
				{},
				{
					"pageType": "list"
				},
				{
					"pageType": "print"
				},
				{
					"pageType": "export"
				}
			],
			"editFormats": [
				{
					"format": "Lookup wizard",
					"lookupTable": "plazos",
					"lookupTableConnection": "conn",
					"lookupLinkField": "plazo",
					"lookupDisplayField": "plazo",
					"lookupOrderBy": "plazo"
				},
				{
					"format": "Lookup wizard",
					"pageType": "add",
					"lookupTable": "plazos",
					"lookupTableConnection": "conn",
					"lookupLinkField": "plazo",
					"lookupDisplayField": "plazo",
					"lookupOrderBy": "plazo"
				},
				{
					"format": "Readonly",
					"pageType": "search",
					"required": true,
					"lookupTable": "plazos",
					"lookupTableConnection": "conn",
					"lookupLinkField": "plazo",
					"lookupDisplayField": "plazo",
					"lookupOrderBy": "plazo"
				}
			],
			"label": {
				"English": "Plazo"
			},
			"placeholder": {
				"Spanish": "Ingrese el plazo"
			},
			"tableName": "solicitudes"
		},
		{
			"name": "observaciones",
			"sqlExpression": "solicitudes.observaciones",
			"index": 17,
			"strField": "observaciones",
			"type": 200,
			"separateEditViewFormats": true,
			"viewFormats": [
				{},
				{
					"pageType": "list",
					"textShowFirstN": 30
				},
				{
					"pageType": "print"
				},
				{
					"pageType": "export"
				}
			],
			"editFormats": [
				{},
				{
					"pageType": "add"
				},
				{
					"pageType": "search"
				}
			],
			"label": {
				"English": "Observaciones",
				"Spanish": "Observaciones"
			},
			"tableName": "solicitudes"
		},
		{
			"name": "equipoincluido",
			"sqlExpression": "solicitudes.equipoincluido",
			"index": 18,
			"strField": "equipoincluido",
			"type": 2,
			"viewFormats": [
				{}
			],
			"editFormats": [
				{}
			],
			"label": {
				"English": "Equipoincluido"
			},
			"tableName": "solicitudes"
		},
		{
			"name": "rfc",
			"sqlExpression": "solicitudes.rfc",
			"index": 19,
			"strField": "rfc",
			"type": 200,
			"viewFormats": [
				{}
			],
			"editFormats": [
				{
					"format": "Readonly"
				}
			],
			"label": {
				"English": "Rfc"
			},
			"tableName": "solicitudes"
		},
		{
			"name": "idtratamiento",
			"sqlExpression": "solicitudes.idtratamiento",
			"index": 20,
			"strField": "idtratamiento",
			"type": 3,
			"viewFormats": [
				{}
			],
			"editFormats": [
				{}
			],
			"label": {
				"English": "Idtratamiento"
			},
			"tableName": "solicitudes"
		},
		{
			"name": "riesgo",
			"sqlExpression": "solicitudes.riesgo",
			"index": 21,
			"strField": "riesgo",
			"type": 129,
			"viewFormats": [
				{
					"linkDisplay": 2,
					"linkDisplayField": "direccion"
				}
			],
			"editFormats": [
				{}
			],
			"label": {
				"English": "Riesgo"
			},
			"tableName": "solicitudes"
		},
		{
			"name": "observacionest",
			"sqlExpression": "solicitudes.observacionest",
			"index": 22,
			"strField": "observacionest",
			"type": 200,
			"viewFormats": [
				{}
			],
			"editFormats": [
				{}
			],
			"label": {
				"English": "Observacionest"
			},
			"tableName": "solicitudes"
		},
		{
			"name": "idcli",
			"sqlExpression": "solicitudes.idcli",
			"index": 23,
			"strField": "idcli",
			"type": 200,
			"viewFormats": [
				{}
			],
			"editFormats": [
				{}
			],
			"label": {
				"English": "Idcli",
				"Spanish": "Cliente ID"
			},
			"tableName": "solicitudes"
		},
		{
			"name": "fecha1avta",
			"sqlExpression": "solicitudes.fecha1avta",
			"index": 24,
			"strField": "fecha1avta",
			"type": 7,
			"viewFormats": [
				{
					"format": "Short Date"
				}
			],
			"editFormats": [
				{
					"format": "Date",
					"dateEditType": 11
				}
			],
			"label": {
				"English": "Fecha1avta"
			},
			"tableName": "solicitudes"
		},
		{
			"name": "idplan1avta",
			"sqlExpression": "solicitudes.idplan1avta",
			"index": 25,
			"strField": "idplan1avta",
			"type": 3,
			"viewFormats": [
				{}
			],
			"editFormats": [
				{}
			],
			"label": {
				"English": "Idplan1avta"
			},
			"tableName": "solicitudes"
		},
		{
			"name": "dn1avta",
			"sqlExpression": "solicitudes.dn1avta",
			"index": 26,
			"strField": "dn1avta",
			"type": 200,
			"viewFormats": [
				{}
			],
			"editFormats": [
				{}
			],
			"label": {
				"English": "Dn1avta"
			},
			"tableName": "solicitudes"
		},
		{
			"name": "idproceso",
			"sqlExpression": "solicitudes.idproceso",
			"index": 27,
			"strField": "idproceso",
			"type": 2,
			"viewFormats": [
				{}
			],
			"editFormats": [
				{}
			],
			"label": {
				"English": "Idproceso"
			},
			"tableName": "solicitudes"
		},
		{
			"name": "idorigenventa",
			"sqlExpression": "solicitudes.idorigenventa",
			"index": 28,
			"strField": "idorigenventa",
			"type": 3,
			"viewFormats": [
				{}
			],
			"editFormats": [
				{}
			],
			"label": {
				"English": "Idorigenventa"
			},
			"tableName": "solicitudes"
		},
		{
			"name": "nombre",
			"sqlExpression": "cte.nombre",
			"index": 30,
			"strField": "nombre",
			"type": 200,
			"viewFormats": [
				{}
			],
			"editFormats": [
				{
					"format": "Readonly"
				}
			],
			"label": {
				"Spanish": "Nombre(s)"
			},
			"placeholder": {
				"Spanish": "Nombre(s) del cliente"
			},
			"tableName": "clientes"
		},
		{
			"name": "paterno",
			"sqlExpression": "cte.paterno",
			"index": 31,
			"strField": "paterno",
			"type": 200,
			"viewFormats": [
				{}
			],
			"editFormats": [
				{
					"format": "Readonly"
				}
			],
			"label": {
				"Spanish": "Paterno"
			},
			"placeholder": {
				"Spanish": "Apellido paterno"
			},
			"tableName": "clientes"
		},
		{
			"name": "materno",
			"sqlExpression": "cte.materno",
			"index": 32,
			"strField": "materno",
			"type": 200,
			"viewFormats": [
				{}
			],
			"editFormats": [
				{
					"format": "Readonly"
				}
			],
			"label": {
				"Spanish": "Materno"
			},
			"placeholder": {
				"Spanish": "Apellido materno"
			},
			"tableName": "clientes"
		},
		{
			"name": "estado",
			"sqlExpression": "ev.estado",
			"index": 33,
			"strField": "estado",
			"type": 200,
			"viewFormats": [
				{}
			],
			"editFormats": [
				{
					"textHTML5Input": "Text"
				}
			],
			"label": {
				"Spanish": "Estado"
			},
			"tableName": "entregasvnp"
		},
		{
			"name": "ciudad",
			"sqlExpression": "ev.ciudad",
			"index": 34,
			"strField": "ciudad",
			"type": 200,
			"viewFormats": [
				{}
			],
			"editFormats": [
				{}
			],
			"label": {
				"Spanish": "Ciudad"
			},
			"tableName": "entregasvnp"
		},
		{
			"name": "cp",
			"sqlExpression": "ev.cp",
			"index": 35,
			"strField": "cp",
			"type": 200,
			"viewFormats": [
				{}
			],
			"editFormats": [
				{}
			],
			"label": {
				"Spanish": "CP"
			},
			"tableName": "entregasvnp"
		},
		{
			"name": "calle",
			"sqlExpression": "ev.calle",
			"index": 36,
			"strField": "calle",
			"type": 200,
			"viewFormats": [
				{}
			],
			"editFormats": [
				{}
			],
			"label": {
				"Spanish": "Calle"
			},
			"tableName": "entregasvnp"
		},
		{
			"name": "numeroext",
			"sqlExpression": "ev.numeroext",
			"index": 37,
			"strField": "numeroext",
			"type": 200,
			"viewFormats": [
				{}
			],
			"editFormats": [
				{}
			],
			"label": {
				"Spanish": "# Ext"
			},
			"tableName": "entregasvnp"
		},
		{
			"name": "numeroint",
			"sqlExpression": "ev.numeroint",
			"index": 38,
			"strField": "numeroint",
			"type": 200,
			"viewFormats": [
				{}
			],
			"editFormats": [
				{}
			],
			"label": {
				"Spanish": "# Int"
			},
			"tableName": "entregasvnp"
		},
		{
			"name": "colonia",
			"sqlExpression": "ev.colonia",
			"index": 39,
			"strField": "colonia",
			"type": 200,
			"viewFormats": [
				{}
			],
			"editFormats": [
				{}
			],
			"label": {
				"Spanish": "Colonia"
			},
			"tableName": "entregasvnp"
		},
		{
			"name": "descripcion",
			"sqlExpression": "p.descripcion",
			"index": 40,
			"strField": "descripcion",
			"type": 200,
			"viewFormats": [
				{}
			],
			"editFormats": [
				{
					"format": "Readonly"
				}
			],
			"label": {
				"Spanish": "Descripción"
			},
			"tableName": "productos"
		},
		{
			"name": "maps_url",
			"sqlExpression": "CONCAT('https://www.google.com/maps/search/?api=1&query=', REPLACE(TRIM(CONCAT_WS(' ',\n             IFNULL(ev.numeroext,''),IFNULL(ev.calle,''),IFNULL(ev.numeroint,''),\n             IFNULL(ev.colonia,''),IFNULL(ev.cp,''),IFNULL(ev.ciudad,''),IFNULL(ev.estado,'')\n           )),' ','+'))",
			"index": 41,
			"strField": "maps_url",
			"type": 200,
			"viewFormats": [
				{
					"format": "Hyperlink",
					"linkNewWindow": true,
					"linkDisplay": 2,
					"linkDisplayField": "direccion",
					"linkDisplayText": {
						"text": "Dirección de entrega...",
						"type": 0
					}
				}
			],
			"editFormats": [
				{}
			],
			"label": {
				"Spanish": "Maps Url"
			},
			"tableName": ""
		},
		{
			"name": "direccion",
			"sqlExpression": "CONCAT(TRIM(CONCAT_WS(' ',\n      IF(IFNULL(ev.calle,'')='','', CONCAT('C.',ev.calle)),\n      IFNULL(CONCAT('No.',ev.numeroext),''),\n      IFNULL(CONCAT('Int.',ev.numeroint),''),\n      IFNULL(ev.colonia,''), IFNULL(CONCAT('C.P.',ev.cp),''),\n      IFNULL(ev.ciudad,''), IFNULL(ev.estado,'')\n    )))",
			"index": 42,
			"strField": "direccion",
			"type": 200,
			"viewFormats": [
				{
					"format": "Custom",
					"customExpression": "\r\n"
				}
			],
			"editFormats": [
				{}
			],
			"label": {
				"Spanish": "Direccion"
			},
			"tableName": ""
		},
		{
			"name": "estatusentrega",
			"sqlExpression": "solicitudes.estatusentrega",
			"index": 29,
			"strField": "estatusentrega",
			"type": 3,
			"separateEditViewFormats": true,
			"viewFormats": [
				{},
				{
					"format": "Custom",
					"pageType": "list",
					"customExpression": "switch($value)\r\n{\r\n    case 'PROGRAMADO';\r\n        $clase .= \" status-en-proceso\";\r\n        break;\r\n    case 'EN TRANSITO';\r\n        $clase .= \" status-en-proceso\";\r\n        break;\r\n    case 'REPROGRAMADO';\r\n        $clase .= \" status-en-proceso\";\r\n        break;\r\n    case 'DEVUELTO/CANCELADO';\r\n        $clase .= \" status-cancelado\";\r\n        break;\r\n    case 'ENTREGADO/INCOMPLETO';\r\n        $clase .= \" status-entregado\";\r\n        break;\r\n    case 'CERRADO';\r\n        $clase .= \" status-entregado\";\r\n        break;\r\n\r\n}\r\n\r\n$value = \"<span class='\" . $clase . \"'>\" . $value . \"</span>\";"
				},
				{
					"pageType": "export"
				},
				{
					"pageType": "masterlist"
				},
				{
					"pageType": "masterprint"
				}
			],
			"editFormats": [
				{
					"format": "Lookup wizard",
					"lookupTable": "estatusentregas",
					"lookupTableConnection": "conn",
					"lookupLinkField": "id",
					"lookupDisplayField": "estatusentrega"
				},
				{
					"format": "Lookup wizard",
					"pageType": "add",
					"lookupTable": "estatusentregas",
					"lookupTableConnection": "conn",
					"lookupLinkField": "id",
					"lookupDisplayField": "estatusentrega"
				},
				{
					"format": "Lookup wizard",
					"pageType": "search",
					"lookupTable": "estatusentregas",
					"lookupTableConnection": "conn",
					"lookupLinkField": "id",
					"lookupDisplayField": "estatusentrega"
				}
			],
			"label": {
				"Spanish": "Estatus entrega"
			},
			"tableName": "solicitudes"
		},
		{
			"name": "chip",
			"sqlExpression": "ss.chip",
			"index": 45,
			"strField": "chip",
			"type": 200,
			"viewFormats": [
				{}
			],
			"editFormats": [
				{
					"format": "Readonly"
				}
			],
			"label": {
				"Spanish": "Simcard"
			},
			"tableName": ""
		},
		{
			"name": "lat",
			"sqlExpression": "ev.lat",
			"index": 46,
			"strField": "lat",
			"type": 14,
			"viewFormats": [
				{}
			],
			"editFormats": [
				{
					"validateAs": "Number"
				}
			],
			"label": {
				"Spanish": "Latitud"
			},
			"tableName": "entregasvnp"
		},
		{
			"name": "lng",
			"sqlExpression": "ev.lng",
			"index": 47,
			"strField": "lng",
			"type": 14,
			"viewFormats": [
				{}
			],
			"editFormats": [
				{}
			],
			"label": {
				"Spanish": "Longitud"
			},
			"tableName": "entregasvnp"
		},
		{
			"name": "noserie",
			"sqlExpression": "ss.equipo",
			"index": 44,
			"strField": "equipo",
			"type": 200,
			"viewFormats": [
				{}
			],
			"editFormats": [
				{
					"required": true
				}
			],
			"label": {
				"Spanish": "IMEI"
			},
			"tableName": ""
		},
		{
			"name": "dn",
			"sqlExpression": "solicitudes.dn",
			"index": 48,
			"strField": "dn",
			"type": 200,
			"viewFormats": [
				{}
			],
			"editFormats": [
				{
					"required": true,
					"textboxMaxLenth": 10,
					"textboxMask": "9999999999"
				}
			],
			"label": {
				"Spanish": "DN"
			},
			"tableName": "solicitudes"
		},
		{
			"name": "cuenta",
			"sqlExpression": "solicitudes.cuenta",
			"index": 50,
			"strField": "cuenta",
			"type": 200,
			"viewFormats": [
				{}
			],
			"editFormats": [
				{
					"validateAs": "Number",
					"textboxMaxLenth": 50
				}
			],
			"label": {
				"Spanish": "Cuenta"
			},
			"tableName": "solicitudes"
		},
		{
			"name": "contrato",
			"sqlExpression": "solicitudes.contrato",
			"index": 51,
			"strField": "contrato",
			"type": 200,
			"viewFormats": [
				{}
			],
			"editFormats": [
				{
					"textboxMaxLenth": 10
				}
			],
			"label": {
				"Spanish": "Contrato"
			},
			"tableName": "solicitudes"
		},
		{
			"name": "contratoportal",
			"sqlExpression": "solicitudes.contratoportal",
			"index": 52,
			"strField": "contratoportal",
			"type": 200,
			"viewFormats": [
				{}
			],
			"editFormats": [
				{}
			],
			"label": {
				"Spanish": "Contrato Portal"
			},
			"tableName": "solicitudes"
		},
		{
			"name": "plazopendiente",
			"sqlExpression": "solicitudes.plazopendiente",
			"index": 53,
			"strField": "plazopendiente",
			"type": 2,
			"viewFormats": [
				{}
			],
			"editFormats": [
				{
					"validateAs": "Number"
				}
			],
			"label": {
				"Spanish": "Plazo pendiente"
			},
			"tableName": "solicitudes"
		},
		{
			"name": "factura",
			"sqlExpression": "solicitudes.Factura",
			"index": 54,
			"strField": "Factura",
			"type": 200,
			"viewFormats": [
				{}
			],
			"editFormats": [
				{
					"textboxMaxLenth": 18
				}
			],
			"label": {
				"Spanish": "Factura"
			},
			"tableName": "solicitudes"
		},
		{
			"name": "fechavenci",
			"sqlExpression": "solicitudes.fechavenci",
			"index": 55,
			"strField": "fechavenci",
			"type": 7,
			"viewFormats": [
				{}
			],
			"editFormats": [
				{
					"format": "Date"
				}
			],
			"label": {
				"Spanish": "Vencimiento"
			},
			"tableName": "solicitudes"
		},
		{
			"name": "ciclo",
			"sqlExpression": "solicitudes.ciclo",
			"index": 56,
			"strField": "ciclo",
			"type": 3,
			"viewFormats": [
				{}
			],
			"editFormats": [
				{
					"format": "Lookup wizard",
					"lookupType": 2,
					"lookupTable": "ciclos",
					"lookupTableConnection": "conn",
					"lookupLinkField": "ciclo",
					"lookupDisplayField": "corte",
					"lookupOrderBy": "corte",
					"lookupWhere": "clasif = 2"
				}
			],
			"label": {
				"Spanish": "Ciclo"
			},
			"tableName": "solicitudes"
		},
		{
			"name": "dnpreferido",
			"sqlExpression": "solicitudes.dnpreferido",
			"index": 49,
			"strField": "dnpreferido",
			"type": 200,
			"viewFormats": [
				{}
			],
			"editFormats": [
				{
					"textboxMaxLenth": 10
				}
			],
			"label": {
				"Spanish": "DN Preferido"
			},
			"tableName": "solicitudes"
		}
	],
	"whereTabs": [
		{
			"where": "if(solicitudes.usuario=':session.UserID',true,if(:session.acceso=1,solicitudes.idtienda=:session.Tienda,if(:session.Acceso=0 or upper(':session.UserID')='ADMIN',true,false)))"
		}
	],
	"eventHandlers": [
		{
			"eventId": "EVENT_JS_ONLOAD",
			"pageType": "list",
			"code": "\r\n\r\n(function () {\r\n  /* ========== CONFIG (edita a tu gusto) ========== */\r\n  const CONFIG = {\r\n    // TODOS los campos que gobernarás (exactos)\r\n    fields: ['estatus', 'estatusentrega'],\r\n\r\n    // Si tus GroupID son números, mapéalos a nombres:\r\n    roleAliases: { '1':'ADMIN', '2':'VALIDADOR' },\r\n\r\n    // Reglas (la PRIMERA que coincida se aplica)\r\n    // Usa enable / readonly / disable con arrays de campos o '*' para todos los de CONFIG.fields\r\n    rules: [\r\n      { match: { user: ['ADMIN'] }, enable: ['*'] },    \r\n      { match: { role: ['ADMIN'] },       enable: ['*'] },                 // Admin: todo habilitado\r\n      { match: { role: ['MESADECONTROL'] },   enable: ['estatusentrega'], disable: ['*'] }, // Validador: solo 'estatus'\r\n     { match: { role: ['VALIDADOR'] },   enable: ['estatus'], disable: ['*'] }, // Validador: solo 'estatus'\r\n      // Si “VENDEDORES” y “GERENTES” son ROLES (no usuarios), usa role: [...]\r\n      { match: { role: ['VENDEDORES','GERENTES'] }, disable: ['estatus'] },      // Todo bloqueado\r\n      { match: { default: true },         disable: ['*'] }                 // Fallback\r\n    ]\r\n  };\r\n  /* ====== FIN CONFIG ====== */\r\n\r\n  const DEBUG = false;\r\n  const log = (...a)=>{ if (DEBUG) console.log('[lock]', ...a); };\r\n\r\n  // ---- Normalización rol/usuario desde PHP ----\r\n  let ROLE = (proxy.currentRole || '').toString().trim();\r\n  const USER = (proxy.currentUser || '').toString().trim().toUpperCase();\r\n  if (CONFIG.roleAliases[ROLE]) ROLE = CONFIG.roleAliases[ROLE];\r\n  ROLE = ROLE.toUpperCase();\r\n\r\n  // ---- Motor de reglas: first match wins ----\r\n  function resolveRule() {\r\n    for (const r of CONFIG.rules) {\r\n      const m = r.match || {};\r\n      if (m.default) return r;\r\n      const byRole = !m.role || m.role.map(x=>x.toString().toUpperCase()).includes(ROLE);\r\n      const byUser = !m.user || m.user.map(x=>x.toString().toUpperCase()).includes(USER);\r\n      if (byRole && byUser) return r;\r\n    }\r\n    return { disable: ['*'] };\r\n  }\r\n  function expand(list) {\r\n    if (!list) return [];\r\n    return list.includes('*') ? CONFIG.fields.slice() : list.slice();\r\n  }\r\n\r\n  const rule = resolveRule();\r\n  let enable   = new Set(expand(rule.enable));\r\n  let readonly = new Set(expand(rule.readonly).filter(f=>!enable.has(f)));\r\n  let disable  = new Set(expand(rule.disable).filter(f=>!enable.has(f) && !readonly.has(f)));\r\n\r\n  const ALL = [...new Set([...enable, ...readonly, ...disable])];\r\n\r\n  // ---- Selectores por patrón de IDs (PHPRunner) ----\r\n  const qCtrl   = (f, scope)=>$(scope||document).find(`[id^=\"value_${f}_\"],[id^=\"display_value_${f}_\"]`);\r\n  const qLookup = (f, scope)=>$(scope||document).find(`[id^=\"open_lookup_${f}_\"]`);\r\n\r\n  function doEnable(f, scope){\r\n    const $els = qCtrl(f,scope).removeClass('ph-disabled');\r\n    $els.each(function(){\r\n      $(this).prop('disabled', false).prop('readonly', false);\r\n      const $s2 = $(this).next('.select2-container, .select2');\r\n      if ($s2.length) $s2.removeClass('ph-disabled').css('pointer-events','');\r\n    });\r\n    qLookup(f,scope).removeClass('ph-disabled').css('pointer-events','').attr('aria-disabled',null).off('click._lock');\r\n  }\r\n  function doReadonly(f, scope){\r\n    const $els = qCtrl(f,scope).addClass('ph-disabled');\r\n    $els.each(function(){\r\n      if (this.tagName === 'SELECT') $(this).prop('disabled', true);\r\n      else $(this).prop('readonly', true);\r\n      const $s2 = $(this).next('.select2-container, .select2');\r\n      if ($s2.length) $s2.addClass('ph-disabled').css('pointer-events','none');\r\n    });\r\n    // Si quieres bloquear también el \"Seleccionar\", descomenta:\r\n    // qLookup(f,scope).addClass('ph-disabled').css('pointer-events','none')\r\n    //   .attr('aria-disabled','true').on('click._lock', e => { e.preventDefault(); e.stopImmediatePropagation(); return false; });\r\n  }\r\n  function doDisable(f, scope){\r\n    const $els = qCtrl(f,scope).addClass('ph-disabled');\r\n    $els.each(function(){\r\n      $(this).prop('disabled', true).prop('readonly', true);\r\n      const $s2 = $(this).next('.select2-container, .select2');\r\n      if ($s2.length) $s2.addClass('ph-disabled').css('pointer-events','none');\r\n    });\r\n    qLookup(f,scope).addClass('ph-disabled').css('pointer-events','none')\r\n      .attr('aria-disabled','true').on('click._lock', e => { e.preventDefault(); e.stopImmediatePropagation(); return false; });\r\n  }\r\n\r\n  function applyScope(scope){\r\n    enable.forEach(f=>doEnable(f,scope));\r\n    readonly.forEach(f=>doReadonly(f,scope));\r\n    disable.forEach(f=>doDisable(f,scope));\r\n  }\r\n\r\n  // ---- Espera activa a que existan los controles (rápida) ----\r\n  function waitFor(list, timeout=2000, scope){\r\n    const t0 = performance.now();\r\n    return new Promise(resolve=>{\r\n      (function tick(){\r\n        const ok = list.every(f => $(scope||document).find(`[id^=\"value_${f}_\"],[id^=\"display_value_${f}_\"]`).length);\r\n        if (ok || performance.now()-t0 > timeout) resolve();\r\n        else requestAnimationFrame(tick);\r\n      })();\r\n    });\r\n  }\r\n\r\n  // ---- Aplicación inicial (por si ya hay inline abierto) ----\r\n  applyScope(document);\r\n\r\n  // ---- Guardias: si alguien alcanza a tocar un control, lo bloqueamos al instante ----\r\n  const selInputs = ALL.map(f=>`[id^=\"value_${f}_\"],[id^=\"display_value_${f}_\"]`).join(',');\r\n  if (selInputs) {\r\n    $(document).on('focusin click', selInputs, function(){\r\n      const id = this.id||'';\r\n      const f = ALL.find(x => id.startsWith('value_'+x+'_') || id.startsWith('display_value_'+x+'_'));\r\n      if (!f) return;\r\n      if (disable.has(f))      doDisable(f, document);\r\n      else if (readonly.has(f))doReadonly(f, document);\r\n      else                     doEnable(f, document);\r\n    });\r\n  }\r\n  const selLookup = ALL.map(f=>`[id^=\"open_lookup_${f}_\"]`).join(',');\r\n  if (selLookup) {\r\n    $(document).on('click', selLookup, function(e){\r\n      const id = this.id||'';\r\n      const f = ALL.find(x => id.startsWith('open_lookup_'+x+'_'));\r\n      if (!f) return;\r\n      if (disable.has(f) || readonly.has(f)) {\r\n        e.preventDefault(); e.stopImmediatePropagation();\r\n        (disable.has(f) ? doDisable : doReadonly)(f, document);\r\n        return false;\r\n      }\r\n    });\r\n  }\r\n\r\n  // ---- Al pulsar \"Inline edit\" ----\r\n  $(document).on('click','[data-buttonevent=\"inlineEdit_start\"], [data-itemid=\"grid_inline_edit\"]', async function(){\r\n    await waitFor(ALL, 2500, document);\r\n    applyScope(document);\r\n  });\r\n\r\n  // ---- Observer: solo la grid (más rápido) ----\r\n  const grid = document.querySelector('.r-grid') || document.body;\r\n  new MutationObserver(async muts=>{\r\n    for (const m of muts) {\r\n      if (m.addedNodes && m.addedNodes.length) {\r\n        await waitFor(ALL, 2000, grid);\r\n        applyScope(grid);\r\n        break;\r\n      }\r\n    }\r\n  }).observe(grid, { childList:true, subtree:true });\r\n})();\r\n\r\n\r\n\r\n\r\n\r\nfunction redirigirReporte() {\r\n  var val2 = $(\"#edt_FechaIn\").val();\r\n  var val3 = $(\"#edt_FechaFn\").val();\r\n\r\n  \r\n  window.location.href = 'solicitudes_list.php?FechaIn=' + val2 +\r\n                           '&FechaFn=' + val3;\r\n}\r\n// Asignar evento a todos los campos\r\n$(\"#edt_FechaIn, #edt_FechaFn\")\r\n  .on(\"change\", redirigirReporte);\r\n\r\n\r\n\r\n/****************************************************************************************/\r\n// === FORZAR QUE ABRA edit1 SI EL ENLACE/FILA LO REQUIERE ===\r\n(function(){\r\n  var FORCE_PAGE = 'edit1';\r\n  var EDIT_BASE  = 'solicitudes_edit.php'; // fallback por si no hay href\r\n\r\n  function closestEditAnchor(el){\r\n    // Soporta los distintos “sabores” que genera PHPRunner\r\n    return el.closest('a.rnr-editlink, a[data-itemid=\"grid_edit\"], a[data-itemtype=\"grid_edit\"], a[href*=\"_edit.php\"], a[href*=\"_edit1.php\"], button[data-buttonevent=\"edit\"], .rnr-button.rnr-button-edit');\r\n  }\r\n\r\n  function readKeys($node){\r\n    // 1) del propio enlace\r\n    var raw = $node.attr('data-keys');\r\n    // 2) o del <tr data-keys=\"...\">\r\n    if (!raw) raw = $node.closest('tr').attr('data-keys');\r\n    if (!raw) return null;\r\n    try { return (typeof raw === 'string') ? JSON.parse(raw) : raw; } catch(_){ return null; }\r\n  }\r\n\r\n  function normalizeBase(href){\r\n    if (!href) return EDIT_BASE;\r\n    var base = href.split('?')[0]\r\n      .replace(/_edit1\\.php$/i,'_edit.php')\r\n      .replace(/(_edit\\.php).*/i,'$1');\r\n    // Si no quedó _edit.php, fuerza fallback\r\n    if (!/_edit\\.php$/i.test(base)) base = EDIT_BASE;\r\n    return base;\r\n  }\r\n\r\n  function buildUrl(href, pk, forcePage){\r\n    var base = normalizeBase(href);\r\n    var qs   = new URLSearchParams(href && href.indexOf('?')>-1 ? href.split('?')[1] : '');\r\n\r\n    // Conserva menuItemId si está en la URL actual\r\n    var curQS = new URLSearchParams(window.location.search);\r\n    if (!qs.get('menuItemId') && curQS.get('menuItemId')) {\r\n      qs.set('menuItemId', curQS.get('menuItemId'));\r\n    }\r\n\r\n    // Forzar página y PK\r\n    qs.set('page', forcePage);\r\n    if (pk) qs.set('editid1', pk);\r\n\r\n    return base + '?' + qs.toString();\r\n  }\r\n\r\n  function forceEdit1(ev){\r\n    var target = closestEditAnchor(ev.target);\r\n    if (!target) return; // no es un botón/enlace de editar\r\n\r\n    // ¿Debemos forzar? Si el PHP te pone data-page=\"edit1\", respétalo.\r\n    var $t = $(target);\r\n    var dataPage = ($t.attr('data-page')||'').toLowerCase();\r\n\r\n    // Si explícitamente dice 'edit', no tocamos ese.\r\n    if (dataPage === 'edit') return;\r\n\r\n    // Si no trae nada, puedes elegir forzar TODO o solo los marcados:\r\n    // - Forzar solo los marcados: si no hay data-page, salimos.\r\n    // if (!dataPage) return;\r\n    // - Forzar TODOS los botones de editar a edit1: descomenta la línea siguiente:\r\n    // dataPage = dataPage || 'edit1';\r\n\r\n    // Si no hay nada que forzar, sal.\r\n    if (dataPage !== 'edit1') return;\r\n\r\n    ev.preventDefault();\r\n    ev.stopPropagation();\r\n    ev.stopImmediatePropagation();\r\n\r\n    // HREF de origen\r\n    var href = $t.attr('data-href') || $t.attr('href') || '';\r\n\r\n    // PK desde data-keys del enlace o del <tr>\r\n    var keys = readKeys($t) || {};\r\n    var pk = keys.idsolicitud || keys.IDSOLICITUD || keys.IdSolicitud || keys.id || null;\r\n\r\n    // Construir URL final y navegar\r\n    var url = buildUrl(href, pk, FORCE_PAGE);\r\n    window.location.assign(url);\r\n  }\r\n\r\n  // 1) Captura (gana prioridad sobre el delegado de PHPRunner)\r\n  document.addEventListener('click', forceEdit1, true);\r\n  // 2) Respaldo en burbujeo (por si acaso)\r\n  $(document).on('click', 'a.rnr-editlink, [data-itemid=\"grid_edit\"] a, [data-itemtype=\"grid_edit\"] a, button[data-buttonevent=\"edit\"], .rnr-button.rnr-button-edit', forceEdit1);\r\n})();\r\n\r\n\r\n\r\n\r\n"
		},
		{
			"eventId": "EVENT_JS_ONLOAD",
			"pageType": "edit",
			"code": "// ====================== CONFIG / GLOBALS (EDIT) ======================\r\nwindow.ENDPOINT = 'serial_reserve.php';\r\n\r\n// Campos que quieres autoguardar\r\nwindow.EDIT_FIELDS = [\r\n  'idcliente','idproducto','idplan','orden','plazo','rfc','idcli',\r\n  'estado','ciudad','colonia','calle','numeroext','numeroint','noserie'\r\n];\r\n\r\n// Contexto del servidor (inyectado en BeforeShowEdit)\r\nvar EDIT_CTX = (pageObj.getProxy && pageObj.getProxy().edit_ctx) || {};\r\nvar EDIT_ID  = EDIT_CTX.idsolicitud || '';\r\nvar CURR_SERIE_DB = EDIT_CTX.noserie_actual || '';\r\n\r\n// Llave de autosave **por registro**\r\nwindow.EDIT_STORAGE_KEY = 'solicitud_vnp_edit_draft_' + EDIT_ID;\r\n\r\n// Banderas\r\nwindow.__edit_recovering = false;\r\nwindow.__edit_submitting = false;\r\nwindow.__res_noserie     = null;   // reserva en curso del usuario (si cambia producto)\r\nwindow.EDIT_SKIP_RECOVERY = window.EDIT_SKIP_RECOVERY || false;\r\n\r\n\r\n  var px = (pageObj.getProxy && pageObj.getProxy()) || {};\r\n\r\n  // 1) Mensaje que viene de PHP en BeforeShowEdit (para popup)\r\n  if (px.popup_msg && px.popup_msg.text) {\r\n    var t = (px.popup_msg.type === 'success') ? 'success' : 'error';\r\n    if (Runner && Runner.displayPopupMessage) {\r\n      Runner.displayPopupMessage(px.popup_msg.text, t);\r\n    } else {\r\n      alert(px.popup_msg.text);\r\n    }\r\n  }\r\n\r\n  // 2) Mensajes que regresan en la respuesta AJAX de Guardar\r\n  pageObj.on('afterSave', function(resp){\r\n    if (!resp) return;\r\n    if (resp.success === false && resp.message) {\r\n      if (Runner && Runner.displayPopupMessage) {\r\n        Runner.displayPopupMessage(resp.message, 'error');\r\n      } else {\r\n        alert(resp.message);\r\n      }\r\n    } else if (resp.success && resp.message) {\r\n      if (Runner && Runner.displayPopupMessage) {\r\n        Runner.displayPopupMessage(resp.message, 'success');\r\n      }\r\n    }\r\n  });\r\n\r\n\r\n/************************************************************************************************************************************/\r\n// Hover-accordion para Bootstrap/PHPRunner usando .panel-collapse (con histeresis)\r\n/*(function () {\r\n  var $ = window.jQuery || window.$;\r\n  if (!$) { console.error('[hover-accordion] falta jQuery'); return; }\r\n\r\n  // ===== tiempos (ajusta al gusto) =====\r\n  var OPEN_DELAY     = 120; // espera antes de abrir\r\n  var CLOSE_DELAY    = 500; // espera antes de cerrar al salir\r\n  var BETWEEN_GRACE  = 220; // gracia para cerrar \"las otras\" después de abrir la actual\r\n\r\n  // ===== duraciones / ritmo =====\r\n  var CLOSE_ANIM_MS  = 400; // <-- te faltaba esta constante\r\n  var V_PX_PER_S     = 320; // “velocidad” de apertura (px por segundo)\r\n  var OPEN_MIN       = 380; // ms mínimo al abrir\r\n  var OPEN_MAX       = 900; // ms máximo al abrir\r\n\r\n  var $sections = $('div.panel.panel-default.form-section');\r\n\r\n  // Cierra todas al inicio (colapsa correctamente el contenedor .panel-collapse)\r\n  $sections.children('.panel-collapse').each(function(){\r\n    $(this).removeClass('in show').hide().attr('aria-expanded','false');\r\n  });\r\n  $sections.find('.panel-heading').attr('aria-expanded','false');\r\n\r\n  function closeSection($sec){\r\n    var $col = $sec.children('.panel-collapse');\r\n    $col.addClass('no-bs-trans')\r\n        .css('overflow','hidden')\r\n        .stop(true, false)\r\n        .slideUp(CLOSE_ANIM_MS, 'swing')\r\n        .removeClass('in show')\r\n        .attr('aria-expanded','false')\r\n        .queue(function(next){ $(this).removeClass('no-bs-trans'); next(); });\r\n    $sec.find('.panel-heading').attr('aria-expanded','false');\r\n  }\r\n\r\n  // Abrir primero la target; cerrar las otras después de una pequeña gracia\r\n  function openOnlyWithGrace($target){\r\n    var $col = $target.children('.panel-collapse');\r\n\r\n    // Medir altura natural para duración proporcional (ritmo constante)\r\n    var wasHidden = $col.is(':hidden');\r\n    if (wasHidden) $col.show();\r\n    var h = $col[0].scrollHeight || $col.height();\r\n    if (wasHidden) $col.hide();\r\n\r\n    var duration = Math.max(OPEN_MIN, Math.min(OPEN_MAX, Math.round(h / V_PX_PER_S * 1000)));\r\n\r\n    $col.addClass('no-bs-trans')\r\n        .css('overflow','hidden')\r\n        .stop(true, false)\r\n        .slideDown(duration, 'swing')\r\n        .addClass('in show')\r\n        .attr('aria-expanded','true')\r\n        .queue(function(next){ $(this).removeClass('no-bs-trans'); next(); });\r\n\r\n    $target.find('.panel-heading').attr('aria-expanded','true');\r\n\r\n    // Cierra las demás con pequeña gracia para evitar “saltos”\r\n    setTimeout(function(){\r\n      $sections.not($target).each(function(){ closeSection($(this)); });\r\n    }, BETWEEN_GRACE);\r\n  }\r\n\r\n  $sections.each(function(){\r\n    var $sec  = $(this);\r\n    var $head = $sec.children('.panel-heading');\r\n    var $col  = $sec.children('.panel-collapse');\r\n    if (!$head.length || !$col.length) return;\r\n\r\n    // Evita que el toggler nativo por click interfiera\r\n    $head.on('click', '[data-toggle=\"collapse\"], a[href^=\"#\"]', function(e){\r\n      e.preventDefault(); e.stopPropagation();\r\n    });\r\n\r\n    var openT=null, closeT=null;\r\n\r\n    // Abre SOLO la actual al entrar al header (primero abrir, luego cerrar otras)\r\n    $head.on('mouseenter', function(){\r\n      clearTimeout(closeT);\r\n      clearTimeout(openT);\r\n      openT = setTimeout(function(){ openOnlyWithGrace($sec); }, OPEN_DELAY);\r\n    });\r\n\r\n    // No cierres si el mouse entra al contenido\r\n    $col.on('mouseenter', function(){ clearTimeout(closeT); });\r\n\r\n    // Cierra al salir de TODA la sección (header + collapse) con retardo generoso\r\n    $sec.on('mouseleave', function(){\r\n      clearTimeout(openT);\r\n      clearTimeout(closeT);\r\n      closeT = setTimeout(function(){\r\n        if ($sec.find(':focus').length) return; // no cerrar si hay foco en un input\r\n        closeSection($sec);\r\n      }, CLOSE_DELAY);\r\n    });\r\n  }); // <-- cerraba faltante del each\r\n\r\n})(); // <-- cerraba faltante del IIFE\r\n*/\r\n\r\n/************************************************************************************************/\r\n//anexado desde Add\r\n\r\n// --- Guardas para modales ---\r\nvar isModalOpen = false;\r\nvar guardUntil  = 0;  // ventana corta de “gracia” tras el click que abre modal\r\n\r\n// PHPRunner/Bootstrap suelen usar estas clases/selectores\r\nvar MODAL_SELECTOR = '.modal, .runner-modal, .rnr-modal';\r\n\r\n// Bootstrap agrega la clase .modal-open al <body> cuando hay un modal\r\nfunction modalIsOpen() {\r\n  return isModalOpen ||\r\n         document.body.classList.contains('modal-open') ||\r\n         $(MODAL_SELECTOR + ':visible').length > 0;\r\n}\r\n\r\n// Al abrir/cerrar cualquier modal, ajusta el flag\r\n$(document).on('show.bs.modal', MODAL_SELECTOR, function(){ isModalOpen = true; });\r\n$(document).on('hidden.bs.modal', MODAL_SELECTOR, function(){ \r\n  isModalOpen = false; \r\n  // al cerrar modal, reanuda el comportamiento normal\r\n});\r\n\r\n// Si tu catálogo abre modal por click en botones/enlaces:\r\n$(document).on('click', '[data-toggle=\"modal\"], .open-modal, .lookup-btn, .bsPopupLink', function(){\r\n  // da ~1.2s de gracia para que no se cierre la sección por el mouseleave inmediato\r\n  guardUntil = Date.now() + 1200;\r\n});\r\n\r\n\r\n/***************************************************************************/\r\n//Poner los cuadros de texto en mayúsculas\r\ndocument.querySelectorAll('input[type=\"text\"]').forEach(input => {\r\n    input.addEventListener('input', () => {\r\n        input.value = input.value.toUpperCase();\r\n    });\r\n});\r\n\r\n\r\n\r\n\r\n/************************************************************************************************************************************/\r\n// Hover-accordion para Bootstrap/PHPRunner usando .panel-collapse (con histeresis)\r\n(function () {\r\n  var $ = window.jQuery || window.$;\r\n  if (!$) { console.error('[hover-accordion] falta jQuery'); return; }\r\n\r\n\r\n  \r\n  \r\n    // ===== tiempos (ajusta al gusto) =====\r\n  var OPEN_DELAY     = 400; // espera antes de abrir\r\n  var CLOSE_DELAY    = 1000; // espera antes de cerrar al salir\r\n  var BETWEEN_GRACE  = 320; // gracia para cerrar \"las otras\" después de abrir la actual\r\n\r\n  // ===== duraciones / ritmo =====\r\n  var CLOSE_ANIM_MS  = 400; // <-- te faltaba esta constante\r\n  var V_PX_PER_S     = 320; // “velocidad” de apertura (px por segundo)\r\n  var OPEN_MIN       = 380; // ms mínimo al abrir\r\n  var OPEN_MAX       = 900; // ms máximo al abrir\r\n  \r\n  \r\n\r\n  var $sections = $('div.panel.panel-default.form-section');\r\n\r\n  // Cierra todas al inicio (colapsa correctamente el contenedor .panel-collapse)\r\n  $sections.children('.panel-collapse').each(function(){\r\n    $(this).removeClass('in show').hide().attr('aria-expanded','false');\r\n  });\r\n  $sections.find('.panel-heading').attr('aria-expanded','false');\r\n\r\n  function closeSection($sec){\r\n        if (modalIsOpen() || Date.now() < guardUntil) return; // <<--- evita cerrar si hay modal\r\n    var $col = $sec.children('.panel-collapse');\r\n    $col.addClass('no-bs-trans')\r\n        .css('overflow','hidden')\r\n        .stop(true, false)\r\n        .slideUp(CLOSE_ANIM_MS, 'swing')\r\n        .removeClass('in show')\r\n        .attr('aria-expanded','false')\r\n        .queue(function(next){ $(this).removeClass('no-bs-trans'); next(); });\r\n    $sec.find('.panel-heading').attr('aria-expanded','false');\r\n  }\r\n\r\n  // Abrir primero la target; cerrar las otras después de una pequeña gracia\r\n  function openOnlyWithGrace($target){\r\n    var $col = $target.children('.panel-collapse');\r\n\r\n    // Medir altura natural para duración proporcional (ritmo constante)\r\n    var wasHidden = $col.is(':hidden');\r\n    if (wasHidden) $col.show();\r\n    var h = $col[0].scrollHeight || $col.height();\r\n    if (wasHidden) $col.hide();\r\n\r\n    var duration = Math.max(OPEN_MIN, Math.min(OPEN_MAX, Math.round(h / V_PX_PER_S * 1000)));\r\n\r\n    $col.addClass('no-bs-trans')\r\n        .css('overflow','hidden')\r\n        .stop(true, false)\r\n        .slideDown(duration, 'swing')\r\n        .addClass('in show')\r\n        .attr('aria-expanded','true')\r\n        .queue(function(next){ $(this).removeClass('no-bs-trans'); next(); });\r\n\r\n    $target.find('.panel-heading').attr('aria-expanded','true');\r\n\r\n    // Cierra las demás con pequeña gracia para evitar “saltos”\r\n    setTimeout(function(){\r\n      $sections.not($target).each(function(){ closeSection($(this)); });\r\n    }, BETWEEN_GRACE);\r\n  }\r\n\r\n  $sections.each(function(){\r\n    var $sec  = $(this);\r\n    var $head = $sec.children('.panel-heading');\r\n    var $col  = $sec.children('.panel-collapse');\r\n    if (!$head.length || !$col.length) return;\r\n\r\n    // Evita que el toggler nativo por click interfiera\r\n    $head.on('click', '[data-toggle=\"collapse\"], a[href^=\"#\"]', function(e){\r\n      e.preventDefault(); e.stopPropagation();\r\n    });\r\n\r\n    var openT=null, closeT=null;\r\n\r\n    // Abre SOLO la actual al entrar al header (primero abrir, luego cerrar otras)\r\n    $head.on('mouseenter', function(){\r\n      clearTimeout(closeT);\r\n      clearTimeout(openT);\r\n      openT = setTimeout(function(){ openOnlyWithGrace($sec); }, OPEN_DELAY);\r\n    });\r\n\r\n    // No cierres si el mouse entra al contenido\r\n    $col.on('mouseenter', function(){ clearTimeout(closeT); });\r\n\r\n    // Cierra al salir de TODA la sección (header + collapse) con retardo generoso\r\n        $sec.on('mouseleave', function(){\r\n          clearTimeout(openT);\r\n          clearTimeout(closeT);\r\n        \r\n          // si hay modal abierto (o está a punto de abrirse), NO cierres\r\n          if (modalIsOpen() || Date.now() < guardUntil) return;\r\n        \r\n          closeT = setTimeout(function(){\r\n            if (modalIsOpen() || Date.now() < guardUntil) return; // chequea otra vez al ejecutar\r\n            if ($sec.find(':focus').length) return; // no cerrar si están escribiendo\r\n            closeSection($sec);\r\n          }, CLOSE_DELAY);\r\n        });\r\n\r\n  }); // <-- cerraba faltante del each\r\n\r\n})(); // <-- cerraba faltante del IIFE\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n// ====================== HELPERS ======================\r\nfunction currentPageId() {\r\n  if (typeof window.pageid !== 'undefined' && window.pageid) return window.pageid;\r\n  var pid = $('[data-pageid]').first().attr('data-pageid');\r\n  return pid || '';\r\n}\r\nfunction getCtrl(field) {\r\n  try { return Runner.getControl(currentPageId(), field); } catch(e) { return null; }\r\n}\r\nfunction readVal(field) {\r\n  var c = getCtrl(field);\r\n  if (c && typeof c.getValue === 'function') return c.getValue();\r\n  var pid = currentPageId();\r\n  var $id = $('#value_'+field+'_'+pid);\r\n  if ($id.length) return $id.val();\r\n  var $w = $('div.r-integrated-field[data-field=\"'+field+'\"][data-pageid=\"'+pid+'\"]');\r\n  if ($w.length) {\r\n    var $inp = $w.find('input,select,textarea').first();\r\n    if ($inp.length) return $inp.val();\r\n  }\r\n  var $n = $('[name=\"'+field+'\"]');\r\n  if ($n.length) return $n.val();\r\n  return '';\r\n}\r\nfunction setVal(field, value, fireChange) {\r\n  var c = getCtrl(field);\r\n  if (c && typeof c.setControlValue === 'function') {\r\n    c.setControlValue(value);\r\n    if (fireChange && typeof c.fireEvent === 'function') c.fireEvent('change');\r\n    return true;\r\n  }\r\n  var pid = currentPageId();\r\n  var $id = $('#value_'+field+'_'+pid);\r\n  if ($id.length) {\r\n    $id.val(value).trigger('change');\r\n    if (fireChange) $id.trigger('keyup');\r\n    return true;\r\n  }\r\n  var $w = $('div.r-integrated-field[data-field=\"'+field+'\"][data-pageid=\"'+pid+'\"]');\r\n  if ($w.length) {\r\n    var $inp = $w.find('input,select,textarea').first();\r\n    if ($inp.length) {\r\n      $inp.val(value).trigger('change');\r\n      if (fireChange) $inp.trigger('keyup');\r\n      return true;\r\n    }\r\n  }\r\n  return false;\r\n}\r\nfunction setNoSerieValue(noserie) {\r\n  var ok = setVal('noserie', noserie, true);\r\n  if (ok) return;\r\n  var tries = 0, max = 40, delay = 150;\r\n  (function retry(){\r\n    tries++;\r\n    if (setVal('noserie', noserie, true)) return;\r\n    if (tries >= max) return;\r\n    setTimeout(retry, delay);\r\n  })();\r\n}\r\nfunction getQS(name){\r\n  var m = new RegExp('[?&]'+name+'=([^&]*)').exec(location.search);\r\n  return m ? decodeURIComponent(m[1].replace(/\\+/g,' ')) : null;\r\n}\r\nfunction hasErrorMessage() {\r\n  var $msg = $('[data-itemtype=\"edit_message\"].alert, .alert[data-itemtype=\"edit_message\"]');\r\n  if (!$msg.length) return false;\r\n  var txt = $.trim($msg.text() || '');\r\n  if (!txt) return false;\r\n  return $msg.is('.alert-danger, .alert-error') || true;\r\n}\r\n\r\n// ====================== AUTOSAVE (por registro) ======================\r\nfunction buildEditDraft() {\r\n  var d = {};\r\n  (window.EDIT_FIELDS || []).forEach(function(f){\r\n    var v = readVal(f);\r\n    if (v !== null && v !== undefined && v !== '') d[f] = v;\r\n  });\r\n  d.timestamp = Date.now();\r\n  return d;\r\n}\r\nfunction saveEditDraftNow(){\r\n  try{ sessionStorage.setItem(window.EDIT_STORAGE_KEY, JSON.stringify(buildEditDraft())); }catch(e){}\r\n}\r\nfunction debounce(fn, ms){ var t=0; return function(){ var a=arguments,s=this; if(t){try{clearTimeout(t);}catch(e){}} t=setTimeout(function(){ t=0; try{fn.apply(s,a);}catch(e){} }, ms||200); }; }\r\nvar saveDraftDebounced = debounce(saveEditDraftNow, 300);\r\n\r\n// ====================== Reserva por producto (EDIT) ======================\r\nfunction releasePrev(){\r\n  if (!window.__res_noserie) return;\r\n  $.post(window.ENDPOINT, { action:'release', noserie: window.__res_noserie }, function(){}, 'json');\r\n  window.__res_noserie = null;\r\n}\r\nfunction reserveForProduct(productId){\r\n  $.post(window.ENDPOINT, { action:'reserve_by_product', product_id: productId }, null, 'json')\r\n    .done(function(resp){\r\n      var r = (typeof resp === 'object') ? resp : (function(){ try{return JSON.parse(resp);}catch(e){return {};}})();\r\n      if (r && r.ok) {\r\n        setNoSerieValue(r.noserie);\r\n        window.__res_noserie = r.noserie;\r\n        saveEditDraftNow();\r\n      } else if (r && r.error === 'no-stock') {\r\n        alert('No hay series disponibles para este producto.');\r\n        setVal('idproducto','',true);\r\n        setNoSerieValue('');\r\n        releasePrev();\r\n        saveEditDraftNow();\r\n      } else {\r\n        alert('No se pudo reservar la serie. Intenta de nuevo.');\r\n        setNoSerieValue('');\r\n        saveEditDraftNow();\r\n      }\r\n    })\r\n    .fail(function(){\r\n      alert('Error de comunicación al reservar la serie.');\r\n      setNoSerieValue('');\r\n      saveEditDraftNow();\r\n    });\r\n}\r\n\r\n// ====================== Inicio diferido ======================\r\nsetTimeout(function(){\r\n  var pid      = currentPageId();\r\n  var ctrlProd = getCtrl('idproducto');\r\n  if (!ctrlProd) return;\r\n\r\n  // 0) Marcar submit (para no limpiar al salir si es guardado)\r\n  $(document).on('submit', 'form', function(){\r\n    window.__edit_submitting = true;\r\n    saveEditDraftNow();\r\n  });\r\n  var SAVE_SELECTOR = \"[data-itemtype='edit_save'] a, [data-itemid='edit_save'] a, a#saveButton1, button#saveButton1\";\r\n  $(document).on('click', SAVE_SELECTOR, function(){\r\n    window.__edit_submitting = true;\r\n    saveEditDraftNow();\r\n  });\r\n\r\n  // 1) Modo limpieza tras éxito o entrada limpia\r\n  var cleanMode = !!(window.EDIT_CLEAN_ON_LOAD) || (getQS('clean') === '1') || !!window.EDIT_SKIP_RECOVERY;\r\n  if (cleanMode) {\r\n    try{ sessionStorage.removeItem(window.EDIT_STORAGE_KEY); }catch(e){}\r\n    // En EDIT **no** se “blanquea” el formulario: se deja el estado del servidor.\r\n    // Sólo desactivamos la recuperación.\r\n  } else {\r\n    // 2) Recuperación desde sessionStorage si hubo error\r\n    var draftJson = sessionStorage.getItem(window.EDIT_STORAGE_KEY);\r\n    if (draftJson && !hasErrorMessage()) {\r\n      try {\r\n        var d = JSON.parse(draftJson)||{};\r\n        var now = Date.now();\r\n        // 2 horas por consistencia\r\n        if (d.timestamp && (now - d.timestamp > 2*60*60*1000)) {\r\n          sessionStorage.removeItem(window.EDIT_STORAGE_KEY);\r\n        } else {\r\n          window.__edit_recovering = true;\r\n          // Producto primero\r\n          if (d.idproducto != null && d.idproducto !== '') {\r\n            setVal('idproducto', d.idproducto, true);\r\n          }\r\n          // Resto\r\n          Object.keys(d).forEach(function(k){\r\n            if (k==='timestamp' || k==='idproducto') return;\r\n            setVal(k, d[k], false);\r\n          });\r\n          // Si había una serie en el draft, tómala como “visual”\r\n          if (d.noserie) window.__res_noserie = d.noserie;\r\n\r\n          sessionStorage.removeItem(window.EDIT_STORAGE_KEY);\r\n          setTimeout(function(){ window.__edit_recovering=false; }, 150);\r\n        }\r\n      } catch(e) {\r\n        sessionStorage.removeItem(window.EDIT_STORAGE_KEY);\r\n      }\r\n    } else if (hasErrorMessage()) {\r\n      // si el servidor ya reinyectó valores en HTML, no hagas nada.\r\n      // (tu BeforeShowEdit ya los puso por proxy)\r\n    }\r\n  }\r\n\r\n  // 3) Cambio de producto → reservar serie (comparando con la serie actual de DB)\r\n  ctrlProd.on('change', function(){\r\n    var productId = ctrlProd.getValue();\r\n    if (!productId) return;\r\n    if (window.__edit_recovering) return;\r\n\r\n    // Si ya había serie reservada en esta sesión, suéltala\r\n    releasePrev();\r\n\r\n    // Limpia el campo noserie en UI (no editable, pero visible)\r\n    setNoSerieValue('');\r\n\r\n    // Si el usuario no cambió efectivamente la serie (p.ej. regresa al mismo producto),\r\n    // no impide reservar; el endpoint decidirá la primera libre.\r\n    reserveForProduct(productId);\r\n  });\r\n\r\n  // 4) Autosave periódico y por cambio\r\n  setInterval(function(){ if(!window.__edit_recovering) saveEditDraftNow(); }, 5000);\r\n\r\n  var selDeleg = (window.EDIT_FIELDS || []).map(function(f){\r\n    return 'div.r-integrated-field[data-field=\"'+f+'\"][data-pageid=\"'+pid+'\"] input, '+\r\n           'div.r-integrated-field[data-field=\"'+f+'\"][data-pageid=\"'+pid+'\"] select, '+\r\n           'div.r-integrated-field[data-field=\"'+f+'\"][data-pageid=\"'+pid+'\"] textarea';\r\n  }).join(', ');\r\n  $(document).on('change input', selDeleg, saveDraftDebounced);\r\n\r\n  // 5) Salidas (volver/cerrar) → liberar reserva y limpiar draft\r\n  (function(){\r\n    var BACK_SELECTOR = [\r\n      '#backButton1',\r\n      '#backButton2',\r\n      \"[data-itemtype='edit_back_list'] a\",\r\n      \"[data-itemid='edit_back_list'] a\",\r\n      \"[data-itemtype='edit_close'] a\",\r\n      \"[data-itemid='edit_close'] a\",\r\n      \"a[href$='solicitudes_list.php']\",\r\n      \"a[href*='solicitudes_list.php?']\"\r\n    ].join(', ');\r\n    function safeReleaseAndClear(){\r\n      try{\r\n        if (window.__res_noserie) {\r\n          navigator.sendBeacon(window.ENDPOINT, new URLSearchParams({action:'release', noserie: window.__res_noserie}));\r\n          window.__res_noserie = null;\r\n        }\r\n        sessionStorage.removeItem(window.EDIT_STORAGE_KEY);\r\n      }catch(e){}\r\n      safeReleaseAndClear();\r\n    }\r\n    $(document).on('mousedown click', BACK_SELECTOR, function(){\r\n      window.__edit_submitting = false;\r\n    });\r\n\r\n    window.addEventListener('pagehide', function(){\r\n      if (!window.__edit_submitting) {\r\n        try{\r\n          if (window.__res_noserie) {\r\n            navigator.sendBeacon(window.ENDPOINT, new URLSearchParams({action:'release', noserie: window.__res_noserie}));\r\n            window.__res_noserie = null;\r\n          }\r\n          sessionStorage.removeItem(window.EDIT_STORAGE_KEY);\r\n        }catch(e){}\r\n      }\r\n    });\r\n    window.addEventListener('beforeunload', function(){\r\n      if (!window.__edit_submitting && window.__res_noserie) {\r\n        try{\r\n          navigator.sendBeacon(window.ENDPOINT, new URLSearchParams({action:'release', noserie: window.__res_noserie}));\r\n        }catch(e){}\r\n      }\r\n    });\r\n  })();\r\n\r\n}, 500);\r\n\r\n// --- Mensajería universal desde PHP (BeforeShow* -> setProxyValue(\"popup_msg\",{text,type})) ---\r\n(function () {\r\n  // Espera a que PHPRunner haya inicializado los controles/proxy\r\n  var start = function () {\r\n    try {\r\n      var proxy = (pageObj.getProxy && pageObj.getProxy()) || {};\r\n      var pm = proxy.popup_msg || null;\r\n      if (!pm || !pm.text) return; // no hay mensaje que mostrar\r\n\r\n      // Normaliza tipo -> clase Bootstrap\r\n      var t = (pm.type || 'info').toLowerCase();\r\n      var bs =\r\n        t === 'success' ? 'success' :\r\n        t === 'error'   ? 'danger'  :\r\n        t === 'warning' ? 'warning' : 'info';\r\n\r\n      // Crea el alert\r\n      var $alert = $('<div/>', {\r\n        'class': 'alert alert-' + bs,\r\n        css: { margin: '8px 8px 12px 8px' }\r\n      }).text(pm.text);\r\n\r\n      // ¿Estamos en popup?\r\n      var $modalBody = $('.modal-body:visible').first();\r\n\r\n      if ($modalBody.length) {\r\n        // POPUP: intenta usar el contenedor de mensaje si existe, si no, prepend\r\n        var $holder = $modalBody.find('[data-itemtype=\"edit_message\"]').first();\r\n        if ($holder.length) {\r\n          $holder.empty().append($alert).show();\r\n          // Asegura que el bloque de mensaje esté visible si el template lo oculta\r\n          $holder.closest('.r-message, .row, div').show();\r\n        } else {\r\n          $modalBody.prepend($alert);\r\n        }\r\n      } else {\r\n        // NO POPUP: usa el bloque de mensaje estándar si existe\r\n        var $std = $('[data-itemtype=\"edit_message\"]').first();\r\n        if ($std.length) {\r\n          $std.empty().append($alert).show();\r\n          $std.closest('.r-message, .row, div').show();\r\n        } else {\r\n          // Fallback: inserta arriba del contenedor de la página\r\n          var pid = (typeof pageid !== 'undefined' && pageid) ? pageid : ($('[data-pageid]').first().attr('data-pageid') || '');\r\n          var $wrap = pid ? $('[data-pageid=\"'+pid+'\"]').first() : $('body');\r\n          $wrap.prepend($alert);\r\n        }\r\n      }\r\n\r\n      // Auto-ocultar (opcional). Cambia 0 para dejarlo fijo.\r\n      var AUTO_HIDE_MS = 6000;\r\n      if (AUTO_HIDE_MS > 0) {\r\n        setTimeout(function(){ $alert.fadeOut(400, function(){ $(this).remove(); }); }, AUTO_HIDE_MS);\r\n      }\r\n    } catch (e) {\r\n      // Silencioso: no romper tu onload si algo falla\r\n      if (window.console && console.warn) console.warn('msg bridge error:', e);\r\n    }\r\n  };\r\n\r\n  // Ejecuta cuando la página esté lista para asegurar contenedores\r\n  if (pageObj && pageObj.on) {\r\n    pageObj.on('afterInit', start);   // PHPRunner hook\r\n  } else {\r\n    // Fallback por si no existe el hook en esta página\r\n    $(start);\r\n  }\r\n})();\r\n\r\n\r\n/***********************************************************************************************************/\r\n\r\n(function () {\r\n  // ===== Helpers =====\r\n  function injectCSSOnce(id, css){\r\n    if (document.getElementById(id)) return;\r\n    var s = document.createElement('style'); s.id = id; s.textContent = css;\r\n    document.head.appendChild(s);\r\n  }\r\n  function debounce(fn, ms){ var t=null; return function(){ clearTimeout(t); var a=arguments,th=this; t=setTimeout(function(){fn.apply(th,a);}, ms||120); }; }\r\n\r\n  // ===== Fondo opcional =====\r\n  injectCSSOnce('ph-bg-soft', 'body{background:linear-gradient(135deg,#eef5ff,#f7f2ff)}');\r\n\r\n  // ===== CSS persistente (no se pierde al reconstruir la tabla) =====\r\n  injectCSSOnce('ph-logvnp-css', [\r\n    /* Card sobre el contenedor del detalle */\r\n    '.ph-logvnp-card{background:#fff;border-radius:16px;border:1px solid #e5e7eb;',\r\n    ' box-shadow:0 10px 25px -5px rgba(0,0,0,.1),0 10px 10px -5px rgba(0,0,0,.04);',\r\n    ' overflow:visible!important; position:relative;}',\r\n    /* Degradado al thead del grid dentro del contenedor */\r\n    '.ph-logvnp-card .rnr-gridtable thead tr,',\r\n    '.ph-logvnp-card table.table thead tr{background:linear-gradient(90deg,#7c3aed,#ec4899)}',\r\n    '.ph-logvnp-card .rnr-gridtable thead th,',\r\n    '.ph-logvnp-card table.table thead th{background:transparent!important;color:#fff!important;border:none!important}',\r\n    '.ph-logvnp-card .rnr-gridtable thead th:first-child,',\r\n    '.ph-logvnp-card table.table thead th:first-child{border-top-left-radius:12px}',\r\n    '.ph-logvnp-card .rnr-gridtable thead th:last-child,',\r\n    '.ph-logvnp-card table.table thead th:last-child{border-top-right-radius:12px}',\r\n    /* Toggle */\r\n    '.ph-toggle{width:34px;height:34px;border-radius:999px;color:#fff;display:inline-flex;align-items:center;justify-content:center;',\r\n    ' font-weight:700;border:none;outline:none;transition:transform .2s cubic-bezier(.4,0,.2,1),box-shadow .2s;box-shadow:0 6px 12px rgba(0,0,0,.12)}',\r\n    '.ph-toggle:hover{transform:scale(1.08)}',\r\n    '.ph-toggle.on{background:#10b981}.ph-toggle.off{background:#d1d5db;color:#111}'\r\n  ].join(''));\r\n\r\n  // ===== Localiza el contenedor del detalle por su título “Logisticavnp” =====\r\n  function findContainers(){\r\n    var arr = [];\r\n    $('.bs-details .panel.panel-info.details-grid').each(function(){\r\n      var $panel = $(this);\r\n      var $title = $panel.find('.panel-heading .panel-title');\r\n      if ($title.length && /logisticavnp|logisticavpn/i.test($title.text())) {\r\n        arr.push($panel);\r\n      }\r\n    });\r\n    // fallback por data-table si existiera:\r\n    $('[data-table=\"logisticavnp\"]').each(function(){\r\n      var $p = $(this).closest('.panel,.bs-details,.rnr-b-grid,.rnr-grid-block');\r\n      if ($p.length && !arr.some(x=>x.get(0)===$p.get(0))) arr.push($p);\r\n    });\r\n    return arr;\r\n  }\r\n\r\n  // ===== Skins + toggles (idempotente) sobre UN contenedor =====\r\n  function skinOne($panel){\r\n    if (!$panel || !$panel.length) return;\r\n\r\n    // Card al contenedor\r\n    $panel.addClass('ph-logvnp-card').css({overflow:'visible', position:'relative'});\r\n\r\n    // Botón “Añadir nuevo” visible encima, sin tocar handlers nativos\r\n    $panel.find('[data-buttonevent=\"inlineadd\"], #inlineAdd2').css({position:'relative', zIndex:5});\r\n\r\n    // Emojis de encabezado (una vez por tabla)\r\n    var $grid = $panel.find('.rnr-gridtable, table.table').first();\r\n    if ($grid.length && !$grid.data('ph-head-labeled')) {\r\n      $grid.find('thead th').each(function(){\r\n        var t = $(this).text().trim().toLowerCase();\r\n        if(t.includes('fech')) $(this).html('📅 Fecha');\r\n        else if(t.includes('sim')) $(this).html('📱 SIM Entregado');\r\n        else if(t.includes('equipo')) $(this).html('📦 Equipo Entregado');\r\n        else if(t.includes('check')) $(this).html('📋 Checklist Entregado');\r\n        else if(t.includes('carta')) $(this).html('📄 Carta Bienvenida');\r\n      });\r\n      $grid.data('ph-head-labeled',1);\r\n    }\r\n\r\n    // Toggles: procesa TODOS los checkboxes de los campos destino\r\n    ['equipoEntregado','checklistEntregado','cartaBienvenida'].forEach(function(field){\r\n      $panel.find('[id^=\"value_'+field+'_\"][type=\"checkbox\"]').each(function(){\r\n        var $real = $(this);\r\n        if ($real.data('ph-tgl')===1) return;  // ya hecho\r\n        $real.data('ph-tgl',1).css({position:'absolute', left:'-9999px'});\r\n        var on  = $real.prop('checked');\r\n        var ico = field==='equipoEntregado' ? '📦' :\r\n                  field==='checklistEntregado' ? '📋' : '📄';\r\n        var $btn = $('<button type=\"button\" class=\"ph-toggle\"></button>')\r\n                    .addClass(on?'on':'off')\r\n                    .text(on?'✓':ico)\r\n                    .insertAfter($real);\r\n        $btn.on('click', function(e){\r\n          e.preventDefault(); e.stopPropagation(); // solo sobre el botón\r\n          var v = $real.prop('checked');\r\n          $real.prop('checked', !v).trigger('change');\r\n          $btn.toggleClass('on', !v).toggleClass('off', v).text(!v ? '✓' : ico);\r\n        });\r\n      });\r\n    });\r\n  }\r\n\r\n  // ===== Aplica a TODOS los bloques que existan ahora =====\r\n  function skinAll(){\r\n    findContainers().forEach(skinOne);\r\n  }\r\n\r\n  // ===== Arranque =====\r\n  skinAll();\r\n\r\n  // ===== Re-aplicar en momentos clave (sin bloquear eventos nativos) =====\r\n  var reapply = debounce(skinAll, 60);\r\n\r\n  // Al hacer click en añadir/guardar/cancelar del detalle\r\n  $(document).on('click',\r\n    '[data-buttonevent=\"inlineadd\"],[data-buttonevent=\"saveall\"],[data-buttonevent=\"cancel\"],#inlineAdd2',\r\n    function(){ setTimeout(reapply, 60); }\r\n  );\r\n\r\n  // Después de cualquier AJAX que toque logisticavnp (list/add/edit)\r\n  $(document).ajaxComplete(function(_e, _xhr, settings){\r\n    if (settings && settings.url && /logisticavnp/i.test(settings.url)) {\r\n      setTimeout(reapply, 40);\r\n    }\r\n  });\r\n\r\n  // Si el DOM cambia (PHPRunner a veces reemplaza la grid completa)\r\n  new MutationObserver(debounce(skinAll, 100))\r\n    .observe(document.body, {childList:true, subtree:true});\r\n})();\r\n"
		},
		{
			"eventId": "EVENT_AFTEREDIT",
			"pageType": "edit",
			"code": "// AfterRecordUpdated\r\n// Opcional: solo para poner un mensaje “verde” más claro cuando no hubo cambios en la tabla principal.\r\n/*global $message;\r\n\r\nif (!$message) {\r\n    $message = \"Cambios guardados.\";\r\n}\r\nreturn true;\r\n\r\n*/\r\n\r\nglobal $pageObject, $message;\r\n\r\n// Si no hay mensaje previo, pon uno de éxito\r\nif (empty($message) && empty($pageObject->message)) {\r\n    $pageObject->setMessage(\"✅ Cambios guardados.\");\r\n}\r\n\r\n// Fuerza visibilidad (algunos skins lo requieren)\r\n$xt = $pageObject->xt;                // obtiene el Xtempl del pageObject\r\n$xt->assign(\"message_class\", \"alert-success\");\r\n$xt->assign(\"message_show\", true);\r\n\r\nreturn true;\r\n"
		},
		{
			"eventId": "EVENT_BEFOREMOVENEXT_LIST",
			"pageType": "list",
			"code": "\r\n\r\n\r\n// Coloring por estatus (igual que ya tienes)\r\n$st = (int)$data[\"estatusentrega\"];\r\nswitch ($st) {\r\n  case 2:  $cls = 'table-success'; break;\r\n  case 3:  $cls = 'table-danger';  break;\r\n  default: $cls = 'table-warning';\r\n}\r\nif (!isset($row[\"rowattrs\"])) $row[\"rowattrs\"] = '';\r\n$row[\"rowattrs\"] .= ' class=\"'.$cls.'\"';\r\n\r\nif ($st === 3) {\r\n    $record[\"css\"]                  = 'background:#FF3A30';\r\n    $record['fecha_css']            = 'color:white';\r\n    $record['idcliente_css']        = 'color:white';\r\n    $record['descripcion_css']      = 'color:white';\r\n    $record['estatus_css']          = 'color:white';\r\n    $record['plazo_css']            = 'color:white';\r\n    $record['orden_css']            = 'color:white';\r\n    $record['maps_url_css']         = 'color:white';\r\n    $record['estatusentrega_css']   = 'color:white';\r\n    $record['equipo_css']           = 'color:white';\r\n    $record['chip_css']             = 'color:white';\r\n}\r\n\r\n// PK\r\n// PK\r\n$pk = $data[\"idsolicitud\"];\r\nif (!$pk) return;\r\n\r\n// Elige la página (usa tu lógica real)\r\n$role = strtoupper($_SESSION[\"Label\"] ?? ''); \r\n\r\n// === 2) Elegir página target ===\r\n// === 2) Página destino ===\r\n$targetPage = ($role === 'MESADECONTROL') ? 'edit1' : 'edit';\r\n\r\n// === 3) Base SIEMPRE a \"edit\" para obtener solicitudes_edit.php\r\n$baseHref = GetTableLink(\"solicitudes\", \"edit\"); // => solicitudes_edit.php\r\n\r\n// === 4) Querystring: page=..., editid1=..., menuItemId (si existe)\r\n$qs = [];\r\n$qs[] = \"page=\".$targetPage;\r\n$qs[] = \"editid1=\".$pk;\r\n\r\n// Conserva menuItemId si llegó por GET/POST\r\n$menuItemId = postvalue(\"menuItemId\");\r\nif( strlen($menuItemId) ){\r\n    $qs[] = \"menuItemId=\".rawurlencode($menuItemId);\r\n}\r\n\r\n$href = $baseHref . \"?\" . implode(\"&\", $qs);\r\n\r\n// === 5) Data-attrs que PHPRunner usa para popup/handlers ===\r\n$keys = array(\"idsolicitud\" => $pk);\r\n$keysJson = runner_htmlspecialchars(my_json_encode($keys));\r\n\r\n$attrs  = 'href=\"'.runner_htmlspecialchars($href).'\"';\r\n$attrs .= ' data-href=\"'.runner_htmlspecialchars($href).'\"';\r\n$attrs .= ' data-table=\"'.GetTableURL(\"solicitudes\").'\"';\r\n$attrs .= ' data-pagetype=\"edit\"';\r\n$attrs .= ' data-page=\"'.$targetPage.'\"';\r\n$attrs .= ' data-keys=\"'.$keysJson.'\"';\r\n$attrs .= ' class=\"rnr-editlink\"';\r\n\r\n// === 6) Reasignar a los tres puntos de enlace comunes ===\r\n$record[\"editlink_attrs\"]        = $attrs;\r\n$record[\"editlink_attrs_icon\"]   = $attrs;\r\n$record[\"editlink_button_attrs\"] = $attrs;\r\n\r\n// Debug\r\nerror_log(\"DEBUG-REDIR: Role=$role TargetPage=$targetPage Href=$href\", 3, 'debug_file.log');"
		},
		{
			"eventId": "EVENT_BEFORESHOW_EDIT",
			"pageType": "edit",
			"code": "// BeforeShowEdit — tabla: solicitudes\r\n\r\n/*\r\nglobal $pageObject, $xt;\r\n\r\n\r\n\r\n\r\n\r\n\r\n $_SESSION[\"idactual\"]=$values['idproducto'];\r\n// Recuperación tras error\r\nif (isset($_SESSION['edit_data_temp']) && is_array($_SESSION['edit_data_temp'])) {\r\n    $recovery = $_SESSION['edit_data_temp'];\r\n\r\n    // Reinyecta por proxy (para lo que está en la tabla principal)\r\n    foreach ($recovery as $field => $value) {\r\n        if ($value !== null && $value !== '') {\r\n            $pageObject->setProxyValue(\"value_{$field}_1\", $value);\r\n        }\r\n    }\r\n\r\n    // Mensaje\r\n    $xt->assign(\"message\", \"⚠️ Se recuperaron los datos del intento anterior. Revise y guarde nuevamente.\");\r\n    $xt->assign(\"message_class\", \"alert-warning\");\r\n    // No limpiamos aquí; se limpia en éxito\r\n}\r\n\r\n\r\n   if (isset($_SESSION['__last_edit_error__']) && $_SESSION['__last_edit_error__'] !== '') {\r\n        $xt->assign(\"message\", $_SESSION['__last_edit_error__']);      // texto\r\n        $xt->assign(\"message_class\", \"alert-danger\");                   // rojo\r\n        unset($_SESSION['__last_edit_error__']);\r\n    }\r\n\r\n\r\n\r\n// Flash de éxito (opcional si no rediriges)\r\nif (isset($_SESSION['flash_ok'])) {\r\n    $xt->assign(\"message\", $_SESSION['flash_ok']);\r\n    $xt->assign(\"message_class\", \"alert-success\");\r\n    unset($_SESSION['flash_ok']);\r\n    unset($_SESSION['edit_data_temp']);\r\n}\r\n\r\n// Contexto para JS (idsolicitud, noserie actual desde DB)\r\n$data = $pageObject->getCurrentRecordInternal();\r\n$ctx = [\r\n    \"idsolicitud\"    => $data[\"idsolicitud\"],\r\n    \"noserie_actual\" => null\r\n];\r\n\r\n// noserie de Equipo actual (si existe) — mismo query que en BeforeRecordUpdated\r\n$sqlCur = \"\r\nSELECT MAX(CASE WHEN pr.clasif='Equipo' THEN ss.esnimei END) AS noserie\r\nFROM seriessolicitadas ss\r\nJOIN compras cp ON cp.noserie=ss.esnimei\r\nJOIN productos pr ON pr.codigoIUSA=cp.codigoproducto\r\nWHERE ss.idsolicitud=\".(int)$data[\"idsolicitud\"];\r\n$rsCur  = db_query($sqlCur, $pageObject->connection);\r\n$rowCur = db_fetch_array($rsCur);\r\n$ctx[\"noserie_actual\"] = $rowCur ? $rowCur[\"noserie\"] : \"\";\r\n\r\n$pageObject->setProxyValue(\"edit_ctx\", $ctx);\r\n\r\nreturn true;*/\r\n\r\n\r\n\r\n\r\n/*\r\n\r\n// BeforeShowEdit — tabla: solicitudes\r\nglobal $pageObject, $xt;\r\n\r\n$_SESSION[\"idactual\"] = $values['idproducto'] ?? null;\r\n\r\n// --- Mensaje de error traído desde sesión (cuando BeforeRecordUpdated hizo return false)\r\nif (isset($_SESSION['__last_edit_error__']) && $_SESSION['__last_edit_error__'] !== '') {\r\n    // Usa la API de PHPRunner para garantizar que el template lo pinte\r\n    $pageObject->setMessage($_SESSION['__last_edit_error__']);\r\n    $xt->assign(\"message_class\", \"alert-danger\");\r\n    $xt->assign(\"message_show\", true);              // <- SIN ESTO sale la franja vacía\r\n    unset($_SESSION['__last_edit_error__']);\r\n}\r\n\r\n// --- Mensaje de éxito (flash)\r\nif (isset($_SESSION['flash_ok'])) {\r\n    $pageObject->setMessage($_SESSION['flash_ok']);\r\n    $xt->assign(\"message_class\", \"alert-success\");\r\n    $xt->assign(\"message_show\", true);\r\n    unset($_SESSION['flash_ok'], $_SESSION['edit_data_temp']);\r\n}\r\n\r\n// --- Recuperación tras error de validación (si la usas)\r\nif (isset($_SESSION['edit_data_temp']) && is_array($_SESSION['edit_data_temp'])) {\r\n    $recovery = $_SESSION['edit_data_temp'];\r\n    foreach ($recovery as $field => $value) {\r\n        if ($value !== null && $value !== '') {\r\n            $pageObject->setProxyValue(\"value_{$field}_1\", $value);\r\n        }\r\n    }\r\n    // No fuerces aquí el mensaje si ya hay uno más importante arriba\r\n    if (!$pageObject->message) {\r\n        $pageObject->setMessage(\"⚠️ Se recuperaron los datos del intento anterior. Revise y guarde nuevamente.\");\r\n        $xt->assign(\"message_class\", \"alert-warning\");\r\n        $xt->assign(\"message_show\", true);\r\n    }\r\n}\r\n\r\n// Contexto para JS (idsolicitud, noserie actual desde DB)\r\n$data = $pageObject->getCurrentRecordInternal();\r\n$ctx = [\r\n    \"idsolicitud\"    => $data[\"idsolicitud\"],\r\n    \"noserie_actual\" => null\r\n];\r\n\r\n// noserie de Equipo actual (si existe) — mismo query que en BeforeRecordUpdated\r\n$sqlCur = \"\r\nSELECT MAX(CASE WHEN pr.clasif='Equipo' THEN ss.esnimei END) AS noserie\r\nFROM seriessolicitadas ss\r\nJOIN compras cp ON cp.noserie=ss.esnimei\r\nJOIN productos pr ON pr.codigoIUSA=cp.codigoproducto\r\nWHERE ss.idsolicitud=\".(int)$data[\"idsolicitud\"];\r\n$rsCur  = db_query($sqlCur, $pageObject->connection);\r\n$rowCur = db_fetch_array($rsCur);\r\n$ctx[\"noserie_actual\"] = $rowCur ? $rowCur[\"noserie\"] : \"\";\r\n\r\n$pageObject->setProxyValue(\"edit_ctx\", $ctx);\r\nreturn true;\r\n*/\r\n\r\n\r\n\r\n\r\n/*\r\n\r\n// BeforeShowEdit — tabla: solicitudes\r\nglobal $pageObject, $xt, $values;\r\n\r\n// ----------------------------------------------------\r\n// 1) Estado mínimo que ya usas\r\n// ----------------------------------------------------\r\n$_SESSION[\"idactual\"] = $values['idproducto'];\r\n\r\n// ¿Es popup?\r\n$isPopup = $pageObject->isPopup();\r\n\r\n// ----------------------------------------------------\r\n// 2) Mensajes venidos del servidor (set en eventos previos)\r\n//    __srv_msg_text__/__srv_msg_type__: canal robusto para popup/no-popup\r\n//    __last_edit_error__: compatibilidad con tu código previo\r\n// ----------------------------------------------------\r\n$servedMsgText = isset($_SESSION['__srv_msg_text__']) ? $_SESSION['__srv_msg_text__'] : '';\r\n$servedMsgType = isset($_SESSION['__srv_msg_type__']) ? $_SESSION['__srv_msg_type__'] : 'info';\r\n\r\nif ($servedMsgText !== '') {\r\n\t// Limpiar después de leer\r\n\tunset($_SESSION['__srv_msg_text__'], $_SESSION['__srv_msg_type__']);\r\n\r\n\tif ($isPopup) {\r\n\t\t// En popup mandamos por proxy y lo muestra JS (ClientAfter)\r\n\t\t$pageObject->setProxyValue(\"popup_msg\", [\r\n\t\t\t\"text\" => $servedMsgText,\r\n\t\t\t\"type\" => $servedMsgType   // 'success' | 'error' | 'info'\r\n\t\t]);\r\n\t} else {\r\n\t\t// En página normal usamos el bloque de mensaje del template\r\n\t\t$pageObject->setMessage($servedMsgText);\r\n\t\t$xt->assign(\"message_class\", $servedMsgType === 'success' ? \"alert-success\" : \"alert-danger\");\r\n\t\t$xt->assign(\"message_block\", true);\r\n\t}\r\n}\r\n\r\n// Compatibilidad: si quedó algún error “legacy”\r\nif (isset($_SESSION['__last_edit_error__']) && $_SESSION['__last_edit_error__'] !== '') {\r\n\t$legacyErr = $_SESSION['__last_edit_error__'];\r\n\tunset($_SESSION['__last_edit_error__']);\r\n\r\n\tif ($isPopup) {\r\n\t\t$pageObject->setProxyValue(\"popup_msg\", [\r\n\t\t\t\"text\" => $legacyErr,\r\n\t\t\t\"type\" => \"error\"\r\n\t\t]);\r\n\t} else {\r\n\t\t$pageObject->setMessage($legacyErr);\r\n\t\t$xt->assign(\"message_class\", \"alert-danger\");\r\n\t\t$xt->assign(\"message_block\", true);\r\n\t}\r\n}\r\n\r\n// Flash de éxito clásico (si lo usas)\r\nif (isset($_SESSION['flash_ok'])) {\r\n\tif ($isPopup) {\r\n\t\t$pageObject->setProxyValue(\"popup_msg\", [\r\n\t\t\t\"text\" => $_SESSION['flash_ok'],\r\n\t\t\t\"type\" => \"success\"\r\n\t\t]);\r\n\t} else {\r\n\t\t$pageObject->setMessage($_SESSION['flash_ok']);\r\n\t\t$xt->assign(\"message_class\", \"alert-success\");\r\n\t\t$xt->assign(\"message_block\", true);\r\n\t}\r\n\tunset($_SESSION['flash_ok']);\r\n\t// Limpia recuperación en éxito si la usas\r\n\tunset($_SESSION['edit_data_temp']);\r\n}\r\n\r\n// ----------------------------------------------------\r\n// 3) Recuperación tras error (reinyectar valores)\r\n// ----------------------------------------------------\r\nif (isset($_SESSION['edit_data_temp']) && is_array($_SESSION['edit_data_temp'])) {\r\n\t$recovery = $_SESSION['edit_data_temp'];\r\n\r\n\t// Reinyecta por proxy (PHPRunner buscará value_<campo>_1)\r\n\tforeach ($recovery as $field => $val) {\r\n\t\tif ($val !== null && $val !== '') {\r\n\t\t\t$pageObject->setProxyValue(\"value_{$field}_1\", $val);\r\n\t\t}\r\n\t}\r\n\r\n\t// Mensaje amarillo si no hubo ya uno más específico\r\n\tif (!$isPopup) {\r\n\t    $pageObject->setProxyValue(\"popup_msg\", [\"text\"=>\"✅ Cambios guardados\",\"type\"=>\"success\"]);\r\n\t\t$xt->assign(\"message\", \"⚠️ Se recuperaron los datos del intento anterior. Revise y guarde nuevamente.\");\r\n\t\t$xt->assign(\"message_class\", \"alert-warning\");\r\n\t\t$xt->assign(\"message_block\", true);\r\n\t} else {\r\n\t\t// En popup: también lo mandamos como info si no hay otro mensaje\r\n\t\tif (empty($servedMsgText)) {\r\n\r\n\t\t\t$pageObject->setProxyValue(\"popup_msg\", [\r\n\t\t\t\t\"text\" => \"⚠️ Se recuperaron los datos del intento anterior. Revise y guarde nuevamente.\",\r\n\t\t\t\t\"type\" => \"info\"\r\n\t\t\t]);\r\n\t\t}\r\n\t}\r\n\t// Nota: no limpiamos aquí; se limpia cuando el guardado sea exitoso\r\n}\r\n\r\n// ----------------------------------------------------\r\n// 4) Contexto para JS (idsolicitud y noserie actual)\r\n// ----------------------------------------------------\r\n$data = $pageObject->getCurrentRecordInternal();\r\n$ctx = [\r\n\t\"idsolicitud\"    => $data[\"idsolicitud\"],\r\n\t\"noserie_actual\" => null\r\n];\r\n\r\n// noserie de Equipo actual\r\n$sqlCur = \"\r\n\tSELECT MAX(CASE WHEN pr.clasif='Equipo' THEN ss.esnimei END) AS noserie\r\n\tFROM seriessolicitadas ss\r\n\tJOIN compras cp  ON cp.noserie = ss.esnimei\r\n\tJOIN productos pr ON pr.codigoIUSA = cp.codigoproducto\r\n\tWHERE ss.idsolicitud=\".(int)$data[\"idsolicitud\"];\r\n$rsCur  = db_query($sqlCur, $pageObject->connection);\r\n$rowCur = db_fetch_array($rsCur);\r\n$ctx[\"noserie_actual\"] = $rowCur ? $rowCur[\"noserie\"] : \"\";\r\n\r\n$pageObject->setProxyValue(\"edit_ctx\", $ctx);\r\n\r\n// Asegura que el bloque de mensaje exista en página normal\r\nif (!$isPopup) {\r\n\t$xt->assign(\"message_block\", true);\r\n}\r\n\r\nreturn true;\r\n*/\r\n\r\n\r\n// BeforeShowEdit — tabla: solicitudes\r\nglobal $pageObject, $xt, $conn;\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n/**\r\n * Helper para mandar un mensaje al cliente (OnLoad) que se verá\r\n * tanto en popup como en página normal.\r\n * Tipos: success | error | warning | info\r\n */\r\nfunction pushPopupMsg($pageObject, $text, $type = 'info') {\r\n    if (!$text) return;\r\n    $pageObject->setProxyValue(\"popup_msg\", [\r\n        \"text\" => $text,\r\n        \"type\" => $type\r\n    ]);\r\n}\r\n\r\n/* =========================================================\r\n   1) Reinyectar (opcional) datos tras error de validación\r\n   ========================================================= */\r\nif (isset($_SESSION['edit_data_temp']) && is_array($_SESSION['edit_data_temp'])) {\r\n    $recovery = $_SESSION['edit_data_temp'];\r\n\r\n    // Si quieres reinyectar directamente en controles que pertenecen\r\n    // a la tabla principal, puedes habilitar este bloque:\r\n    foreach ($recovery as $field => $value) {\r\n        if ($value !== null && $value !== '') {\r\n            // value_{campo}_{pageid}. En Edit suele ser \"_1\"\r\n            $pageObject->setProxyValue(\"value_{$field}_1\", $value);\r\n        }\r\n    }\r\n\r\n    // Aviso al usuario\r\n    pushPopupMsg($pageObject, \"⚠️ Se recuperaron los datos del intento anterior. Revise y guarde nuevamente.\", \"warning\");\r\n    // NO limpiamos aquí; se limpia al guardar exitosamente en AfterRecordUpdated.\r\n}\r\n\r\n/* =========================================================\r\n   2) Mensajes de error/éxito desde otros eventos\r\n   ========================================================= */\r\n\r\n// Error “duro” en BeforeRecordUpdated (guardado fallido controlado)\r\n/*\r\nfunction dbg_log($msg){\r\n    @file_put_contents(getabspath(\"debug_log.txt\"), date('c').\" \".$msg.\"\\n\", FILE_APPEND);\r\n}\r\n*/\r\n \r\nglobal $xt, $pageObject;\r\n\r\n// 1. Definir una variable de template para el script\r\n$jsScript = ''; \r\n\r\nif (!empty($_SESSION['__last_edit_error__'])) {\r\n    $msg = $_SESSION['__last_edit_error__'];\r\n    \r\n    // 1. Asignar el mensaje estándar (Necesario para rellenar el HTML)\r\n    $pageObject->setMessage($msg);\r\n    $xt->assign(\"message_class\", \"alert-danger\");\r\n\r\n    // 2. Forzar la visibilidad del bloque de mensaje\r\n    $xt->assign(\"message_block\", true); \r\n    \r\n    // 3. 💡 CREAR EL SCRIPT DE INYECCIÓN\r\n    // Este script se ejecutará después de que se cargue el DOM.\r\n    $jsScript = \"\r\n        <script>\r\n        $(document).ready(function() { \r\n            var \\$msgBlock = $('#message_block');\r\n            \r\n            // Si el mensaje tiene contenido, forzar la visibilidad\r\n            if (\\$msgBlock.find('.alert').length > 0) {\r\n                \\$msgBlock.show(); \r\n                \\$msgBlock.find('.alert').removeClass('hide').show();\r\n            }\r\n        });\r\n        </script>\r\n    \";\r\n    \r\n    dbg_log(\"intentando desplegar mensaje via HTML: \".$msg);\r\n    unset($_SESSION['__last_edit_error__']);\r\n}\r\n\r\n// 4. 💡 ASIGNAR EL SCRIPT A UNA VARIABLE DEL TEMPLATE (Al final del BeforeShowEdit)\r\n// Usaremos la variable global 'end_body' para inyectar el JS justo antes de </body>\r\n$xt->assign(\"end_body\", $jsScript);\r\n\r\n// NOTA: Si 'end_body' no funciona, puedes probar asignándolo a un campo\r\n// de la tabla que sea Hidden o Read-Only para inyectar el HTML en su lugar.\r\n// Ej: $xt->assign(\"my_hidden_field_editcontrol\", array(\"field\" => \"my_hidden_field\", \"begin\" => $jsScript));\r\n// Pero 'end_body' es la forma estándar de inyectar scripts.\r\n/*\r\nif (!empty($_SESSION['__last_edit_error__'])) {\r\n    $msg = $_SESSION['__last_edit_error__'];\r\n        pushPopupMsg($pageObject, $msg, \"error\");\r\n        unset($_SESSION['__last_edit_error__']);\r\n        \r\n        // 💡 AÑADE ESTO: Fuerza la visualización en el bloque de mensaje estándar\r\n        $pageObject->setMessage($msg);\r\n        $xt->assign(\"message_class\", \"alert-danger\");\r\n}\r\n*/\r\n// Flash de éxito desde AfterRecordUpdated (si no rediriges)\r\nif (!empty($_SESSION['flash_ok'])) {\r\n    $msg = $_SESSION['flash_ok'];\r\n    pushPopupMsg($pageObject, $msg, \"success\");\r\n    unset($_SESSION['flash_ok']);\r\n    unset($_SESSION['edit_data_temp']);\r\n    \r\n    // 💡 AÑADE ESTO: Fuerza la visualización en el bloque de mensaje estándar\r\n    $pageObject->setMessage($msg);\r\n    $xt->assign(\"message_class\", \"alert-success\");\r\n}\r\n\r\n/* =========================================================\r\n   3) Contexto para JS (idsolicitud + noserie actual)\r\n   ========================================================= */\r\n\r\n// Obtén el registro actual de forma segura\r\n$data = $pageObject->getCurrentRecordInternal();  // incluye PK y campos del origen de datos\r\n$idsolicitud = isset($data[\"idsolicitud\"]) ? (int)$data[\"idsolicitud\"] : 0;\r\n\r\n// Consulta la serie (Equipo) actualmente ligada a la solicitud\r\n$noserieActual = \"\";\r\nif ($idsolicitud > 0) {\r\n    $sqlCur = \"\r\n        SELECT MAX(CASE WHEN pr.clasif='Equipo' THEN ss.esnimei END) AS noserie\r\n        FROM seriessolicitadas ss\r\n        JOIN compras   cp ON cp.noserie     = ss.esnimei\r\n        JOIN productos pr ON pr.codigoIUSA  = cp.codigoproducto\r\n        WHERE ss.idsolicitud = \".$idsolicitud.\"\r\n    \";\r\n    $rsCur  = db_query($sqlCur, $pageObject->connection);\r\n    if ($rsCur) {\r\n        $rowCur = db_fetch_array($rsCur);\r\n        if ($rowCur && isset($rowCur[\"noserie\"])) {\r\n            $noserieActual = $rowCur[\"noserie\"];\r\n        }\r\n    }\r\n}\r\n\r\n// Entrega el contexto al cliente para que el onload lo use\r\n$pageObject->setProxyValue(\"edit_ctx\", [\r\n    \"idsolicitud\"    => $idsolicitud,\r\n    \"noserie_actual\" => $noserieActual\r\n]);\r\n\r\n/* =========================================================\r\n   4) (Opcional) Mostrar también un mensaje “server-rendered”\r\n      en el bloque estándar de mensajes, por compatibilidad.\r\n   ========================================================= */\r\n// Si quieres que además aparezca la banda clásica del template:\r\nif (!empty($pageObject->message)) {\r\n    // PHPRunner ya habrá seteado message internamente si procede.\r\n    // Opcionalmente podrías mapear tipo si lo controlas.\r\n    $xt->assign(\"message\", $pageObject->message);\r\n    // Ejemplo: $xt->assign(\"message_class\", \"alert-success\"); // o alert-danger\r\n}\r\n\r\n// Fin\r\nreturn true;\r\n\r\n\r\n\r\n\r\n"
		},
		{
			"eventId": "EVENT_BEFOREQUERY_LIST",
			"pageType": "list",
			"code": "\nswitch (true) {\n\n\t//case ($_SESSION[\"Acceso\"]===0 OR strtoupper($_SESSION['UserID'])=='ADMIN'):\n\tcase ( strtoupper($_SESSION['UserID'])=='ADMIN'):\n\t\t\t\t\tbreak;\n\t\tcase (strtoupper($_SESSION[\"Label\"])=='VALIDADOR'  || strtoupper($_SESSION[\"Label\"])=='MESADECONTROL'):\n    //   $strWhereClause=WhereAdd($strWhereClause,\"solicitudes.idtipoventa in (1,11,21,22)\");\n\t       break;\n\t\t\t\n\t\t\tcase ($_SESSION[\"Acceso\"]==1):\n       $strWhereClause=WhereAdd($strWhereClause,\"/*solicitudes.idtipoventa not in (1,11,21,22) and*/ solicitudes.idtienda=\".$_SESSION[\"Tienda\"]); /*solicitado por Diego*/\n \n        break;\n  /* case ($_SESSION[\"Acceso\"]==2):\n\t\t\t\t\n         $strWhereClause=WhereAdd($strWhereClause,\"solicitudes.idtipoventa>1 AND solicitudes.idtienda=\".$_SESSION[\"Tienda\"]);\n        break;*/\n    case ($_SESSION[\"Acceso\"]===10 ):\n        $strWhereClause=whereAdd($strWhereClause,\" solicitudes.idtienda in (\nselect distinct t.idtienda from tiendas t inner join\n userssectores us on t.idsector=us.idsector\n where username='\".$_SESSION[\"UserID\"].\"')\");\n        break;\n\t\tdefault:\n\t\t\t\t$strWhereClause=whereAdd($strWhereClause,\"solicitudes.usuario='\".$_SESSION['UserID'].\"'\");\n\t\t\t\tbreak;\n}\n\n\n\n\n\n\n\n// 1) Tomar fechas en este orden de prioridad: GET -> SESSION -> defaults\n$in  = isset($_GET['FechaIn']) ? $_GET['FechaIn'] : ( isset($_SESSION['FechaIn']) ? $_SESSION['FechaIn'] : date('Y-m-d', strtotime('-30 days')) );\n$fn  = isset($_GET['FechaFn']) ? $_GET['FechaFn'] : ( isset($_SESSION['FechaFn']) ? $_SESSION['FechaFn'] : date('Y-m-d') );\n\n// 2) Validar formato (YYYY-MM-DD); si no es válido, poner defaults\n$check = function($d){\n    $dt = DateTime::createFromFormat('Y-m-d', $d);\n    return $dt && $dt->format('Y-m-d') === $d;\n};\nif( !$check($in) ) $in = date('Y-m-d', strtotime('-30 days'));\nif( !$check($fn) ) $fn = date('Y-m-d');\n\n// 3) Si el usuario invirtió el rango, corregir (swap)\nif( $in > $fn ){\n    $tmp = $in; $in = $fn; $fn = $tmp;\n}\n\n// 4) Guardar en sesión (para siguientes cargas)\n$_SESSION['FechaIn'] = $in;\n$_SESSION['FechaFn'] = $fn;\n\n// 5) Construir el WHERE\n//    - Si tu campo 'fecha' es DATE, BETWEEN es inclusivo y esto basta.\n//    - Si fuese DATETIME y quieres incluir todo el día final, usa <= DATE_ADD($fn, INTERVAL 1 DAY)\nif( $strWhereClause != \"\" ) {\n    $strWhereClause .= \" AND \";\n}\n$strWhereClause .= \" solicitudes.fecha BETWEEN \" . add_db_quotes(\"fecha\", $in) . \" AND \" . add_db_quotes(\"fecha\", $fn);\n\n// Para depurar:\n// LogInfo(\"Rango aplicado: $in a $fn\");\n// LogInfo(\"WHERE: \".$strWhereClause);\n"
		},
		{
			"eventId": "EVENT_BEFOREEDIT",
			"pageType": "edit",
			"code": "// BeforeRecordUpdated\r\n// Se ejecuta SIEMPRE cuando el usuario pulsa Guardar en Edit, aunque la tabla principal no cambie.\r\n/*\r\nglobal $conn, $message, $pageObject;\r\n\r\n// ---------- Helpers ----------\r\nfunction q($v){ // cadenas/fechas: 'valor' o NULL\r\n    return (isset($v) && $v !== '' ? db_prepare_string($v) : \"NULL\");\r\n}\r\nfunction qi($v){ // enteros: número o NULL\r\n    return (isset($v) && $v !== '' ? (int)$v : \"NULL\");\r\n}\r\nfunction qb($v){ // booleano/bit: 0/1\r\n    return (!empty($v) ? 1 : 0);\r\n}\r\nfunction qd($v, $scale = 2) { // decimales: número (formateado) o NULL\r\n    if (!isset($v) || $v === '') return \"NULL\";\r\n    $n = (float)$v;\r\n    return number_format($n, $scale, '.', ''); // sin comillas\r\n}\r\n\r\n\r\n// Campos que NO son de la tabla 'solicitudes'\r\n$extraFields = ['estado','ciudad','cp','calle','numeroext','numeroint','colonia','lat','lng','noserie'];\r\n\r\n// 1) Saca del SET de PHPRunner los campos que no pertenecen a la tabla principal\r\n$extras = [];\r\nforeach ($extraFields as $f) {\r\n    if (array_key_exists($f, $values)) {\r\n        $extras[$f] = $values[$f];\r\n        unset($values[$f]);              // <- evita \"Unknown column 'calle' in SET\"\r\n    }\r\n    // por si vienen como custom / readonly en POST\r\n    $pv = postvalue($f);\r\n    if ($pv !== null && $pv !== '') $extras[$f] = $pv;\r\n}\r\n\r\n$idsolicitud = (int)$keys['idsolicitud'];\r\n$estatusentrega=qi($values['estatusentrega']);\r\n\r\n// ---------- 2) UPSERT en entregasvnp (sin duplicar filas) ----------\r\n$hayDireccion =\r\n    (!empty($extras['estado']))     || (!empty($extras['ciudad'])) ||\r\n    (!empty($extras['cp']))         || (!empty($extras['calle']))  ||\r\n    (!empty($extras['numeroext']))  || (!empty($extras['numeroint'])) ||\r\n    (!empty($extras['colonia']))    || (isset($extras['lat']))     || (isset($extras['lng']));\r\n\r\nif ($hayDireccion) {\r\n    // ¿existe ya fila para esta solicitud?\r\n    $rsExist = db_query(\"SELECT idsolicitud FROM entregasvnp WHERE idsolicitud = {$idsolicitud} LIMIT 1\", $conn);\r\n    $exists  = db_fetch_array($rsExist);\r\n\r\n    // Normalizamos valores\r\n    $estado    = q($extras['estado']    ?? null);\r\n    $ciudad    = q($extras['ciudad']    ?? null);\r\n    $cp        = qi($extras['cp']       ?? null);\r\n    $calle     = q($extras['calle']     ?? null);\r\n    $numeroext = q($extras['numeroext'] ?? null);\r\n    $numeroint = q($extras['numeroint'] ?? null);\r\n    $colonia   = q($extras['colonia']   ?? null);\r\n    $lat       = q($extras['lat']       ?? null);\r\n    $lng       = q($extras['lng']       ?? null);\r\n\r\n    if ($exists) {\r\n        // UPDATE primero (no genera duplicados)\r\n        $sqlEV = \"\r\n            UPDATE entregasvnp SET\r\n                estado    = {$estado},\r\n                ciudad    = {$ciudad},\r\n                cp        = {$cp},\r\n                calle     = {$calle},\r\n                numeroext = {$numeroext},\r\n                numeroint = {$numeroint},\r\n                colonia   = {$colonia},\r\n                lat       = {$lat},\r\n                lng       = {$lng}\r\n            WHERE idsolicitud = {$idsolicitud}\r\n            LIMIT 1\r\n        \";\r\n        if (!DB::Exec($sqlEV, $conn)) {\r\n            $message = 'No se pudo actualizar la dirección de entrega: '.DB::LastError();\r\n        }\r\n    } else {\r\n        // Si no existe, INSERT una sola vez\r\n        $sqlEV = \"\r\n            INSERT INTO entregasvnp\r\n                (idsolicitud, estado, ciudad, cp, calle, numeroext, numeroint, colonia, lat, lng)\r\n            VALUES\r\n                ({$idsolicitud}, {$estado}, {$ciudad}, {$cp}, {$calle}, {$numeroext}, {$numeroint}, {$colonia}, {$lat}, {$lng})\r\n        \";\r\n        if (!DB::Exec($sqlEV, $conn)) {\r\n            $message = 'No se pudo insertar la dirección de entrega: '.DB::LastError();\r\n        }\r\n    }\r\n}\r\n\r\n\r\n\r\n\r\n// ---------- 2.5) UPSERT en ventas cuando el estatus general sea CERRADO ----------\r\nfunction dbg_log($msg){\r\n    @file_put_contents(getabspath(\"debug_log.txt\"), date('c').\" \".$msg.\"\\n\", FILE_APPEND);\r\n}\r\n\r\n// 1) Obtener estatusgral correctamente (texto, no decimal)\r\n$estatusgral = '';\r\n$rsestatusgral = DB::Query(\"SELECT estatusgral FROM estatusentregas WHERE id=\". (int)$estatusentrega);\r\nif ($rsestatusgral) {\r\n    $estatusgral = strtoupper(trim($rsestatusgral->value(\"estatusgral\")));\r\n}\r\ndbg_log(\"estatusentrega={$estatusentrega} estatusgral={$estatusgral}\");\r\n\r\nif ($estatusgral === 'CERRADO') {\r\n\r\n    // 2) Normalizar valores (usa tus helpers q/qi/qd)\r\n    $idsolicitud    = (int)$idsolicitud;\r\n\r\n    $idtipoventa    = qi($values['idtipoventa']   ?? null);\r\n    $fecha          = q(date(\"Y-m-d\"));                          // fecha de venta hoy\r\n    $idcliente      = qi($values['idcliente']     ?? null);\r\n\r\n    // ojo: en tu app el plan suele ser idplan\r\n    $plan           = qi($values['idplan']        ?? null);\r\n    $plazo          = qi($values['plazo']         ?? null);\r\n\r\n    $esnimei        = q(trim($extras['noserie']   ?? ''));        // serie del equipo\r\n    $usuario        = q($_SESSION[\"UserID\"]       ?? null);\r\n    $tienda         = qi($_SESSION[\"Tienda\"]      ?? 0);\r\n\r\n    $dn             = q($values['dn']             ?? null);\r\n    $dnpreferido    = q($values['dnpreferido']    ?? null);\r\n    $cuenta         = q($values['cuenta']         ?? null);\r\n    $contrato       = q($values['contrato']       ?? null);\r\n    $contratoportal = q($values['contratoportal'] ?? null);\r\n    $plazopendiente = qi($values['plazopendiente']?? null);\r\n    $factura        = q($values['factura']        ?? null);\r\n    $fechavenci     = q($values['fechavenci']     ?? null);\r\n    $ciclo          = qi($values['ciclo']         ?? null);\r\n\r\n    $ventadomicilio = 1;\r\n    $equipoincluido = 1;\r\n\r\n    // 3) Obtener la renta del plan\r\n    //    (si plan es NULL, renta también será NULL)\r\n    $renta = \"NULL\";\r\n    if ($plan !== \"NULL\") {\r\n        $rsplanes = DB::Query(\"SELECT renta FROM planes WHERE idplan={$plan}\");\r\n        if ($rsplanes) {\r\n            $renta = qd($rsplanes->value(\"renta\"), 2); // decimal con 2 decimales\r\n        }\r\n    }\r\n\r\n    // 4) UPSERT con ON DUPLICATE KEY (idsolicitud debe ser UNIQUE en ventas)\r\n    $sqlEV = \"\r\n        INSERT INTO ventas\r\n            (idsolicitud, idtipoventa, fecha, idcliente, esnimei, plan, plazo, usuario, tienda, ventadomicilio, equipoincluido, renta,\r\n             dn, dnpreferido, cuenta, contrato, contratoportal, plazopendiente, factura, fechavenci, ciclo)\r\n        VALUES\r\n            ({$idsolicitud}, {$idtipoventa}, {$fecha}, {$idcliente}, {$esnimei}, {$plan}, {$plazo}, {$usuario}, {$tienda}, {$ventadomicilio}, {$equipoincluido}, {$renta},\r\n             {$dn}, {$dnpreferido}, {$cuenta}, {$contrato}, {$contratoportal}, {$plazopendiente}, {$factura}, {$fechavenci}, {$ciclo})\r\n        ON DUPLICATE KEY UPDATE\r\n            idtipoventa=VALUES(idtipoventa),\r\n            fecha=VALUES(fecha),\r\n            idcliente=VALUES(idcliente),\r\n            esnimei=VALUES(esnimei),\r\n            plan=VALUES(plan),\r\n            plazo=VALUES(plazo),\r\n            usuario=VALUES(usuario),\r\n            tienda=VALUES(tienda),\r\n            ventadomicilio=VALUES(ventadomicilio),\r\n            equipoincluido=VALUES(equipoincluido),\r\n            renta=VALUES(renta),\r\n            dn=VALUES(dn),\r\n            dnpreferido=VALUES(dnpreferido),\r\n            cuenta=VALUES(cuenta),\r\n            contrato=VALUES(contrato),\r\n            contratoportal=VALUES(contratoportal),\r\n            plazopendiente=VALUES(plazopendiente),\r\n            factura=VALUES(factura),\r\n            fechavenci=VALUES(fechavenci),\r\n            ciclo=VALUES(ciclo)\r\n    \";\r\n\r\n    dbg_log(\"UPSERT ventas SQL: \".$sqlEV);\r\n\r\nif (!DB::Exec($sqlEV, $conn)) {\r\n    $err = DB::LastError();\r\n    $message = 'No se pudo guardar la venta: '.$err;\r\n\r\n\r\n\r\n    return false; // <- importante\r\n} else {\r\n    $ok = \"✅ Venta/solicitud actualizada correctamente.\";\r\n\r\n    // opcional mostrar también en no-popup\r\n    $pageObject->setMessage($ok);\r\n\r\n\r\n}\r\n    \r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n// 3) Serie (seriessolicitadas)\r\n$noserieNuevo = trim($extras['noserie'] ?? '');\r\nif ($noserieNuevo !== '') {\r\n    // Serie actual\r\n    $sqlSerieActual = \"\r\n        SELECT ss.esnimei\r\n        FROM seriessolicitadas ss\r\n        JOIN compras cp  ON cp.noserie = ss.esnimei\r\n        JOIN productos pr ON pr.codigoIUSA = cp.codigoproducto\r\n        WHERE ss.idsolicitud = {$idsolicitud}\r\n          AND pr.clasif = 'Equipo'\r\n        LIMIT 1\r\n    \";\r\n    $rs = db_query($sqlSerieActual, $conn);\r\n    $row = db_fetch_array($rs);\r\n    $noserieActual = $row ? $row['esnimei'] : '';\r\n\r\n    if ($noserieNuevo !== $noserieActual) {\r\n        // Validar disponibilidad (o que esté ya ligada a esta solicitud)\r\n        $strSQLExists = \"\r\n            SELECT c.noserie\r\n            FROM compras c\r\n            LEFT JOIN ventas v         ON c.noserie = v.esnimei\r\n            LEFT JOIN movimientos m    ON c.noserie = m.esnimei\r\n            LEFT JOIN seriessolicitadas ss ON c.noserie = ss.esnimei\r\n            LEFT JOIN (\r\n                SELECT t.esnimei, t.tiendadestino, t.fecharecepcion\r\n                FROM traspasosdet t\r\n                INNER JOIN (SELECT MAX(idtraspasodet) idtraspaso FROM traspasosdet GROUP BY esnimei) t1\r\n                    ON t.idtraspasodet = t1.idtraspaso\r\n            ) t ON c.noserie = t.esnimei\r\n            INNER JOIN productos p ON c.codigoproducto = p.codigoIUSA\r\n            WHERE p.Clasif='Equipo'\r\n              AND c.tienda = 2\r\n              AND c.clasif = 2\r\n              AND (\r\n                    (v.esnimei IS NULL AND m.esnimei IS NULL AND ss.esnimei IS NULL)\r\n                    OR (ss.idsolicitud = {$idsolicitud})\r\n                  )\r\n              AND (t.esnimei IS NULL OR (t.fecharecepcion IS NOT NULL AND t.fecharecepcion <> '0000-00-00'))\r\n              AND c.noserie = \".q($noserieNuevo).\"\r\n            LIMIT 1\r\n        \";\r\n        $rsExists = db_query($strSQLExists, $conn);\r\n        $okSerie = db_fetch_array($rsExists);\r\n\r\n        if (!$okSerie) {\r\n            $message = \"La serie {$noserieNuevo} ya no está disponible.\";\r\n            // No detenemos el guardado de 'solicitudes'\r\n        } else {\r\n            // Elimina la anterior (si había) y guarda la nueva\r\n            if ($noserieActual !== '') {\r\n                $sqlDel = \"\r\n                    DELETE ss\r\n                    FROM seriessolicitadas ss\r\n                    JOIN compras cp ON cp.noserie = ss.esnimei\r\n                    JOIN productos pr ON pr.codigoIUSA = cp.codigoproducto\r\n                    WHERE ss.idsolicitud = {$idsolicitud}\r\n                      AND pr.clasif = 'Equipo'\r\n                \";\r\n                DB::Exec($sqlDel, $conn);\r\n            }\r\n\r\n            $sqlIns = \"\r\n                INSERT INTO seriessolicitadas (idsolicitud, esnimei)\r\n                VALUES ({$idsolicitud}, \".q($noserieNuevo).\")\r\n                ON DUPLICATE KEY UPDATE esnimei = VALUES(esnimei)\r\n            \";\r\n            if (!DB::Exec($sqlIns, $conn)) {\r\n                $message = \"No se pudo actualizar la serie: \".DB::LastError();\r\n            } else {\r\n                // limpia reserva del usuario si la manejas\r\n                $userId = $_SESSION[\"UserID\"];\r\n                DB::Exec(\"\r\n                    DELETE FROM seriesreservadas\r\n                    WHERE noserie = \".q($noserieNuevo).\"\r\n                      AND userid  = \".q($userId).\"\r\n                \", $conn);\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n// 4) Listo. Deja que PHPRunner haga su UPDATE de 'solicitudes' si hubiera cambios.\r\n//    Aunque no haya cambios, este evento ya guardó extras y serie.\r\nreturn true;\r\n*/\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n// BeforeRecordUpdated - Solicitudes (EDIT)\r\n// Se ejecuta antes de que PHPRunner actualice la tabla 'solicitudes'.\r\n\r\nglobal $conn, $message, $pageObject;\r\n\r\nfunction dbg_log($msg){\r\n    @file_put_contents(getabspath(\"debug_log.txt\"), date('c').\" \".$msg.\"\\n\", FILE_APPEND);\r\n}\r\n\r\n\r\n// ⚠️ IMPORTANTE: Necesitamos el ID del registro que se está editando.\r\n$idsolicitud = (int)$keys['idsolicitud'];\r\n$estatusentrega=(int)($values['estatusentrega']);\r\n\r\n// ==================================================================================\r\n// 1. PREPARACIÓN DE VALORES Y EXTRACCIÓN DE CAMPOS EXTRA\r\n// ==================================================================================\r\n\r\n// Helpers para armar valores seguros\r\nfunction q($v){ // cadenas/fechas: 'valor' o NULL\r\n    return (isset($v) && $v !== '' ? db_prepare_string($v) : \"NULL\");\r\n}\r\nfunction qi($v){ // enteros: número o NULL\r\n    return (isset($v) && $v !== '' ? (int)$v : \"NULL\");\r\n}\r\nfunction qb($v){ // booleano/bit: 0/1\r\n    return (!empty($v) ? 1 : 0);\r\n}\r\nfunction qd($v, $scale = 8) { // decimales: número (formateado) o NULL\r\n    if (!isset($v) || $v === '') return \"NULL\";\r\n    $n = (float)$v;\r\n    return number_format($n, $scale, '.', ''); // sin comillas, usa 8 decimales para Lat/Lng\r\n}\r\n\r\n$camposExtra = [\"nombre\",\"paterno\",\"materno\",\"estado\",\"ciudad\",\"cp\",\"calle\",\"numeroext\",\"numeroint\",\"colonia\", \"noserie\",\"lat\",\"lng\"];\r\n\r\n$extras = [];\r\n// 1. Saca del SET de PHPRunner los campos que no pertenecen a la tabla principal\r\nforeach ($camposExtra as $f) {\r\n    if (array_key_exists($f, $values)) {\r\n        $extras[$f] = $values[$f];\r\n        unset($values[$f]); // <- Evita \"Unknown column 'calle' in SET\"\r\n    }\r\n    // 2. Por si vienen como custom/readonly en POST (ej. los campos de Google Maps)\r\n    $pv = postvalue($f);\r\n    if ($pv !== null && $pv !== '') $extras[$f] = $pv;\r\n}\r\n\r\n// ==================================================================================\r\n// 2. UPSERT en entregasvnp (Dirección y Coordenadas)\r\n// ==================================================================================\r\n\r\n$hayDireccion =\r\n    (!empty($extras['estado']))     || (!empty($extras['ciudad'])) ||\r\n    (!empty($extras['cp']))         || (!empty($extras['calle']))  ||\r\n    (!empty($extras['numeroext']))  || (!empty($extras['colonia']))||\r\n    (isset($extras['lat']))         || (isset($extras['lng']));\r\n\r\nif ($hayDireccion && $idsolicitud > 0) {\r\n    // Normalizamos valores para el SQL\r\n    $estado    = q($extras['estado']    ?? null);\r\n    $ciudad    = q($extras['ciudad']    ?? null);\r\n    $cp        = qi($extras['cp']        ?? null);\r\n    $calle     = q($extras['calle']     ?? null);\r\n    $numeroext = q($extras['numeroext'] ?? null);\r\n    $numeroint = q($extras['numeroint'] ?? null);\r\n    $colonia   = q($extras['colonia']   ?? null);\r\n    $lat       = qd($extras['lat']       ?? null, 8);\r\n    $lng       = qd($extras['lng']       ?? null, 8);\r\n\r\n    // Intentar UPDATE o INSERT (UPSERT)\r\n    $sqlEV = \"\r\n        INSERT INTO entregasvnp\r\n            (idsolicitud, estado, ciudad, cp, calle, numeroext, numeroint, colonia, lat, lng)\r\n        VALUES\r\n            ({$idsolicitud}, {$estado}, {$ciudad}, {$cp}, {$calle}, {$numeroext}, {$numeroint}, {$colonia}, {$lat}, {$lng})\r\n        ON DUPLICATE KEY UPDATE\r\n            estado    = VALUES(estado),\r\n            ciudad    = VALUES(ciudad),\r\n            cp        = VALUES(cp),\r\n            calle     = VALUES(calle),\r\n            numeroext = VALUES(numeroext),\r\n            numeroint = VALUES(numeroint),\r\n            colonia   = VALUES(colonia),\r\n            lat       = VALUES(lat),\r\n            lng       = VALUES(lng)\r\n    \";\r\n\r\n    if (!DB::Exec($sqlEV, $conn)) {\r\n        $message = 'No se pudo actualizar la dirección/coordenadas de entrega: '.DB::LastError();\r\n        // Si falla el extra, detenemos la transacción completa\r\n        return false;\r\n    }\r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n// ---------- 2.5) UPSERT en ventas cuando el estatus general sea CERRADO ----------\r\n\r\n\r\n\r\n// 1) Obtener estatusgral correctamente (texto, no decimal)\r\n$estatusgral = '';\r\n$rsestatusgral = DB::Query(\"SELECT estatusgral FROM estatusentregas WHERE id=\". (int)$estatusentrega);\r\nif ($rsestatusgral) {\r\n    $estatusgral = strtoupper(trim($rsestatusgral->value(\"estatusgral\")));\r\n}\r\n\r\n\r\nif ($estatusgral === 'CERRADO') {\r\n\r\n    // 2) Normalizar valores (usa tus helpers q/qi/qd)\r\n    $idsolicitud    = (int)$idsolicitud;\r\n\r\n    $idtipoventa    = qi($values['idtipoventa']   ?? null);\r\n    $fecha          = q(date(\"Y-m-d\"));                          // fecha de venta hoy\r\n    $idcliente      = qi($values['idcliente']     ?? null);\r\n\r\n    // ojo: en tu app el plan suele ser idplan\r\n    $plan           = qi($values['idplan']        ?? null);\r\n    $plazo          = qi($values['plazo']         ?? null);\r\n\r\n    $esnimei        = q(trim($extras['noserie']   ?? ''));        // serie del equipo\r\n    $usuario        = q($_SESSION[\"UserID\"]       ?? null);\r\n    $tienda         = qi($_SESSION[\"Tienda\"]      ?? 0);\r\n\r\n    $dn             = q($values['dn']             ?? null);\r\n    $dnpreferido    = q($values['dnpreferido']    ?? null);\r\n    $cuenta         = q($values['cuenta']         ?? null);\r\n    $contrato       = q($values['contrato']       ?? null);\r\n    $contratoportal = q($values['contratoportal'] ?? null);\r\n    $plazopendiente = qi($values['plazopendiente']?? null);\r\n    $factura        = q($values['factura']        ?? null);\r\n    $fechavenci     = q($values['fechavenci']     ?? null);\r\n    $ciclo          = qi($values['ciclo']         ?? null);\r\n\r\n    $ventadomicilio = 1;\r\n    $equipoincluido = 1;\r\n\r\n    // 3) Obtener la renta del plan\r\n    //    (si plan es NULL, renta también será NULL)\r\n    $renta = \"NULL\";\r\n    if ($plan !== \"NULL\") {\r\n        $rsplanes = DB::Query(\"SELECT renta FROM planes WHERE idplan={$plan}\");\r\n        if ($rsplanes) {\r\n            $renta = qd($rsplanes->value(\"renta\"), 2); // decimal con 2 decimales\r\n        }\r\n    }\r\n\r\n    // 4) UPSERT con ON DUPLICATE KEY (idsolicitud debe ser UNIQUE en ventas)\r\n    $sqlEV = \"\r\n        INSERT INTO ventas\r\n            (idsolicitud, idtipoventa, fecha, idcliente, esnimei, plan, plazo, usuario, tienda, ventadomicilio, equipoincluido, renta,\r\n             dn, dnpreferido, cuenta, contrato, contratoportal, plazopendiente, factura, fechavenci, ciclo)\r\n        VALUES\r\n            ({$idsolicitud}, {$idtipoventa}, {$fecha}, {$idcliente}, {$esnimei}, {$plan}, {$plazo}, {$usuario}, {$tienda}, {$ventadomicilio}, {$equipoincluido}, {$renta},\r\n             {$dn}, {$dnpreferido}, {$cuenta}, {$contrato}, {$contratoportal}, {$plazopendiente}, {$factura}, {$fechavenci}, {$ciclo})\r\n        ON DUPLICATE KEY UPDATE\r\n            idtipoventa=VALUES(idtipoventa),\r\n            fecha=VALUES(fecha),\r\n            idcliente=VALUES(idcliente),\r\n            esnimei=VALUES(esnimei),\r\n            plan=VALUES(plan),\r\n            plazo=VALUES(plazo),\r\n            usuario=VALUES(usuario),\r\n            tienda=VALUES(tienda),\r\n            ventadomicilio=VALUES(ventadomicilio),\r\n            equipoincluido=VALUES(equipoincluido),\r\n            renta=VALUES(renta),\r\n            dn=VALUES(dn),\r\n            dnpreferido=VALUES(dnpreferido),\r\n            cuenta=VALUES(cuenta),\r\n            contrato=VALUES(contrato),\r\n            contratoportal=VALUES(contratoportal),\r\n            plazopendiente=VALUES(plazopendiente),\r\n            factura=VALUES(factura),\r\n            fechavenci=VALUES(fechavenci),\r\n            ciclo=VALUES(ciclo)\r\n    \";\r\n\r\n\r\n\r\nif (!DB::Exec($sqlEV, $conn)) {\r\n    $err = DB::LastError();\r\n    $error_msg_js = 'No se pudo guardar la venta: '. str_replace([\"'\", \"\\n\", \"\\r\"], [\"\\'\", \" \", \" \"], $err);\r\n    \r\n    // 1. INYECTAR SCRIPT NO BLOQUEANTE EN LUGAR DE ALERT\r\n    // Este script fuerza la visibilidad del bloque de mensajes estándar.\r\n    echo '<script>\r\n        $(document).ready(function() {\r\n            var msgBlock = $(\"#message_block\");\r\n            if (msgBlock.length) {\r\n                // Asegura que el bloque HTML esté visible y el contenido no esté oculto\r\n                msgBlock.show();\r\n                msgBlock.find(\".alert\").removeClass(\"hide\").show();\r\n                // Opcional: Desplazarse al mensaje si no es un popup\r\n                // if (!window.parent.Runner.isPopup) {\r\n                //     $(\"html, body\").animate({ scrollTop: msgBlock.offset().top - 20 }, 500);\r\n                // }\r\n            }\r\n        });\r\n    </script>';\r\n\r\n    // 2. Asignar la variable global $message para que PHPRunner devuelva el error en el AJAX\r\n    $message = 'No se pudo guardar la venta: '.$err;\r\n    dbg_log(\"Error en UPSERT ventas SQL: \".$err);\r\n    \r\n    // 3. Establecer el mensaje en el pageObject (para algunos skins/modos)\r\n    global $pageObject;\r\n    if (isset($pageObject) && method_exists($pageObject, 'setMessage')) {\r\n        $pageObject->setMessage($message);\r\n    }\r\n    \r\n    return false; \r\n} else {\r\n    $ok = \"✅ Venta/solicitud actualizada correctamente.\";\r\n\r\n    // opcional mostrar también en no-popup\r\n    $pageObject->setMessage($ok);\r\n\r\n\r\n}\r\n    \r\n}\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n// ==================================================================================\r\n// 3. ACTUALIZACIÓN en seriessolicitadas (noserie)\r\n// ==================================================================================\r\n\r\n$noserieNuevo = trim($extras['noserie'] ?? '');\r\n\r\nif ($idsolicitud > 0) {\r\n    // 3.1) Obtener la serie actual de la base de datos\r\n    $sqlSerieActual = \"\r\n        SELECT ss.esnimei\r\n        FROM seriessolicitadas ss\r\n        JOIN compras cp  ON cp.noserie = ss.esnimei\r\n        JOIN productos pr ON pr.codigoIUSA = cp.codigoproducto\r\n        WHERE ss.idsolicitud = {$idsolicitud}\r\n          AND pr.clasif = 'Equipo'\r\n        LIMIT 1\r\n    \";\r\n    $rs = db_query($sqlSerieActual, $conn);\r\n    $row = db_fetch_array($rs);\r\n    $noserieActual = $row ? trim($row['esnimei']) : '';\r\n    \r\n    // 3.2) Solo proceder si la serie ha cambiado o si no había y se está agregando\r\n    if ($noserieNuevo !== $noserieActual && $noserieNuevo !== '') {\r\n        \r\n        // 3.3) Validar la disponibilidad del nuevo noserie (misma lógica de tu ADD)\r\n        $strSQLExists = \"\r\n            SELECT c.noserie\r\n            FROM compras c\r\n            LEFT JOIN ventas v           ON c.noserie = v.esnimei\r\n            LEFT JOIN movimientos m      ON c.noserie = m.esnimei\r\n            LEFT JOIN seriessolicitadas ss ON c.noserie = ss.esnimei AND ss.idsolicitud <> {$idsolicitud} -- Excluir otras solicitudes\r\n            INNER JOIN productos p ON c.codigoproducto = p.codigoIUSA\r\n            WHERE p.Clasif='Equipo'\r\n              AND c.tienda = 2\r\n              AND c.clasif = 2\r\n              AND (v.esnimei IS NULL AND m.esnimei IS NULL AND ss.esnimei IS NULL) -- Disponible (no vendido/movido/reservado por otro)\r\n              AND c.noserie = \".q($noserieNuevo).\"\r\n            LIMIT 1\r\n        \";\r\n        // NOTA: Si necesitas validar traspasos, usa tu SQL completo. Simplificado aquí para el ejemplo.\r\n        \r\n        $rsExists = db_query($strSQLExists, $conn);\r\n        $okSerie = db_fetch_array($rsExists);\r\n\r\n        if (!$okSerie) {\r\n            $message = \"La serie {$noserieNuevo} ya no está disponible o está ligada a otra solicitud.\";\r\n            return false;\r\n        }\r\n        \r\n        // 3.4) ELIMINAR la serie anterior (Equipo) si existía\r\n        if ($noserieActual !== '') {\r\n            $sqlDel = \"\r\n                DELETE ss\r\n                FROM seriessolicitadas ss\r\n                JOIN compras cp ON cp.noserie = ss.esnimei\r\n                JOIN productos pr ON pr.codigoIUSA = cp.codigoproducto\r\n                WHERE ss.idsolicitud = {$idsolicitud}\r\n                  AND pr.clasif = 'Equipo'\r\n            \";\r\n            DB::Exec($sqlDel, $conn);\r\n        }\r\n\r\n        // 3.5) INSERTAR la nueva serie\r\n        $sqlIns = \"\r\n            INSERT INTO seriessolicitadas (idsolicitud, esnimei)\r\n            VALUES ({$idsolicitud}, \".q($noserieNuevo).\")\r\n            ON DUPLICATE KEY UPDATE esnimei = VALUES(esnimei)\r\n        \";\r\n        // ... Sección de seriessolicitadas\r\n        if (!DB::Exec($sqlIns, $conn)) {\r\n            $err = DB::LastError();\r\n            \r\n            // 1. Asignar el mensaje\r\n            $message = \"No se pudo actualizar la serie: \" . $err;\r\n \r\n            // 2. Forzar Visibilidad (Mismo script no bloqueante que ya funciona)\r\n            $error_msg_js = str_replace([\"\\\\\", \"'\", \"\\n\", \"\\r\"], [\"\\\\\\\\\", \"\\'\", \" \", \" \"], $message);\r\n            echo '<script>\r\n                $(document).ready(function() {\r\n                    // ... código para mostrar #message_block o Runner.displayPopupMessage\r\n                });\r\n            </script>';\r\n        \r\n            // 3. Detener\r\n            return false; \r\n        } else {\r\n            // Limpia reserva si la manejas\r\n            $userId = $_SESSION[\"UserID\"];\r\n            DB::Exec(\"\r\n                DELETE FROM seriesreservadas\r\n                WHERE noserie = \".q($noserieNuevo).\"\r\n                  AND userid  = \".q($userId).\"\r\n            \", $conn);\r\n        }\r\n    }\r\n}\r\n\r\n\r\n// ==================================================================================\r\n// 4. ÉXITO FINAL\r\n// ==================================================================================\r\n\r\n// Deja que PHPRunner haga el UPDATE de la tabla 'solicitudes'\r\n// Si llegamos aquí, las tablas secundarias se actualizaron correctamente.\r\nreturn true;\r\n\r\n\r\n\r\n\r\n"
		},
		{
			"eventId": "EVENT_BEFOREPROCESSROW_LIST",
			"pageType": "list",
			"code": "/*\n$params = [];\n$i = 1;\nforeach( $pageObject->pSet->getTableKeys() as $pk ){\n  $params[] = \"editid\".$i.\"=\".rawurlencode($data[$pk]);\n  $i++;\n}\n$q = implode(\"&\", $params);\n\n// Decide en servidor\n$userId  = isset($_SESSION['UserID']) ? strtoupper((string)$_SESSION['UserID']) : '';\n$isAdmin = ($userId === 'ADMIN');\n\n$dest = GetTableLink(\"solicitudes\", $isAdmin ? \"edit1\" : \"edit\") . \"?\" . $q;\n\n// Edit no-popup: usa href (también seteo data-href por si el tema lo usa)\n$attr = 'href=\"'.runner_htmlspecialchars($dest).'\" data-href=\"'.runner_htmlspecialchars($dest).'\" class=\"rnr-editlink\"';\n$record[\"editlink_attrs\"]       = $attr;\n$record[\"editlink_attrs_icon\"]  = $attr;   // si el tema muestra icono aparte\n$record[\"editlink_button_attrs\"]= $attr;   // por si renderiza un botón\n*/"
		},
		{
			"eventId": "EVENT_BEFORESHOW_LIST",
			"pageType": "list",
			"code": "// Place event code here.\n// Use \"Add Action\" button to add code snippets.\n\n// Detecta ADMIN y otras banderas servidor-side\n// Detecta ADMIN y otras banderas servidor-side\n// --- Reglas de acceso ---\n$userId      = isset($_SESSION['UserID']) ? strtoupper((string)$_SESSION['UserID']) : '';\n$isAdmin     = ($userId === 'ADMIN');\n$isValidador = (isset($_SESSION['Label'])  && $_SESSION['Label'] === 'VALIDADOR');\n$hasAcceso   = (isset($_SESSION['Acceso']) && intval($_SESSION['Acceso']) === 1);\n\n$role = $_SESSION['Label'];\n\n$pageObject->setProxyValue(\"currentRole\", $role);\n$pageObject->setProxyValue(\"currentUser\", $userId);\n// Cambia la condición a tu gusto:\n$allowLogistic =  $isAdmin || ($isValidador && $hasAcceso);\n\n// IMPORTANTE: usa el *itemid* real del botón en el diseñador (Builder).\n// Te recomiendo renombrarlo a \"logistic_btn\". Si en tu HTML ves data-itemid=\"custom_button\",\n// entonces cambia \"logistic_btn\" por \"custom_button\".\nif (!$allowLogistic) {\n  //  $pageObject->hideItem(\"logistic_btn\");   // oculta la columna/botón para ese usuario\n} else {\n    // lo exponemos por si quieres usarlo del lado cliente (opcional)\n    $pageObject->setProxyValue(\"allowLogistic\", true);\n}\n\n\n\n"
		},
		{
			"eventId": "EVENT_BEFOREPROCESS_EDIT",
			"pageType": "edit",
			"code": "// BeforeProcessEdit — tabla: solicitudes\nglobal $pageObject;\n$_SESSION[\"Modulo\"]=1;\n// ¿Debo limpiar (entrada limpia o tras éxito)?\n$shouldClean =\n    isset($_SESSION['solicitudes_edit_clean_draft']) ||\n    (isset($_GET['clean']) && $_GET['clean'] === '1') ||\n    ($_SERVER['REQUEST_METHOD'] === 'GET'); // entrando por liga\n\nif ($shouldClean) {\n    // Cabeceras anti-caché / anti-BFCache\n    @header(\"Cache-Control: no-store, no-cache, must-revalidate, max-age=0\");\n    @header(\"Pragma: no-cache\");\n    @header(\"Expires: 0\");\n\n    // Señales para el JS\n    $pageObject->header =\n        \"<script>\n           window.EDIT_CLEAN_ON_LOAD = true;\n           window.EDIT_SKIP_RECOVERY = true;\n         </script>\" . ($pageObject->header ?? '');\n\n    unset($_SESSION['solicitudes_edit_clean_draft']); // consumir bandera\n}\n\n// Limpia basuras de sesiones previas\nforeach (['edit_data_temp','multistep_vars_solicitudes','solicitudes_edit'] as $k) {\n    if (isset($_SESSION[$k])) unset($_SESSION[$k]);\n}\n\n\nreturn true;\n\n"
		},
		{
			"eventId": "EVENT_BEFOREPROCESS_LIST",
			"pageType": "list",
			"code": "\t$_SESSION[\"Modulo\"]=1;\n\n"
		},
		{
			"eventId": "EVENT_JS_ONLOAD",
			"pageType": "add",
			"code": "// ====================== CONFIG ======================\nwindow.STORAGE_KEY   = 'solicitud_vnp_draft';\nwindow.ENDPOINT      = 'serial_reserve.php';        // reserva/libera series\nwindow.API_SAVE      = 'solicitud_save_api.php';    // guarda solicitud vía API\n\nwindow.FIELDS = [\n  'idcliente','idproducto','idtipoventa','idplan','orden','plazo','rfc','idcli',\n  'estado','ciudad','colonia','calle','numeroext','numeroint','noserie','cp',\n  'dn','cuenta','contrato','contratoportal','plazopendiente','dnpreferido',\n  'factura','fechavenci'\n];\n\nwindow.__recovering  = false;\nwindow.__res_noserie = null;\nwindow.__saving      = false;\n\nvar DRAFT_TTL = 2 * 60 * 60 * 1000; // 2 horas\n\n// ====================== CARGAR SWEETALERT2 (si no existe) ======================\n(function ensureSwal(){\n  if (typeof Swal !== 'undefined') return;\n  var s = document.createElement('script');\n  s.src = \"https://cdn.jsdelivr.net/npm/sweetalert2@11\";\n  s.async = true;\n  document.head.appendChild(s);\n})();\n\n// ====================== HELPERS BÁSICOS ======================\nfunction getPid(){\n  return $('[data-pageid]').first().attr('data-pageid') || '';\n}\n\nfunction getCtrl(f){\n  try { return Runner.getControl(getPid(), f); } catch(e){ return null; }\n}\n\nfunction readVal(f){\n  var c = getCtrl(f);\n  if (c && typeof c.getValue === 'function') return c.getValue();\n  var pid = getPid();\n  var $el = $('#value_'+f+'_'+pid);\n  return $el.length ? $el.val() : '';\n}\n\nfunction setVal(f,v,fire){\n  var c = getCtrl(f);\n  if (c && typeof c.setControlValue === 'function') {\n    c.setControlValue(v);\n    if (fire && typeof c.fireEvent === 'function') c.fireEvent('change');\n    return;\n  }\n  var pid = getPid();\n  var $el = $('#value_'+f+'_'+pid);\n  if ($el.length){\n    $el.val(v);\n    if (fire) $el.trigger('change');\n  }\n}\n\nfunction log(){\n  if (window.console && console.log) console.log.apply(console, arguments);\n}\n\n// ====================== SWEETALERT WRAPPERS ======================\nfunction showSuccess(msg, cb){\n  if (typeof Swal !== 'undefined') {\n    Swal.fire({\n      title: 'Guardado correctamente',\n      text: msg || '',\n      icon: 'success',\n      confirmButtonText: 'Aceptar',\n      timer: 2200,\n      timerProgressBar: true\n    }).then(function(){\n      if (typeof cb === 'function') cb();\n    });\n  } else {\n    alert(msg || 'Guardado correctamente.');\n    if (typeof cb === 'function') cb();\n  }\n}\n\nfunction showError(msg){\n  if (typeof Swal !== 'undefined') {\n    Swal.fire({\n      title: 'Error',\n      text: msg || 'Ocurrió un error.',\n      icon: 'error',\n      confirmButtonText: 'Aceptar'\n    });\n  } else {\n    alert(msg || 'Ocurrió un error.');\n  }\n}\n\n// ====================== AUTOSAVE ======================\nfunction buildDraft(){\n  var d = {};\n  (window.FIELDS || []).forEach(function(f){\n    var v = readVal(f);\n    if (v !== null && v !== undefined && v !== '') d[f] = v;\n  });\n  d.timestamp = Date.now();\n  return d;\n}\n\nfunction saveDraft(){\n  if (window.__recovering) return;\n  try {\n    var d = buildDraft();\n    sessionStorage.setItem(window.STORAGE_KEY, JSON.stringify(d));\n  } catch(e){\n    log('Error saveDraft', e);\n  }\n}\n\nfunction recoverDraft(){\n  var raw = sessionStorage.getItem(window.STORAGE_KEY);\n  if (!raw) return;\n  try {\n    var d = JSON.parse(raw);\n    if (!d.timestamp || (Date.now() - d.timestamp) > DRAFT_TTL) {\n      sessionStorage.removeItem(window.STORAGE_KEY);\n      return;\n    }\n    window.__recovering = true;\n    log('Draft encontrado', d);\n\n    if (d.idproducto){\n      setVal('idproducto', d.idproducto, true);\n      setTimeout(function(){\n        Object.keys(d).forEach(function(k){\n          if (k !== 'timestamp' && k !== 'idproducto') setVal(k, d[k], false);\n        });\n        window.__recovering = false;\n      }, 300);\n    } else {\n      Object.keys(d).forEach(function(k){\n        if (k !== 'timestamp') setVal(k, d[k], false);\n      });\n      window.__recovering = false;\n    }\n  } catch(e){\n    log('Draft inválido', e);\n  }\n  sessionStorage.removeItem(window.STORAGE_KEY);\n}\n\n// ====================== RESERVAS (serial_reserve.php) ======================\nfunction releasePrev(){\n  if (!window.__res_noserie) return;\n  log('Liberando reserva previa', window.__res_noserie);\n  $.post(window.ENDPOINT, { action:'release', noserie: window.__res_noserie });\n  window.__res_noserie = null;\n}\n\nfunction reserveForProduct(productId){\n  if (!productId || window.__recovering) return;\n  log('Reservando serie para producto', productId);\n\n  releasePrev();\n  setVal('noserie','',true);\n\n  $.post(window.ENDPOINT, { action:'reserve_by_product', product_id: productId })\n    .done(function(resp){\n      var r = (typeof resp === 'object')\n        ? resp\n        : (function(){ try {return JSON.parse(resp);}catch(e){return null;} })();\n      log('Respuesta reserva', r);\n\n      if (r && r.ok && r.noserie) {\n        window.__res_noserie = r.noserie;\n        setVal('noserie', r.noserie, true);\n        saveDraft();\n      } else if (r && r.error === 'no-stock') {\n        showError('No hay series disponibles para este producto.');\n        setVal('idproducto','',true);\n      } else {\n        showError('No se pudo reservar la serie.');\n        setVal('idproducto','',true);\n      }\n    })\n    .fail(function(){\n      showError('Error de comunicación al reservar la serie.');\n      setVal('idproducto','',true);\n    });\n}\n\n// ====================== CLEAN FORM (usamos RECARGA) ======================\nfunction cleanAfterSuccess(){\n  // Libera serie reservada si existe\n  if (window.__res_noserie) {\n    $.post(window.ENDPOINT, { action:'release', noserie: window.__res_noserie });\n    window.__res_noserie = null;\n  }\n\n  try { sessionStorage.removeItem(window.STORAGE_KEY); } catch(e){}\n\n  // Recargamos con clean=1 para garantizar formulario fresco\n  var url = window.location.pathname + '?new=1&clean=1&_t=' + Date.now();\n  window.location.href = url;\n}\n\n// ====================== API SAVE (solicitud_save_api.php) ======================\nfunction sendToAPI(){\n  if (window.__saving) return;\n  window.__saving = true;\n\n  var datos = {};\n  (window.FIELDS || []).forEach(function(f){\n    datos[f] = readVal(f);\n  });\n\n  log('Payload a API_SAVE:', datos);\n\n  $.post(window.API_SAVE, datos, function(respRaw){\n    var r = (typeof respRaw === 'object')\n      ? respRaw\n      : (function(){ try { return JSON.parse(respRaw); } catch(e){ return null; } })();\n\n    log('Respuesta API_SAVE:', r || respRaw);\n\n    if (!r) {\n      showError('Respuesta inválida del servidor.');\n      window.__saving = false;\n      return;\n    }\n\n    var ok = (r.ok === true || r.ok === 1 || r.ok === \"1\" || r.ok === \"ok\" || r.ok === \"OK\");\n\n    if (ok) {\n      var msg = r.message || 'Solicitud guardada correctamente.';\n      showSuccess(msg, function(){\n        cleanAfterSuccess();\n      });\n    } else {\n      showError(r.error || 'Error desconocido al guardar.');\n    }\n\n    window.__saving = false;\n  })\n  .fail(function(xhr){\n    log('Fallo AJAX API_SAVE:', xhr.status, xhr.responseText);\n    showError('Error de comunicación con el servidor.');\n    window.__saving = false;\n  });\n}\n\n// ====================== INIT ======================\n$(function(){\n  var pid      = getPid();\n  var ctrlProd = getCtrl('idproducto');\n\n  log('INIT solicitudes_add pid=', pid, 'ctrlProd=', !!ctrlProd);\n\n  // 1) Recuperar borrador si existe\n  recoverDraft();\n\n  // 2) Autosave en cambios\n  var sel = (window.FIELDS || []).map(function(f){\n    return \"[data-field='\"+f+\"'][data-pageid='\"+pid+\"'] input,\" +\n           \"[data-field='\"+f+\"'][data-pageid='\"+pid+\"'] select,\" +\n           \"[data-field='\"+f+\"'][data-pageid='\"+pid+\"'] textarea\";\n  }).join(',');\n  if (sel) {\n    $(document).on('input change', sel, function(){\n      saveDraft();\n    });\n  }\n\n  // 3) Reserva automática al cambiar producto\n  if (ctrlProd) {\n    ctrlProd.on('change', function(){\n      if (window.__recovering) return;\n      var v = ctrlProd.getValue();\n      log('Cambio de idproducto =>', v);\n      if (v) reserveForProduct(v);\n    });\n  }\n\n  // 4) Botón personalizado \"Guardar VNP\"\n  var saveSelector =\n    \"[data-itemid='btnGuardarVNP'] a, \" +\n    \"[data-itemid='btnGuardarVNP'] button, \" +\n    \"#btnGuardarVNP\";\n\n  $(document).on('click', saveSelector, function(e){\n    e.preventDefault();\n    log('Click en botón VNP detectado');\n    sendToAPI();\n  });\n\n  // 5) Bloquear submit clásico\n  $('form').on('submit', function(e){\n    e.preventDefault();\n    return false;\n  });\n\n  // 6) Liberar reserva al salir si no se está guardando\n  $(window).on('beforeunload pagehide', function(){\n    if (!window.__saving) {\n      releasePrev();\n      saveDraft();\n    }\n  });\n});\n\n\n"
		}
	],
	"dbTableInfo": {
		"type": 0,
		"foreignKeys": [],
		"fields": [
			{
				"name": "idsolicitud",
				"type": 20,
				"size": 20,
				"scale": 0,
				"typeName": "bigint(20)",
				"nullable": false,
				"autoinc": true,
				"defaultValueSQL": null,
				"defaultValue": ""
			},
			{
				"name": "idtipoventa",
				"type": 3,
				"size": 11,
				"scale": 0,
				"typeName": "int(11)",
				"nullable": false,
				"autoinc": false,
				"defaultValueSQL": "0",
				"defaultValue": "0"
			},
			{
				"name": "fecha",
				"type": 7,
				"size": 0,
				"scale": 0,
				"typeName": "date",
				"nullable": true,
				"autoinc": false,
				"defaultValueSQL": null,
				"defaultValue": ""
			},
			{
				"name": "fechacaptura",
				"type": 135,
				"size": 0,
				"scale": 0,
				"typeName": "datetime",
				"nullable": true,
				"autoinc": false,
				"defaultValueSQL": "current_timestamp()",
				"defaultValue": "CURRENT_TIMESTAMP"
			},
			{
				"name": "idcliente",
				"type": 3,
				"size": 11,
				"scale": 0,
				"typeName": "int(11)",
				"nullable": true,
				"autoinc": false,
				"defaultValueSQL": null,
				"defaultValue": ""
			},
			{
				"name": "idproducto",
				"type": 3,
				"size": 11,
				"scale": 0,
				"typeName": "int(11)",
				"nullable": true,
				"autoinc": false,
				"defaultValueSQL": null,
				"defaultValue": ""
			},
			{
				"name": "idplan",
				"type": 3,
				"size": 11,
				"scale": 0,
				"typeName": "int(11)",
				"nullable": true,
				"autoinc": false,
				"defaultValueSQL": null,
				"defaultValue": ""
			},
			{
				"name": "usuario",
				"type": 200,
				"size": 20,
				"scale": 0,
				"typeName": "varchar(20)",
				"nullable": true,
				"autoinc": false,
				"defaultValueSQL": null,
				"defaultValue": ""
			},
			{
				"name": "idtienda",
				"type": 3,
				"size": 3,
				"scale": 0,
				"typeName": "int(3)",
				"nullable": true,
				"autoinc": false,
				"defaultValueSQL": null,
				"defaultValue": ""
			},
			{
				"name": "fechamodif",
				"type": 135,
				"size": 0,
				"scale": 0,
				"typeName": "datetime",
				"nullable": true,
				"autoinc": false,
				"defaultValueSQL": "current_timestamp()",
				"defaultValue": "CURRENT_TIMESTAMP"
			},
			{
				"name": "orden",
				"type": 200,
				"size": 11,
				"scale": 0,
				"typeName": "varchar(11)",
				"nullable": true,
				"autoinc": false,
				"defaultValueSQL": null,
				"defaultValue": ""
			},
			{
				"name": "solicitudimg",
				"type": 201,
				"size": 0,
				"scale": 0,
				"typeName": "mediumtext",
				"nullable": true,
				"autoinc": false,
				"defaultValueSQL": null,
				"defaultValue": ""
			},
			{
				"name": "estatus",
				"type": 200,
				"size": 20,
				"scale": 0,
				"typeName": "varchar(20)",
				"nullable": true,
				"autoinc": false,
				"defaultValueSQL": null,
				"defaultValue": ""
			},
			{
				"name": "idsolrazon",
				"type": 3,
				"size": 11,
				"scale": 0,
				"typeName": "int(11)",
				"nullable": true,
				"autoinc": false,
				"defaultValueSQL": null,
				"defaultValue": ""
			},
			{
				"name": "importeatt",
				"type": 5,
				"size": 0,
				"scale": 0,
				"typeName": "float",
				"nullable": true,
				"autoinc": false,
				"defaultValueSQL": null,
				"defaultValue": ""
			},
			{
				"name": "importesms",
				"type": 5,
				"size": 0,
				"scale": 0,
				"typeName": "float",
				"nullable": true,
				"autoinc": false,
				"defaultValueSQL": null,
				"defaultValue": ""
			},
			{
				"name": "plazo",
				"type": 2,
				"size": 6,
				"scale": 0,
				"typeName": "smallint(6)",
				"nullable": true,
				"autoinc": false,
				"defaultValueSQL": null,
				"defaultValue": ""
			},
			{
				"name": "observaciones",
				"type": 200,
				"size": 200,
				"scale": 0,
				"typeName": "varchar(200)",
				"nullable": true,
				"autoinc": false,
				"defaultValueSQL": null,
				"defaultValue": ""
			},
			{
				"name": "equipoincluido",
				"type": 16,
				"size": 1,
				"scale": 0,
				"typeName": "tinyint(1)",
				"nullable": true,
				"autoinc": false,
				"defaultValueSQL": null,
				"defaultValue": ""
			},
			{
				"name": "rfc",
				"type": 200,
				"size": 20,
				"scale": 0,
				"typeName": "varchar(20)",
				"nullable": true,
				"autoinc": false,
				"defaultValueSQL": null,
				"defaultValue": ""
			},
			{
				"name": "idtratamiento",
				"type": 3,
				"size": 2,
				"scale": 0,
				"typeName": "int(2)",
				"nullable": true,
				"autoinc": false,
				"defaultValueSQL": null,
				"defaultValue": ""
			},
			{
				"name": "riesgo",
				"type": 200,
				"size": 1,
				"scale": 0,
				"typeName": "char(1)",
				"nullable": true,
				"autoinc": false,
				"defaultValueSQL": null,
				"defaultValue": ""
			},
			{
				"name": "observacionest",
				"type": 200,
				"size": 200,
				"scale": 0,
				"typeName": "varchar(200)",
				"nullable": true,
				"autoinc": false,
				"defaultValueSQL": null,
				"defaultValue": ""
			},
			{
				"name": "idcli",
				"type": 200,
				"size": 9,
				"scale": 0,
				"typeName": "varchar(9)",
				"nullable": true,
				"autoinc": false,
				"defaultValueSQL": null,
				"defaultValue": ""
			},
			{
				"name": "fecha1avta",
				"type": 7,
				"size": 0,
				"scale": 0,
				"typeName": "date",
				"nullable": true,
				"autoinc": false,
				"defaultValueSQL": null,
				"defaultValue": ""
			},
			{
				"name": "idplan1avta",
				"type": 3,
				"size": 11,
				"scale": 0,
				"typeName": "int(11)",
				"nullable": true,
				"autoinc": false,
				"defaultValueSQL": null,
				"defaultValue": ""
			},
			{
				"name": "dn1avta",
				"type": 200,
				"size": 10,
				"scale": 0,
				"typeName": "varchar(10)",
				"nullable": true,
				"autoinc": false,
				"defaultValueSQL": null,
				"defaultValue": ""
			},
			{
				"name": "idproceso",
				"type": 16,
				"size": 2,
				"scale": 0,
				"typeName": "tinyint(2)",
				"nullable": true,
				"autoinc": false,
				"defaultValueSQL": null,
				"defaultValue": ""
			},
			{
				"name": "idorigenventa",
				"type": 3,
				"size": 11,
				"scale": 0,
				"typeName": "int(11)",
				"nullable": true,
				"autoinc": false,
				"defaultValueSQL": null,
				"defaultValue": ""
			},
			{
				"name": "estatusentrega",
				"type": 3,
				"size": 11,
				"scale": 0,
				"typeName": "int(11)",
				"nullable": true,
				"autoinc": false,
				"defaultValueSQL": null,
				"defaultValue": ""
			},
			{
				"name": "dn",
				"type": 200,
				"size": 10,
				"scale": 0,
				"typeName": "varchar(10)",
				"nullable": true,
				"autoinc": false,
				"defaultValueSQL": null,
				"defaultValue": ""
			},
			{
				"name": "cuenta",
				"type": 200,
				"size": 50,
				"scale": 0,
				"typeName": "varchar(50)",
				"nullable": true,
				"autoinc": false,
				"defaultValueSQL": null,
				"defaultValue": ""
			},
			{
				"name": "contrato",
				"type": 200,
				"size": 11,
				"scale": 0,
				"typeName": "varchar(11)",
				"nullable": true,
				"autoinc": false,
				"defaultValueSQL": null,
				"defaultValue": ""
			},
			{
				"name": "contratoportal",
				"type": 200,
				"size": 11,
				"scale": 0,
				"typeName": "varchar(11)",
				"nullable": true,
				"autoinc": false,
				"defaultValueSQL": null,
				"defaultValue": ""
			},
			{
				"name": "plan",
				"type": 3,
				"size": 11,
				"scale": 0,
				"typeName": "int(11)",
				"nullable": true,
				"autoinc": false,
				"defaultValueSQL": null,
				"defaultValue": ""
			},
			{
				"name": "renta",
				"type": 14,
				"size": 10,
				"scale": 2,
				"typeName": "decimal(10,2)",
				"nullable": true,
				"autoinc": false,
				"defaultValueSQL": null,
				"defaultValue": ""
			},
			{
				"name": "plazopendiente",
				"type": 2,
				"size": 6,
				"scale": 0,
				"typeName": "smallint(6)",
				"nullable": true,
				"autoinc": false,
				"defaultValueSQL": null,
				"defaultValue": ""
			},
			{
				"name": "dnpreferido",
				"type": 200,
				"size": 10,
				"scale": 0,
				"typeName": "varchar(10)",
				"nullable": true,
				"autoinc": false,
				"defaultValueSQL": null,
				"defaultValue": ""
			},
			{
				"name": "Factura",
				"type": 200,
				"size": 18,
				"scale": 0,
				"typeName": "varchar(18)",
				"nullable": true,
				"autoinc": false,
				"defaultValueSQL": null,
				"defaultValue": ""
			},
			{
				"name": "fechavenci",
				"type": 7,
				"size": 0,
				"scale": 0,
				"typeName": "date",
				"nullable": true,
				"autoinc": false,
				"defaultValueSQL": null,
				"defaultValue": ""
			},
			{
				"name": "ciclo",
				"type": 3,
				"size": 2,
				"scale": 0,
				"typeName": "int(2)",
				"nullable": true,
				"autoinc": false,
				"defaultValueSQL": null,
				"defaultValue": ""
			},
			{
				"name": "idcita",
				"type": 3,
				"size": 11,
				"scale": 0,
				"typeName": "int(11)",
				"nullable": true,
				"autoinc": false,
				"defaultValueSQL": null,
				"defaultValue": ""
			}
		],
		"primaryKeys": [
			"idsolicitud"
		],
		"uniqueFields": [],
		"name": "solicitudes"
	},
	"pages": [
		{
			"id": "add",
			"type": "add",
			"layoutId": "nomenu",
			"disabled": false,
			"default": 1,
			"forms": {
				"above-grid": {
					"modelId": "add-above-grid",
					"grid": [
						{
							"cells": [
								{
									"cell": "c1"
								}
							],
							"section": ""
						},
						{
							"cells": [
								{
									"cell": "c2"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c1": {
							"model": "c1",
							"items": [
								"add_message"
							]
						},
						"c2": {
							"model": "c2",
							"items": []
						}
					},
					"deferredItems": [],
					"recsPerRow": 1
				},
				"below-grid": {
					"modelId": "add-below-grid",
					"grid": [
						{
							"cells": [
								{
									"cell": "c1"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c1": {
							"model": "c1",
							"items": [
								"text1",
								"add_save",
								"add_reset",
								"add_back_list",
								"add_cancel"
							]
						}
					},
					"deferredItems": [],
					"recsPerRow": 1
				},
				"top": {
					"modelId": "add-header",
					"grid": [
						{
							"cells": [
								{
									"cell": "c1"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c1": {
							"model": "c1",
							"items": [
								"image",
								"add_header"
							]
						}
					},
					"deferredItems": [],
					"recsPerRow": 1
				},
				"grid": {
					"modelId": "simple-edit",
					"grid": [
						{
							"cells": [
								{
									"cell": "c4",
									"colspan": 1
								}
							],
							"section": ""
						},
						{
							"section": "",
							"cells": [
								{
									"cell": "c9",
									"rowspan": 1
								}
							]
						},
						{
							"section": "",
							"cells": [
								{
									"cell": "c",
									"colspan": 1
								}
							]
						},
						{
							"section": "",
							"cells": [
								{
									"cell": "c1",
									"colspan": 1
								}
							]
						},
						{
							"cells": [
								{
									"cell": "c8",
									"colspan": 1
								}
							],
							"section": ""
						},
						{
							"section": "",
							"cells": [
								{
									"cell": "c7",
									"colspan": 1
								}
							]
						}
					],
					"cells": {
						"c4": {
							"model": "c3",
							"items": [
								"sec_cliente"
							],
							"align": "center"
						},
						"c": {
							"model": "c3",
							"items": [
								"sec_venta"
							],
							"align": "center"
						},
						"c1": {
							"model": "c3",
							"items": [],
							"background": "transparent",
							"customCSS": "/* Put  your custom CSS code here */\n\n        body {\n            box-sizing: border-box;\n        }",
							"height": "3em"
						},
						"c7": {
							"model": "c3",
							"items": [],
							"align": "center"
						},
						"c8": {
							"model": "c3",
							"items": [
								"section2"
							],
							"align": "center"
						},
						"c9": {
							"model": "c3",
							"items": []
						}
					},
					"deferredItems": [],
					"columnCount": 1,
					"inlineLabels": false,
					"separateLabels": false
				},
				"section": {
					"modelId": "simple-edit",
					"grid": [
						{
							"section": "",
							"cells": [
								{
									"cell": "c3"
								},
								{
									"cell": "c4"
								}
							]
						},
						{
							"cells": [
								{
									"cell": "c1"
								},
								{
									"cell": "c"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c1": {
							"model": "c1",
							"items": [
								"integrated_edit_field4",
								"integrated_edit_field1"
							]
						},
						"c": {
							"model": "c1",
							"items": [
								"integrated_edit_field5",
								"integrated_edit_field6"
							]
						},
						"c3": {
							"model": "c1",
							"items": [
								"integrated_edit_field3"
							]
						},
						"c4": {
							"model": "c1",
							"items": [
								"integrated_edit_field9"
							]
						}
					},
					"deferredItems": [],
					"columnCount": 1,
					"inlineLabels": false,
					"separateLabels": false
				},
				"section1": {
					"modelId": "simple-edit",
					"grid": [
						{
							"section": "",
							"cells": [
								{
									"cell": "c2",
									"colspan": 2
								},
								{
									"cell": "c10"
								},
								{
									"cell": "c"
								}
							]
						},
						{
							"section": "",
							"cells": [
								{
									"cell": "c4",
									"colspan": 2
								},
								{
									"cell": "c11"
								},
								{
									"cell": "c3"
								}
							]
						},
						{
							"section": "",
							"cells": [
								{
									"cell": "c9",
									"colspan": 1
								},
								{
									"cell": "c18"
								},
								{
									"cell": "c13"
								},
								{
									"cell": "c5"
								}
							]
						},
						{
							"section": "",
							"cells": [
								{
									"cell": "c12",
									"colspan": 1
								},
								{
									"cell": "c19"
								},
								{
									"cell": "c14"
								},
								{
									"cell": "c7"
								}
							]
						},
						{
							"cells": [
								{
									"cell": "c6",
									"colspan": 1
								},
								{
									"cell": "c20"
								},
								{
									"cell": "c15"
								},
								{
									"cell": "c8"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c2": {
							"model": "c1",
							"items": [
								"integrated_edit_field"
							]
						},
						"c4": {
							"model": "c1",
							"items": [
								"integrated_edit_field20"
							]
						},
						"c6": {
							"model": "c1",
							"items": [
								"integrated_edit_field8"
							]
						},
						"c9": {
							"model": "c1",
							"items": [
								"integrated_edit_field7"
							]
						},
						"c12": {
							"model": "c1",
							"items": [
								"integrated_edit_field23"
							]
						},
						"c3": {
							"model": "c1",
							"items": []
						},
						"c5": {
							"model": "c1",
							"items": [
								"integrated_edit_field22"
							]
						},
						"c7": {
							"model": "c1",
							"items": []
						},
						"c8": {
							"model": "c1",
							"items": [
								"integrated_edit_field27"
							]
						},
						"c10": {
							"model": "c1",
							"items": [
								"integrated_edit_field19"
							]
						},
						"c11": {
							"model": "c1",
							"items": [
								"integrated_edit_field2"
							]
						},
						"c13": {
							"model": "c1",
							"items": [
								"integrated_edit_field29"
							]
						},
						"c14": {
							"model": "c1",
							"items": [
								"integrated_edit_field26"
							]
						},
						"c15": {
							"model": "c1",
							"items": [
								"integrated_edit_field28"
							]
						},
						"c18": {
							"model": "c1",
							"items": [
								"integrated_edit_field21"
							]
						},
						"c19": {
							"model": "c1",
							"items": [
								"integrated_edit_field24"
							]
						},
						"c20": {
							"model": "c1",
							"items": [
								"integrated_edit_field25"
							]
						},
						"c": {
							"model": "c1",
							"items": []
						}
					},
					"deferredItems": [],
					"columnCount": 1,
					"inlineLabels": false,
					"separateLabels": false
				},
				"section2": {
					"modelId": "simple-edit",
					"grid": [
						{
							"section": "",
							"cells": [
								{
									"cell": "c4",
									"colspan": 1
								},
								{
									"cell": "c5",
									"colspan": 6
								},
								{
									"cell": "c19"
								}
							]
						},
						{
							"section": "",
							"cells": [
								{
									"cell": "c9",
									"colspan": 1
								},
								{
									"cell": "c6",
									"colspan": 2
								},
								{
									"cell": "c29",
									"colspan": 2
								},
								{
									"cell": "c25"
								},
								{
									"cell": "c26"
								},
								{
									"cell": "c20"
								}
							]
						},
						{
							"section": "",
							"cells": [
								{
									"cell": "c14"
								},
								{
									"cell": "c15"
								},
								{
									"cell": "c16",
									"colspan": 2
								},
								{
									"cell": "c17",
									"colspan": 3
								},
								{
									"cell": "c18"
								}
							]
						},
						{
							"section": "",
							"cells": [
								{
									"cell": "c",
									"colspan": 8
								}
							]
						}
					],
					"cells": {
						"c4": {
							"model": "c1",
							"items": [
								"integrated_edit_field10"
							],
							"align": "left"
						},
						"c9": {
							"model": "c1",
							"items": [
								"integrated_edit_field16"
							],
							"width": "40%"
						},
						"c19": {
							"model": "c1",
							"items": []
						},
						"c20": {
							"model": "c1",
							"items": []
						},
						"c5": {
							"model": "c1",
							"items": [
								"integrated_edit_field11"
							]
						},
						"c6": {
							"model": "c1",
							"items": [
								"integrated_edit_field13"
							],
							"width": "30%"
						},
						"c": {
							"model": "c1",
							"items": [
								"text"
							],
							"align": "center"
						},
						"c14": {
							"model": "c1",
							"items": [
								"integrated_edit_field17"
							]
						},
						"c15": {
							"model": "c1",
							"items": [
								"integrated_edit_field18"
							]
						},
						"c16": {
							"model": "c1",
							"items": []
						},
						"c17": {
							"model": "c1",
							"items": []
						},
						"c18": {
							"model": "c1",
							"items": []
						},
						"c29": {
							"model": "c1",
							"items": [
								"integrated_edit_field14"
							]
						},
						"c25": {
							"model": "c1",
							"items": [
								"integrated_edit_field15"
							]
						},
						"c26": {
							"model": "c1",
							"items": [
								"integrated_edit_field12"
							]
						}
					},
					"deferredItems": [],
					"columnCount": 1,
					"inlineLabels": false,
					"separateLabels": false
				}
			},
			"items": {
				"add_header": {
					"type": "add_header"
				},
				"add_back_list": {
					"type": "add_back_list"
				},
				"add_cancel": {
					"type": "add_cancel",
					"icon": {}
				},
				"add_message": {
					"type": "add_message"
				},
				"add_save": {
					"type": "add_save",
					"icon": {},
					"customCSS": "/* Put  your custom CSS code here */\n\n:host {\n\n   display:none !important; \n\n\n}\n"
				},
				"add_reset": {
					"type": "add_reset"
				},
				"integrated_edit_field3": {
					"field": "idcliente",
					"type": "integrated_edit_field",
					"orientation": 0,
					"placeholder": {
						"field": "idcliente",
						"table": "solicitudes",
						"type": 5
					}
				},
				"integrated_edit_field": {
					"field": "idproducto",
					"type": "integrated_edit_field",
					"orientation": 0,
					"placeholder": {
						"field": "idproducto",
						"table": "solicitudes",
						"type": 5
					}
				},
				"integrated_edit_field2": {
					"field": "idplan",
					"type": "integrated_edit_field",
					"orientation": 0,
					"placeholder": {
						"field": "idplan",
						"table": "solicitudes",
						"type": 5
					}
				},
				"integrated_edit_field1": {
					"field": "nombre",
					"type": "integrated_edit_field",
					"orientation": 0,
					"placeholder": {
						"field": "nombre",
						"table": "solicitudes",
						"type": 5
					},
					"label": {
						"field": "nombre",
						"table": "solicitudes",
						"type": 3
					}
				},
				"integrated_edit_field4": {
					"field": "paterno",
					"type": "integrated_edit_field",
					"orientation": 0,
					"placeholder": {
						"field": "paterno",
						"table": "solicitudes",
						"type": 5
					}
				},
				"integrated_edit_field5": {
					"field": "materno",
					"type": "integrated_edit_field",
					"orientation": 0,
					"placeholder": {
						"field": "materno",
						"table": "solicitudes",
						"type": 5
					}
				},
				"integrated_edit_field6": {
					"field": "rfc",
					"type": "integrated_edit_field",
					"orientation": 0
				},
				"integrated_edit_field7": {
					"field": "orden",
					"type": "integrated_edit_field",
					"orientation": 0,
					"placeholder": {
						"field": "orden",
						"table": "solicitudes",
						"type": 5
					},
					"font-size": "1.5em",
					"bold": true
				},
				"integrated_edit_field8": {
					"field": "plazo",
					"type": "integrated_edit_field",
					"orientation": 0,
					"placeholder": {
						"field": "plazo",
						"table": "solicitudes",
						"type": 5
					}
				},
				"integrated_edit_field9": {
					"field": "idcli",
					"type": "integrated_edit_field",
					"orientation": 0
				},
				"integrated_edit_field19": {
					"field": "noserie",
					"type": "integrated_edit_field",
					"orientation": 0,
					"bold": true,
					"font-size": "2em"
				},
				"integrated_edit_field20": {
					"field": "idtipoventa",
					"type": "integrated_edit_field",
					"orientation": 0
				},
				"integrated_edit_field21": {
					"field": "dn",
					"type": "integrated_edit_field",
					"orientation": 0,
					"font-size": "1.5em",
					"bold": true
				},
				"integrated_edit_field22": {
					"field": "cuenta",
					"type": "integrated_edit_field",
					"orientation": 0
				},
				"integrated_edit_field23": {
					"field": "contrato",
					"type": "integrated_edit_field",
					"orientation": 0
				},
				"integrated_edit_field24": {
					"field": "contratoportal",
					"type": "integrated_edit_field",
					"orientation": 0
				},
				"integrated_edit_field25": {
					"field": "plazopendiente",
					"type": "integrated_edit_field",
					"orientation": 0
				},
				"integrated_edit_field26": {
					"field": "factura",
					"type": "integrated_edit_field",
					"orientation": 0
				},
				"integrated_edit_field27": {
					"field": "fechavenci",
					"type": "integrated_edit_field",
					"orientation": 0
				},
				"integrated_edit_field28": {
					"field": "ciclo",
					"type": "integrated_edit_field",
					"orientation": 0
				},
				"integrated_edit_field29": {
					"field": "dnpreferido",
					"type": "integrated_edit_field",
					"orientation": 0
				},
				"image": {
					"type": "image",
					"image": {
						"image": "LOGO NEGRO Y AZUL PEQUE.png",
						"source": 2
					},
					"width": "168px",
					"height": "80px"
				},
				"text": {
					"type": "text",
					"editedByRte": false,
					"label": {
						"text": "<div id=\"google-map\" style=\"height: 400px; width: 100%; margin-bottom: 10px; border: 1px solid #ccc;\"></div>\n<p><strong>Haz clic en el mapa para ubicar o arrastra el marcador.</strong></p>\n\n<script src=\"https://maps.googleapis.com/maps/api/js?key=AIzaSyBEbOZrRNV7JiveFroZVC2AFkoMJ18VKyg&libraries=geometry,places&callback=initGoogleMap\" async defer></script>\n\n<script>\n// ====================================================================\n// 📌 1. CONFIGURACIÓN DE IDS (AJUSTA ESTOS IDS SI NO COINCIDEN)\n// ====================================================================\nconst FIELD_IDS = {\n    calle:   'value_calle_1',\n    numext:  'value_numeroext_1',\n    colonia: 'value_colonia_1',\n    ciudad:  'value_ciudad_1',\n    estado:  'value_estado_1',\n    cp:      'value_cp_1',\n    lat:     'value_lat_1',\n    lng:     'value_lng_1'\n};\n\n// ====================================================================\n// 📌 2. VARIABLES GLOBALES Y HELPERS\n// ====================================================================\nlet map;\nlet marker;\nlet geocoder;\nlet mapInitialized = false;\n\nconst $id = (id) => document.getElementById(id);\nconst safeTrim = (v) => (v || '').toString().trim();\nconst isValidLatLng = (lat, lng) => {\n    const a = Number(lat), b = Number(lng);\n    return Number.isFinite(a) && Number.isFinite(b) && a <= 90 && a >= -90 && b <= 180 && b >= -180;\n};\n\n// ====================================================================\n// 📌 3. FUNCIONES PRINCIPALES\n// ====================================================================\n\n// --- Inicialización del Mapa (Llamada por el API script) ---\nfunction initGoogleMap() {\n    if (mapInitialized) return;\n\n    const defaultCoords = { lat: 21.0038, lng: -89.6183 }; // Mérida, México como centro por defecto\n    \n    const initialLat = safeTrim($id(FIELD_IDS.lat)?.value);\n    const initialLng = safeTrim($id(FIELD_IDS.lng)?.value);\n    const initialCoords = isValidLatLng(initialLat, initialLng) \n        ? { lat: Number(initialLat), lng: Number(initialLng) } \n        : defaultCoords;\n\n    map = new google.maps.Map($id('google-map'), {\n        center: initialCoords,\n        zoom: isValidLatLng(initialLat, initialLng) ? 17 : 12,\n        mapTypeId: 'roadmap',\n        gestureHandling: 'greedy' // 🚀 Evita el molesto \"Ctrl + Scroll\"\n    });\n\n    geocoder = new google.maps.Geocoder();\n    mapInitialized = true;\n\n    // Colocar marcador si hay coordenadas iniciales\n    if (isValidLatLng(initialLat, initialLng)) {\n        placeMarker(initialCoords);\n    }\n    \n    // Listener: Al hacer CLIC en el mapa\n    map.addListener('click', (e) => {\n        placeMarker(e.latLng); \n        updateFieldsAndGeocode(e.latLng); \n    });\n    \n    // PHPRunner necesita esta línea para que el mapa se muestre correctamente en pestañas/secciones\n    setTimeout(() => google.maps.event.trigger(map, 'resize'), 300);\n}\n\n// --- Coloca el marcador y actualiza Lat/Lng al arrastrar o hacer clic ---\nfunction placeMarker(location) {\n    if (marker) {\n        marker.setPosition(location);\n    } else {\n        marker = new google.maps.Marker({\n            position: location,\n            map: map,\n            draggable: true // 📌 Permite arrastrar el marcador\n        });\n        \n        // Listener: Al terminar de arrastrar el marcador\n        marker.addListener('dragend', function() {\n            const newLocation = marker.getPosition();\n            updateFieldsAndGeocode(newLocation);\n        });\n    }\n    map.setCenter(location);\n    \n    // Si no usamos updateFieldsAndGeocode (ej. al inicio), aseguramos la posición\n    $id(FIELD_IDS.lat).value = location.lat().toFixed(6);\n    $id(FIELD_IDS.lng).value = location.lng().toFixed(6);\n}\n\n// --- Función central: Actualiza campos y pide Geocodificación Inversa ---\nfunction updateFieldsAndGeocode(location) {\n    // 1. Actualiza campos Lat/Lng\n    $id(FIELD_IDS.lat).value = location.lat().toFixed(6);\n    $id(FIELD_IDS.lng).value = location.lng().toFixed(6);\n    \n    // 2. Realiza la geocodificación inversa (Lat/Lng -> Dirección)\n    reverseGeocode(location);\n}\n\n// --- Geocodificación Inversa (Lat/Lng -> Dirección) ---\nfunction reverseGeocode(latLng) {\n    if (!geocoder) return;\n\n    geocoder.geocode({ location: latLng })\n        .then((response) => {\n            if (response.results[0]) {\n                populateAddressFields(response.results[0]);\n            }\n        })\n        .catch((e) => console.error('Falló la geocodificación inversa:', e));\n}\n\nfunction getAddressComponent(components, type) {\n    const component = components.find(c => c.types.includes(type));\n    return component ? component.long_name : '';\n}\n\nfunction populateAddressFields(result) {\n    const components = result.address_components;\n    \n    // Obtener componentes específicos de Google Maps\n    const street = getAddressComponent(components, 'route');\n    const houseNumber = getAddressComponent(components, 'street_number');\n    const neighborhood = getAddressComponent(components, 'sublocality_level_1') || getAddressComponent(components, 'neighborhood');\n    const city = getAddressComponent(components, 'locality') || getAddressComponent(components, 'administrative_area_level_2');\n    const state = getAddressComponent(components, 'administrative_area_level_1');\n    const postalCode = getAddressComponent(components, 'postal_code');\n\n    // Llenar los campos del formulario\n    if ($id(FIELD_IDS.estado)) $id(FIELD_IDS.estado).value = state;\n    if ($id(FIELD_IDS.ciudad)) $id(FIELD_IDS.ciudad).value = city;\n    if ($id(FIELD_IDS.cp)) $id(FIELD_IDS.cp).value = postalCode;\n    if ($id(FIELD_IDS.colonia)) $id(FIELD_IDS.colonia).value = neighborhood;\n    if ($id(FIELD_IDS.calle)) $id(FIELD_IDS.calle).value = street;\n    if ($id(FIELD_IDS.numext)) $id(FIELD_IDS.numext).value = houseNumber;\n}\n\n// --- Geocodificación (Dirección -> Lat/Lng) desde campos de texto ---\nfunction geocodeAddressFromFields() {\n    const calle = safeTrim($id(FIELD_IDS.calle)?.value);\n    const numext = safeTrim($id(FIELD_IDS.numext)?.value);\n    const colonia = safeTrim($id(FIELD_IDS.colonia)?.value);\n    const ciudad = safeTrim($id(FIELD_IDS.ciudad)?.value) || '';\n    const estado = safeTrim($id(FIELD_IDS.estado)?.value) || '';\n    const cp = safeTrim($id(FIELD_IDS.cp)?.value);\n\n    const addressParts = [\n        calle + (numext ? ' ' + numext : ''),\n        colonia,\n        ciudad,\n        estado,\n        cp,\n        'México'\n    ].filter(Boolean);\n    \n    const address = addressParts.join(', ');\n\n    if (!address || !geocoder || (!calle && !colonia)) return;\n\n    geocoder.geocode({ address: address })\n        .then((response) => {\n            if (response.results[0]) {\n                const location = response.results[0].geometry.location;\n                placeMarker(location);\n                map.setZoom(17);\n            }\n        })\n        .catch((e) => console.error('Geocoding falló por:', e));\n}\n\n\n// ====================================================================\n// 📌 4. LÓGICA DE ARRANQUE Y EVENTOS (Manejo de Tabs/Redimensionamiento)\n// ====================================================================\n\nfunction attachListeners() {\n    const addressFields = [FIELD_IDS.calle, FIELD_IDS.numext, FIELD_IDS.colonia, FIELD_IDS.ciudad, FIELD_IDS.estado, FIELD_IDS.cp];\n\n    // Observa cambios en los campos de dirección (al salir o presionar Enter)\n    addressFields.forEach(id => {\n        const el = $id(id);\n        if (!el) return;\n        \n        el.addEventListener('blur', geocodeAddressFromFields);\n        el.addEventListener('keydown', (e) => {\n            if (e.key === 'Enter') {\n                e.preventDefault();\n                geocodeAddressFromFields();\n            }\n        });\n    });\n\n    // Observa cambios en Lat/Lng manuales para centrar el mapa\n    [FIELD_IDS.lat, FIELD_IDS.lng].forEach(id => {\n        const el = $id(id);\n        if (!el) return;\n        el.addEventListener('change', () => {\n            const lat = safeTrim($id(FIELD_IDS.lat)?.value);\n            const lng = safeTrim($id(FIELD_IDS.lng)?.value);\n            if (isValidLatLng(lat, lng)) {\n                placeMarker(new google.maps.LatLng(Number(lat), Number(lng)));\n                map.setZoom(17);\n            }\n        });\n    });\n}\n\n// Maneja la inicialización tardía en caso de que el mapa esté en una pestaña oculta\nfunction checkMapVisibility() {\n    const mapContainer = $id('google-map');\n    if (mapContainer && mapContainer.offsetParent !== null && mapContainer.offsetWidth > 0) {\n        if (!mapInitialized && typeof google !== 'undefined' && typeof google.maps !== 'undefined') {\n             // La inicialización real ocurre por el 'callback=initGoogleMap' en la URL del API\n             // Solo llamamos al resize si ya cargó\n             setTimeout(() => google.maps.event.trigger(map, 'resize'), 100);\n             return true;\n        }\n    }\n    return false;\n}\n\ndocument.addEventListener('DOMContentLoaded', function() {\n    attachListeners();\n\n    // Revisa la visibilidad al inicio\n    checkMapVisibility(); \n    \n    // Observador para cuando se cambie de pestaña\n    document.body.addEventListener('click', function(e) {\n        if (e.target.closest('[data-toggle=\"tab\"], .step-tab, .nav-link')) {\n            setTimeout(() => {\n                if (mapInitialized) google.maps.event.trigger(map, 'resize');\n                else checkMapVisibility();\n            }, 400);\n        }\n    });\n});\n</script>",
						"type": 0
					}
				},
				"integrated_edit_field12": {
					"field": "cp",
					"type": "integrated_edit_field",
					"orientation": 0
				},
				"integrated_edit_field16": {
					"field": "colonia",
					"type": "integrated_edit_field",
					"orientation": 0
				},
				"integrated_edit_field13": {
					"field": "calle",
					"type": "integrated_edit_field",
					"orientation": 0
				},
				"integrated_edit_field14": {
					"field": "numeroext",
					"type": "integrated_edit_field",
					"orientation": 0
				},
				"integrated_edit_field15": {
					"field": "numeroint",
					"type": "integrated_edit_field",
					"orientation": 0
				},
				"integrated_edit_field11": {
					"field": "ciudad",
					"type": "integrated_edit_field",
					"orientation": 0
				},
				"integrated_edit_field10": {
					"field": "estado",
					"type": "integrated_edit_field",
					"orientation": 0
				},
				"integrated_edit_field17": {
					"field": "lat",
					"type": "integrated_edit_field",
					"orientation": 0
				},
				"integrated_edit_field18": {
					"field": "lng",
					"type": "integrated_edit_field",
					"orientation": 0
				},
				"section2": {
					"type": "section",
					"title": {
						"text": "<i class=\"fa-solid fa-location-dot\" style=\"font-size:1.5em; color:#fff;\"></i> Dirección de Entrega\n",
						"type": 0
					},
					"location": "section2",
					"bsStyle": "default",
					"panelType": 3,
					"headerBg": "",
					"headerColor": "",
					"bodyBg": "",
					"bodyColor": "",
					"panelBorder": null,
					"borderColor": "",
					"initiallyClosed": true
				},
				"sec_cliente": {
					"type": "section",
					"title": {
						"text": "<i class=\"fa-solid fa-user\" style=\"font-size:1.5em; color:#fff;\"></i> Datos del Cliente\n\n",
						"type": 0
					},
					"location": "section",
					"bsStyle": "default",
					"panelType": 3,
					"headerBg": "",
					"headerColor": "#ffffff",
					"bodyBg": "",
					"bodyColor": "",
					"panelBorder": null,
					"borderColor": "",
					"initiallyClosed": true
				},
				"sec_venta": {
					"type": "section",
					"title": {
						"text": "<i class=\"fa-solid fa-cart-shopping\" style=\"font-size:1.5em; color:#fff;\"></i> Información de la Venta\n",
						"type": 0
					},
					"location": "section1",
					"bsStyle": "default",
					"panelType": 3,
					"headerBg": "",
					"headerColor": "",
					"bodyBg": "",
					"bodyColor": "",
					"panelBorder": null,
					"borderColor": "",
					"initiallyClosed": true
				},
				"text1": {
					"type": "text",
					"label": {
						"text": "<button type=\"button\" id=\"btnGuardarVNP\" class=\"btn btn-primary\">\n    Guardar VNP\n</button>\n",
						"type": 0
					},
					"editedByRte": false
				}
			},
			"dbProps": {},
			"version": 13,
			"pageWidth": "standard",
			"imageItem": {
				"type": "page_image"
			},
			"imageBgColor": "#f2f2f2",
			"controlsBgColor": "white",
			"imagePosition": "right",
			"pageCSS": "/* Put  your custom CSS code here */\n\n\n\n/* ========================================================= */\n/* VARIABLES DE COLOR */\n/* ========================================================= */\n:root {\n    --color-elegante: #FFFFFF; /* Texto Blanco para contrastar con el fondo oscuro */\n    --naranja-degradado-inicio: #03478A; /* Naranja Suave (Light Salmon) */\n    --naranja-degradado-fin: #6D98C2; /* Naranja Medio (Coral) */\n    --color-borde-base: #FF7F50; /* Color simple para el borde base */\n}\n\n/* ========================================================= */\n/* 1. Fondo de la Página: Degradado Azul Cielo (Se mantiene) */\n/* ========================================================= */\nbody, .container-fluid {\nbackground: linear-gradient(180deg, #E0F7FA 0%, #B3E5FC 100%) !important;    min-height: 100vh;\n}\n\n/* ========================================================= */\n/* 2. Estilo de las Secciones: Efecto Tarjeta/Sombreado (Se mantiene) */\n/* ========================================================= */\n.panel, .rnr-c-body, .rnr-c-grid {\n    background-color: #FFFFFF !important; \n    border: none !important; \n    border-radius: 12px !important; \n    padding: 20px;\n    margin-bottom: 25px; \n    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1), \n                0 2px 6px rgba(0, 0, 0, 0.05) !important; \n                \n    /* 🔑 CAMBIO CLAVE: Agrega 'transform' a la transición */\n    transition: box-shadow 0.3s ease-in-out, \n                transform 0.3s ease-in-out; /* Transición para el movimiento y escala */            \n                \n}\n\n/* ========================================================= */\n/* 3. Estilo de Encabezados de Sección (EL CAMBIO PRINCIPAL) */\n/* ========================================================= */\n.panel-heading, .rnr-c-head {\n    /* Aplicamos el degradado al fondo completo del encabezado */\n    background: linear-gradient(to right, var(--naranja-degradado-inicio), var(--naranja-degradado-fin)) !important;\n    \n    /* El texto del título ahora es blanco para contrastar con el fondo naranja */\n    color: var(--color-elegante) !important; \n    \n    font-weight: 600;\n    \n    /* Mantenemos el centrado vertical */\n    display: flex;\n    align-items: center;\n    height: 40px; /* Aseguramos una altura suficiente */\n    \n    /* Eliminamos el borde degradado y aplicamos un borde simple y fino abajo */\n    border-bottom: 1px solid var(--color-borde-base) !important; \n    border-image-source: none !important; /* Desactivar la propiedad border-image anterior */\n    \n    /* Ajustes de relleno/bordes para que el degradado se vea bien */\n    padding: 0 15px !important; \n    border-top-left-radius: 12px !important; /* Mantenemos el radio del panel superior */\n    border-top-right-radius: 12px !important;\n}\n\n/* ========================================================= */\n/* 3. Estilo de HOVER: Efecto de Elevación/Intensificación    */\n/* ========================================================= */\n.panel:hover, .rnr-c-body:hover, .rnr-c-grid:hover {\n    /* Nueva sombra más intensa y \"elevada\" */\n    box-shadow: 0 15px 400px rgba(0, 0, 0, 0.3), \n                0 5px 15px rgba(0, 0, 0, 0.1) !important; \n    \n    /* Pequeño movimiento hacia arriba para dar más sensación de elevación (opcional) */\n    transform: translateY(-5px) scale(1.005); \n}\n\n\n\n/* 4. Estilo de los Inputs (Se mantiene) */\n.form-control {\n    border-radius: 8px !important; \n    border: 1px solid #e0e0e0 !important;\n}\n.form-control:focus {\n    border-color: #48C9B0 !important; \n    box-shadow: 0 0 0 0.2rem rgba(72, 201, 176, 0.25) !important;\n}\n\n/* Aplica solo a formularios con esas secciones */\n.panel.panel-default.form-section > .panel-body { display: none; }\n\n.panel.panel-default.form-section > .panel-heading:hover {\n  cursor: pointer;\n  filter: brightness(0.98);\n}\n\n/* ========================================================= */\n/* ARREGLO DE COLOR DE TEXTO DE ENCABEZADO DURANTE MODAL     */\n/* ========================================================= */\n\n/* Apuntamos directamente al panel-title, que es el elemento que contiene \n   el texto del encabezado de la sección. \n*/\n.panel-heading .panel-title {\n    color: #FFFFFF !important; \n}\n\n/* Si dentro del panel-title hay un enlace (Ej. si el encabezado permite colapsar/expandir \n   y el título es un <a>), también debemos forzar el color del enlace.\n*/\n.panel-heading .panel-title a {\n    color: #FFFFFF !important;\n}\n\n/* Asegurar que el texto dentro del panel-title no se vea afectado por reglas generales\n   que usen el estado 'modal-open' en el cuerpo de la página.\n*/\n.modal-open .panel-heading .panel-title {\n    color: #FFFFFF !important;\n}",
			"listTotals": 1,
			"customHtml": "",
			"title": {}
		},
		{
			"id": "export",
			"type": "export",
			"layoutId": "first",
			"disabled": false,
			"default": 0,
			"forms": {
				"supertop": {
					"modelId": "panel-top",
					"grid": [
						{
							"cells": [
								{
									"cell": "c1"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c1": {
							"model": "c1",
							"items": []
						}
					},
					"deferredItems": [],
					"recsPerRow": 1
				},
				"top": {
					"modelId": "export-header",
					"grid": [
						{
							"cells": [
								{
									"cell": "c1"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c1": {
							"model": "c1",
							"items": [
								"export_header"
							]
						}
					},
					"deferredItems": [],
					"recsPerRow": 1
				},
				"grid": {
					"modelId": "export-grid",
					"grid": [
						{
							"cells": [
								{
									"cell": "c1"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c1": {
							"model": "c1",
							"items": [
								"export_field",
								"export_field1",
								"export_field2",
								"export_field3",
								"export_field4",
								"export_field5",
								"export_field6",
								"export_field7",
								"export_field8",
								"export_field9",
								"export_field10",
								"export_field11"
							]
						}
					},
					"deferredItems": [],
					"recsPerRow": 1
				},
				"footer": {
					"modelId": "export-footer",
					"grid": [
						{
							"cells": [
								{
									"cell": "c1"
								},
								{
									"cell": "c2"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c1": {
							"model": "c1",
							"items": []
						},
						"c2": {
							"model": "c2",
							"items": [
								"export_export",
								"export_cancel"
							]
						}
					},
					"deferredItems": [],
					"recsPerRow": 1
				}
			},
			"items": {
				"export_header": {
					"type": "export_header"
				},
				"export_export": {
					"type": "export_export"
				},
				"export_cancel": {
					"type": "export_cancel"
				},
				"export_field": {
					"field": "direccion",
					"type": "export_field"
				},
				"export_field1": {
					"field": "lat",
					"type": "export_field"
				},
				"export_field2": {
					"field": "lng",
					"type": "export_field"
				},
				"export_field3": {
					"field": "dn",
					"type": "export_field"
				},
				"export_field4": {
					"field": "cuenta",
					"type": "export_field"
				},
				"export_field5": {
					"field": "contrato",
					"type": "export_field"
				},
				"export_field6": {
					"field": "contratoportal",
					"type": "export_field"
				},
				"export_field7": {
					"field": "plazopendiente",
					"type": "export_field"
				},
				"export_field8": {
					"field": "factura",
					"type": "export_field"
				},
				"export_field9": {
					"field": "fechavenci",
					"type": "export_field"
				},
				"export_field10": {
					"field": "ciclo",
					"type": "export_field"
				},
				"export_field11": {
					"field": "dnpreferido",
					"type": "export_field"
				}
			},
			"dbProps": {},
			"version": 13,
			"imageItem": {
				"type": "page_image"
			},
			"imageBgColor": "#f2f2f2",
			"controlsBgColor": "white",
			"imagePosition": "right",
			"listTotals": 1,
			"title": {},
			"exportFormat": 2,
			"exportDelimiter": ",",
			"exportSelectDelimiter": false,
			"exportSelectFields": false
		},
		{
			"id": "import",
			"type": "import",
			"layoutId": "first",
			"disabled": true,
			"default": 0,
			"forms": {
				"supertop": {
					"modelId": "panel-top",
					"grid": [
						{
							"cells": [
								{
									"cell": "c1"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c1": {
							"model": "c1",
							"items": []
						}
					},
					"deferredItems": [],
					"recsPerRow": 1
				},
				"top": {
					"modelId": "import-header",
					"grid": [
						{
							"cells": [
								{
									"cell": "c1"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c1": {
							"model": "c1",
							"items": [
								"import_header"
							]
						}
					},
					"deferredItems": [],
					"recsPerRow": 1
				},
				"grid": {
					"modelId": "import-grid",
					"grid": [
						{
							"cells": [
								{
									"cell": "c1"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c1": {
							"model": "c1",
							"items": []
						}
					},
					"deferredItems": [],
					"recsPerRow": 1
				}
			},
			"items": {
				"import_header": {
					"type": "import_header"
				}
			},
			"dbProps": {},
			"version": 13,
			"imageItem": {
				"type": "page_image"
			},
			"imageBgColor": "#f2f2f2",
			"controlsBgColor": "white",
			"imagePosition": "right",
			"listTotals": 1,
			"title": {}
		},
		{
			"id": "edit",
			"type": "edit",
			"layoutId": "nomenu",
			"disabled": false,
			"default": 7,
			"forms": {
				"above-grid": {
					"modelId": "edit-above-grid",
					"grid": [
						{
							"cells": [
								{
									"cell": "c1"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c1": {
							"model": "c1",
							"items": [
								"edit_message"
							]
						}
					},
					"deferredItems": [],
					"recsPerRow": 1
				},
				"below-grid": {
					"modelId": "edit-below-grid",
					"grid": [
						{
							"cells": [
								{
									"cell": "c1"
								},
								{
									"cell": "c2"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c1": {
							"model": "c1",
							"items": [
								"edit_save",
								"edit_back_list",
								"edit_close"
							]
						},
						"c2": {
							"model": "c2",
							"items": [
								"hamburger"
							]
						}
					},
					"deferredItems": [],
					"recsPerRow": 1
				},
				"top": {
					"modelId": "edit-header",
					"grid": [
						{
							"cells": [
								{
									"cell": "c1"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c1": {
							"model": "c1",
							"items": [
								"image",
								"edit_header"
							]
						}
					},
					"deferredItems": [],
					"recsPerRow": 1
				},
				"grid": {
					"modelId": "simple-edit",
					"grid": [
						{
							"section": "",
							"cells": [
								{
									"cell": "c",
									"rowspan": 1
								}
							]
						},
						{
							"section": "",
							"cells": [
								{
									"cell": "c4"
								}
							]
						},
						{
							"section": "",
							"cells": [
								{
									"cell": "c5"
								}
							]
						},
						{
							"section": "",
							"cells": [
								{
									"cell": "c6"
								}
							]
						},
						{
							"cells": [
								{
									"cell": "c3",
									"rowspan": 1,
									"colspan": 1
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c3": {
							"model": "c3",
							"items": [
								"section2"
							],
							"border": [
								{
									"side": "",
									"width": "0"
								}
							],
							"padding": {
								"right": "10px"
							},
							"customCSS": "\n",
							"width": "50%",
							"align": "center"
						},
						"c": {
							"model": "c3",
							"items": [
								"sec_cliente"
							],
							"align": "center"
						},
						"c4": {
							"model": "c3",
							"items": []
						},
						"c5": {
							"model": "c3",
							"items": [
								"sec_venta"
							],
							"align": "center"
						},
						"c6": {
							"model": "c3",
							"items": [],
							"align": "center"
						}
					},
					"deferredItems": [],
					"columnCount": 1,
					"inlineLabels": false,
					"separateLabels": false
				},
				"section": {
					"modelId": "simple-edit",
					"grid": [
						{
							"section": "",
							"cells": [
								{
									"cell": "c"
								},
								{
									"cell": "c2"
								}
							]
						},
						{
							"cells": [
								{
									"cell": "c1"
								},
								{
									"cell": "c3"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c1": {
							"model": "c1",
							"items": [
								"integrated_edit_field4",
								"integrated_edit_field1"
							]
						},
						"c": {
							"model": "c1",
							"items": [
								"integrated_edit_field3"
							]
						},
						"c2": {
							"model": "c1",
							"items": [
								"integrated_edit_field9"
							]
						},
						"c3": {
							"model": "c1",
							"items": [
								"integrated_edit_field5",
								"integrated_edit_field6"
							]
						}
					},
					"deferredItems": [],
					"columnCount": 1,
					"inlineLabels": false,
					"separateLabels": false
				},
				"section1": {
					"modelId": "simple-edit",
					"grid": [
						{
							"section": "",
							"cells": [
								{
									"cell": "c4",
									"colspan": 2
								},
								{
									"cell": "c",
									"colspan": 1
								},
								{
									"cell": "c1"
								},
								{
									"cell": "c9"
								}
							]
						},
						{
							"section": "",
							"cells": [
								{
									"cell": "c8"
								},
								{
									"cell": "c18",
									"colspan": 1
								},
								{
									"cell": "c13",
									"colspan": 1
								},
								{
									"cell": "c2"
								},
								{
									"cell": "c10"
								}
							]
						},
						{
							"section": "",
							"cells": [
								{
									"cell": "c12"
								},
								{
									"cell": "c19",
									"colspan": 1
								},
								{
									"cell": "c14",
									"colspan": 1
								},
								{
									"cell": "c3"
								},
								{
									"cell": "c11"
								}
							]
						},
						{
							"section": "",
							"cells": [
								{
									"cell": "c20"
								},
								{
									"cell": "c21",
									"colspan": 1
								},
								{
									"cell": "c15",
									"colspan": 1
								},
								{
									"cell": "c6"
								},
								{
									"cell": "c17"
								}
							]
						},
						{
							"cells": [
								{
									"cell": "c5"
								},
								{
									"cell": "c22",
									"colspan": 1
								},
								{
									"cell": "c16",
									"colspan": 1
								},
								{
									"cell": "c7"
								},
								{
									"cell": "c23"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c4": {
							"model": "c1",
							"items": [
								"integrated_edit_field"
							]
						},
						"c8": {
							"model": "c1",
							"items": [
								"integrated_edit_field20"
							]
						},
						"c12": {
							"model": "c1",
							"items": [
								"integrated_edit_field7"
							]
						},
						"c20": {
							"model": "c1",
							"items": [
								"integrated_edit_field23"
							]
						},
						"c5": {
							"model": "c1",
							"items": [
								"integrated_edit_field8"
							]
						},
						"c": {
							"model": "c1",
							"items": [
								"integrated_edit_field19"
							]
						},
						"c13": {
							"model": "c1",
							"items": []
						},
						"c14": {
							"model": "c1",
							"items": [
								"integrated_edit_field29"
							]
						},
						"c15": {
							"model": "c1",
							"items": [
								"integrated_edit_field26"
							]
						},
						"c16": {
							"model": "c1",
							"items": [
								"integrated_edit_field28"
							]
						},
						"c18": {
							"model": "c1",
							"items": [
								"integrated_edit_field2"
							]
						},
						"c19": {
							"model": "c1",
							"items": [
								"integrated_edit_field21"
							]
						},
						"c21": {
							"model": "c1",
							"items": [
								"integrated_edit_field24"
							]
						},
						"c22": {
							"model": "c1",
							"items": [
								"integrated_edit_field25"
							]
						},
						"c1": {
							"model": "c1",
							"items": []
						},
						"c2": {
							"model": "c1",
							"items": []
						},
						"c3": {
							"model": "c1",
							"items": [
								"integrated_edit_field22"
							]
						},
						"c6": {
							"model": "c1",
							"items": []
						},
						"c7": {
							"model": "c1",
							"items": [
								"integrated_edit_field27"
							]
						},
						"c9": {
							"model": "c1",
							"items": []
						},
						"c10": {
							"model": "c1",
							"items": []
						},
						"c11": {
							"model": "c1",
							"items": []
						},
						"c17": {
							"model": "c1",
							"items": []
						},
						"c23": {
							"model": "c1",
							"items": []
						}
					},
					"deferredItems": [],
					"columnCount": 1,
					"inlineLabels": false,
					"separateLabels": false
				},
				"section2": {
					"modelId": "simple-edit",
					"grid": [
						{
							"section": "",
							"cells": [
								{
									"cell": "c",
									"colspan": 2
								},
								{
									"cell": "c20",
									"colspan": 2
								},
								{
									"cell": "c23",
									"colspan": 2
								},
								{
									"cell": "c4"
								}
							]
						},
						{
							"section": "",
							"cells": [
								{
									"cell": "c2",
									"colspan": 2
								},
								{
									"cell": "c21"
								},
								{
									"cell": "c17"
								},
								{
									"cell": "c13"
								},
								{
									"cell": "c9"
								},
								{
									"cell": "c5"
								}
							]
						},
						{
							"section": "",
							"cells": [
								{
									"cell": "c3"
								},
								{
									"cell": "c7"
								},
								{
									"cell": "c22"
								},
								{
									"cell": "c18"
								},
								{
									"cell": "c14"
								},
								{
									"cell": "c10"
								},
								{
									"cell": "c6"
								}
							]
						},
						{
							"cells": [
								{
									"cell": "c1",
									"colspan": 7
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c1": {
							"model": "c1",
							"items": [
								"text"
							],
							"align": "center"
						},
						"c": {
							"model": "c1",
							"items": [
								"integrated_edit_field10"
							]
						},
						"c2": {
							"model": "c1",
							"items": [
								"integrated_edit_field16"
							],
							"width": "40%"
						},
						"c3": {
							"model": "c1",
							"items": [
								"integrated_edit_field17"
							]
						},
						"c4": {
							"model": "c1",
							"items": []
						},
						"c5": {
							"model": "c1",
							"items": []
						},
						"c6": {
							"model": "c1",
							"items": []
						},
						"c9": {
							"model": "c1",
							"items": [
								"integrated_edit_field12"
							]
						},
						"c10": {
							"model": "c1",
							"items": []
						},
						"c13": {
							"model": "c1",
							"items": [
								"integrated_edit_field15"
							]
						},
						"c14": {
							"model": "c1",
							"items": []
						},
						"c17": {
							"model": "c1",
							"items": [
								"integrated_edit_field14"
							]
						},
						"c18": {
							"model": "c1",
							"items": []
						},
						"c20": {
							"model": "c1",
							"items": [
								"integrated_edit_field11"
							]
						},
						"c21": {
							"model": "c1",
							"items": [
								"integrated_edit_field13"
							]
						},
						"c22": {
							"model": "c1",
							"items": []
						},
						"c23": {
							"model": "c1",
							"items": []
						},
						"c7": {
							"model": "c1",
							"items": [
								"integrated_edit_field18"
							]
						}
					},
					"deferredItems": [],
					"columnCount": 1,
					"inlineLabels": false,
					"separateLabels": false
				}
			},
			"items": {
				"edit_header": {
					"type": "edit_header"
				},
				"hamburger": {
					"type": "hamburger",
					"items": [
						"edit_reset",
						"edit_view"
					]
				},
				"edit_reset": {
					"type": "edit_reset"
				},
				"edit_message": {
					"type": "edit_message"
				},
				"edit_save": {
					"type": "edit_save"
				},
				"edit_back_list": {
					"type": "edit_back_list"
				},
				"edit_close": {
					"type": "edit_close"
				},
				"edit_view": {
					"type": "edit_view"
				},
				"integrated_edit_field3": {
					"field": "idcliente",
					"type": "integrated_edit_field",
					"orientation": 0,
					"placeholder": {
						"field": "idcliente",
						"table": "solicitudes",
						"type": 5
					},
					"updateOnEdit": false
				},
				"integrated_edit_field4": {
					"field": "paterno",
					"type": "integrated_edit_field",
					"orientation": 0,
					"placeholder": {
						"field": "paterno",
						"table": "solicitudes",
						"type": 5
					},
					"updateOnEdit": false
				},
				"integrated_edit_field5": {
					"field": "materno",
					"type": "integrated_edit_field",
					"orientation": 0,
					"placeholder": {
						"field": "materno",
						"table": "solicitudes",
						"type": 5
					},
					"updateOnEdit": false
				},
				"integrated_edit_field1": {
					"field": "nombre",
					"type": "integrated_edit_field",
					"orientation": 0,
					"placeholder": {
						"field": "nombre",
						"table": "solicitudes",
						"type": 5
					},
					"label": {
						"field": "nombre",
						"table": "solicitudes",
						"type": 3
					},
					"updateOnEdit": false
				},
				"integrated_edit_field6": {
					"field": "rfc",
					"type": "integrated_edit_field",
					"orientation": 0,
					"updateOnEdit": false
				},
				"integrated_edit_field9": {
					"field": "idcli",
					"type": "integrated_edit_field",
					"orientation": 0,
					"updateOnEdit": false
				},
				"integrated_edit_field": {
					"field": "idproducto",
					"type": "integrated_edit_field",
					"orientation": 0,
					"placeholder": {
						"field": "idproducto",
						"table": "solicitudes",
						"type": 5
					},
					"updateOnEdit": false
				},
				"integrated_edit_field2": {
					"field": "idplan",
					"type": "integrated_edit_field",
					"orientation": 0,
					"placeholder": {
						"field": "idplan",
						"table": "solicitudes",
						"type": 5
					},
					"updateOnEdit": false
				},
				"integrated_edit_field7": {
					"field": "orden",
					"type": "integrated_edit_field",
					"orientation": 0,
					"placeholder": {
						"field": "orden",
						"table": "solicitudes",
						"type": 5
					},
					"updateOnEdit": false
				},
				"integrated_edit_field8": {
					"field": "plazo",
					"type": "integrated_edit_field",
					"orientation": 0,
					"placeholder": {
						"field": "plazo",
						"table": "solicitudes",
						"type": 5
					},
					"updateOnEdit": false
				},
				"integrated_edit_field19": {
					"field": "noserie",
					"type": "integrated_edit_field",
					"orientation": 0,
					"updateOnEdit": false
				},
				"integrated_edit_field20": {
					"field": "idtipoventa",
					"type": "integrated_edit_field",
					"orientation": 0,
					"updateOnEdit": false
				},
				"integrated_edit_field21": {
					"field": "dn",
					"type": "integrated_edit_field",
					"orientation": 0,
					"updateOnEdit": false
				},
				"integrated_edit_field22": {
					"field": "cuenta",
					"type": "integrated_edit_field",
					"orientation": 0,
					"updateOnEdit": false
				},
				"integrated_edit_field23": {
					"field": "contrato",
					"type": "integrated_edit_field",
					"orientation": 0,
					"updateOnEdit": false
				},
				"integrated_edit_field24": {
					"field": "contratoportal",
					"type": "integrated_edit_field",
					"orientation": 0,
					"updateOnEdit": false
				},
				"integrated_edit_field25": {
					"field": "plazopendiente",
					"type": "integrated_edit_field",
					"orientation": 0,
					"updateOnEdit": false
				},
				"integrated_edit_field26": {
					"field": "factura",
					"type": "integrated_edit_field",
					"orientation": 0,
					"updateOnEdit": false
				},
				"integrated_edit_field27": {
					"field": "fechavenci",
					"type": "integrated_edit_field",
					"orientation": 0,
					"updateOnEdit": false
				},
				"integrated_edit_field28": {
					"field": "ciclo",
					"type": "integrated_edit_field",
					"orientation": 0,
					"updateOnEdit": false
				},
				"integrated_edit_field29": {
					"field": "dnpreferido",
					"type": "integrated_edit_field",
					"orientation": 0,
					"updateOnEdit": false
				},
				"text": {
					"type": "text",
					"label": {
						"text": "<div id=\"map\" style=\"height: 400px; width: 100%; margin-bottom: 10px; border: 1px solid #ccc;\"></div>\n<p><strong>Haz clic en el mapa para obtener los datos de la ubicación (si algún campo no se acompleta automáticamente, favor de escribirlo)</strong></p>\n\n<!-- Cargar Leaflet CSS & JS -->\n<link rel=\"stylesheet\" href=\"https://unpkg.com/leaflet@1.9.4/dist/leaflet.css\" />\n<script src=\"https://unpkg.com/leaflet@1.9.4/dist/leaflet.js\"></script>\n\n<script>\n// Variables globales\nlet map;\nlet marker;\nlet mapInitialized = false;\n\nfunction initMap() {\n    if (mapInitialized) {\n        setTimeout(() => map.invalidateSize(), 100);\n        return;\n    }\n    \n    const initialLocation = [21.0038, -89.6183];\n    map = L.map('map').setView(initialLocation, 12);\n    \n    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {\n        attribution: '&copy; <a href=\"https://www.openstreetmap.org/copyright\">OpenStreetMap</a> contributors'\n    }).addTo(map);\n    \n    mapInitialized = true;\n    \n    map.on('click', function(e) {\n        placeMarkerAndGeocode(e.latlng);\n    });\n    \n    setTimeout(() => map.invalidateSize(), 300);\n}\n\nfunction placeMarkerAndGeocode(latlng) {\n    if (marker) map.removeLayer(marker);\n    marker = L.marker(latlng).addTo(map);\n    map.setView(latlng, map.getZoom());\n    \n    var apiUrl = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${latlng.lat}&lon=${latlng.lng}&zoom=18&addressdetails=1`;\n    \n    fetch(apiUrl)\n        .then(response => response.json())\n        .then(data => {\n            if (data && data.address) {\n                populateAddressFields(data.address, latlng, data.display_name);\n            } else {\n                alert('No se encontraron resultados para esta ubicación.');\n            }\n        })\n        .catch(error => {\n            console.error('Error:', error);\n            alert('Falló la geocodificación.');\n        });\n}\n\n// 🔥 NUEVA FUNCIÓN: Extraer número de dirección\nfunction extractHouseNumber(fullAddress, roadName) {\n    if (!fullAddress || !roadName) return '';\n    \n    // Buscar patrones comunes de números\n    const patterns = [\n        /(?:No\\.|Num|#)\\s*(\\d+)/i,    // No. 366, Num 366, #366\n        /(\\d+)\\s*(?:#|No\\.|Num)/i,     // 366 #, 366 No.\n        /(\\d+)\\s*[-–]\\s*\\d+/i,         // 366-368\n        /(\\d+)[a-zA-Z]?$/i,            // 366, 366A\n        /^(\\d+)\\s+/i                   // 366 Calle 30\n    ];\n    \n    for (const pattern of patterns) {\n        const match = fullAddress.match(pattern);\n        if (match && match[1]) {\n            return match[1];\n        }\n    }\n    \n    // Si no se encuentra con patrones, intentar con el campo house_number de Nominatim\n    return '';\n}\n\nfunction populateAddressFields(address, latlng, fullAddress = '') {\n    // Extraer el número de casa\n    const houseNumber = address.house_number || extractHouseNumber(fullAddress, address.road);\n    \n    // Llenar los campos del formulario\n    document.getElementById('value_estado_1').value = address.state || '';\n    document.getElementById('value_ciudad_1').value = address.city || address.town || address.village || '';\n    document.getElementById('value_cp_1').value = address.postcode || '';\n    document.getElementById('value_colonia_1').value = address.suburb || address.neighbourhood || '';\n    document.getElementById('value_calle_1').value = address.road || '';\n    \n    // 🔥 NUEVO: Llenar el número exterior\n    document.getElementById('value_numeroext_1').value = houseNumber;\n    \n    document.getElementById('value_lat_1').value = latlng.lat;\n    document.getElementById('value_lng_1').value = latlng.lng;\n    \n    console.log('Datos completos de Nominatim:', address);\n    console.log('Dirección completa:', fullAddress);\n    console.log('Número extraído:', houseNumber);\n}\n\n// 🔥 OBSERVAR CUANDO EL TAB Y SECTION SE HACEN VISIBLES\nfunction checkMapContainer() {\n    const mapContainer = document.getElementById('map');\n    if (mapContainer.offsetParent !== null && mapContainer.offsetWidth > 0) {\n        initMap();\n        return true;\n    }\n    return false;\n}\n\ndocument.addEventListener('DOMContentLoaded', function() {\n    const interval = setInterval(() => {\n        if (checkMapContainer()) {\n            clearInterval(interval);\n        }\n    }, 200);\n    \n    document.body.addEventListener('click', function(e) {\n        if (e.target.closest('[data-toggle=\"tab\"], .step-tab, .nav-link')) {\n            setTimeout(() => {\n                if (mapInitialized) map.invalidateSize();\n                else if (checkMapContainer()) console.log('Mapa inicializado desde click en tab');\n            }, 400);\n        }\n    });\n});\n\nwindow.addEventListener('resize', () => {\n    if (mapInitialized) setTimeout(() => map.invalidateSize(), 100);\n});\n\nconst observer = new MutationObserver(function(mutations) {\n    mutations.forEach(function(mutation) {\n        if (mutation.type === 'attributes' && mutation.attributeName === 'style') {\n            setTimeout(() => {\n                if (mapInitialized) map.invalidateSize();\n            }, 200);\n        }\n    });\n});\n\nsetTimeout(() => {\n    const mapContainer = document.getElementById('map');\n    if (mapContainer) {\n        observer.observe(mapContainer, { attributes: true, attributeFilter: ['style'] });\n    }\n}, 1000);\n</script>\n\n\n\n\n\n\n\n\n\n<script>\n(function(){\n  // ========= IDs DE TUS CAMPOS =========\n  const IDS = {\n    calle:   'value_calle_1',\n    numext:  'value_numeroext_1',   // opcional\n    numint:  'value_numint_1',      // opcional\n    colonia: 'value_colonia_1',\n    ciudad:  'value_ciudad_1',\n    estado:  'value_estado_1',\n    cp:      'value_cp_1',\n    lat:     'value_lat_1',\n    lng:     'value_lng_1'\n  };\n\n  // ========= HELPERS =========\n  const $id = (id) => document.getElementById(id);\n  const safeTrim = (v) => (v || '').toString().trim();\n  const isValidLatLng = (lat, lng) => {\n    const a = Number(lat), b = Number(lng);\n    return Number.isFinite(a) && Number.isFinite(b) && a<=90 && a>=-90 && b<=180 && b>=-180;\n  };\n\n  function invalidateCoordsAndMarker(){\n    if ($id(IDS.lat)) $id(IDS.lat).value = '';\n    if ($id(IDS.lng)) $id(IDS.lng).value = '';\n    if (window.marker) { try { map.removeLayer(marker); } catch(e){} marker = null; }\n  }\n\n  function updateMarkerAndView(lat, lng, zoom){\n    if (!mapInitialized) initMap();\n    const latlng = L.latLng(lat, lng);\n    if (marker) marker.setLatLng(latlng);\n    else marker = L.marker(latlng).addTo(map);\n    map.setView(latlng, zoom || 17);\n  }\n\n  // ========= ESTADO INTERNO =========\n  let geocodeAbort = null;\n  let lastKey = '';\n\n  // ========= GEOCODERS =========\n  /** Paso 1: geocodificar colonia/CP para obtener bbox y centro */\n  async function geocodeArea({colonia, ciudad, estado, cp}) {\n    const parts = [\n      colonia || '',\n      ciudad  || 'Mérida',\n      estado  || 'Yucatán',\n      cp || '',\n      'México'\n    ].filter(Boolean).join(', ');\n\n    const url = `https://nominatim.openstreetmap.org/search?` +\n                new URLSearchParams({\n                  format: 'json',\n                  addressdetails: '1',\n                  limit: '1',\n                  countrycodes: 'mx',\n                  q: parts\n                }).toString();\n\n    const resp = await fetch(url, { headers: { 'Accept': 'application/json' } });\n    const data = await resp.json();\n    if (Array.isArray(data) && data.length) {\n      const item = data[0];\n      const bbox = item.boundingbox ? {\n        south: parseFloat(item.boundingbox[0]),\n        north: parseFloat(item.boundingbox[1]),\n        west:  parseFloat(item.boundingbox[2]),\n        east:  parseFloat(item.boundingbox[3])\n      } : null;\n\n      return {\n        lat: parseFloat(item.lat),\n        lon: parseFloat(item.lon),\n        bbox\n      };\n    }\n    return null;\n  }\n\n  /** Paso 2: buscar calle/número dentro de un viewbox (bounded=1) */\n  async function geocodeStreetInViewbox({street, ciudad, estado, cp, bbox}) {\n    const params = new URLSearchParams({\n      format: 'json',\n      addressdetails: '1',\n      limit: '1',\n      country: 'México',\n      city: ciudad || 'Mérida',\n      state: estado || 'Yucatán',\n      bounded: '1'\n    });\n    if (street) params.append('street', street);\n    if (cp)     params.append('postalcode', cp);\n\n    if (bbox) {\n      // viewbox: left,top,right,bottom => west,north,east,south\n      params.append('viewbox', `${bbox.west},${bbox.north},${bbox.east},${bbox.south}`);\n    }\n\n    let url = `https://nominatim.openstreetmap.org/search?${params.toString()}`;\n    let resp = await fetch(url, { headers: { 'Accept': 'application/json' } });\n    let data = await resp.json();\n\n    // Fallback a texto libre si no hay hit\n    if (!Array.isArray(data) || !data.length) {\n      const free = [\n        street || '',\n        ciudad || 'Mérida',\n        estado || 'Yucatán',\n        cp || '',\n        'México'\n      ].filter(Boolean).join(', ');\n\n      url = `https://nominatim.openstreetmap.org/search?` + new URLSearchParams({\n        format: 'json', addressdetails: '1', limit: '1', countrycodes: 'mx', q: free\n      }).toString();\n\n      resp = await fetch(url, { headers: { 'Accept': 'application/json' } });\n      data = await resp.json();\n    }\n\n    if (Array.isArray(data) && data.length) {\n      return {\n        lat: parseFloat(data[0].lat),\n        lon: parseFloat(data[0].lon)\n      };\n    }\n    return null;\n  }\n\n  /** Función principal: colonia/CP -> bbox y luego calle dentro del bbox */\n  async function geocodeAddressAndUpdateStructured(force=false){\n    const calle   = safeTrim($id(IDS.calle)?.value);\n    const numext  = safeTrim($id(IDS.numext)?.value);\n    const numint  = safeTrim($id(IDS.numint)?.value);\n    const colonia = safeTrim($id(IDS.colonia)?.value);\n    const ciudad  = safeTrim($id(IDS.ciudad)?.value)  || 'MERIDA';\n    const estado  = safeTrim($id(IDS.estado)?.value)  || 'YUCATAN';\n    const cp      = safeTrim($id(IDS.cp)?.value);\n\n    const streetParts = [calle, numext, numint ? `Int ${numint}` : ''].filter(Boolean);\n    const street = streetParts.join(' ');\n\n    // Requisitos mínimos: (calle o colonia o cp) + ciudad + estado\n    if (!( (street || colonia || cp) && ciudad && estado )) return;\n\n    // Evita repeticiones si no es \"force\"\n    const key = JSON.stringify({street, colonia, ciudad, estado, cp}).toUpperCase();\n    if (!force && key === lastKey) return;\n    lastKey = key;\n\n    // Cancela petición previa si existe\n    if (geocodeAbort) geocodeAbort.abort();\n    geocodeAbort = new AbortController();\n\n    let area = null;\n\n    // 1) Si hay colonia o CP, obten bbox del área\n    if (colonia || cp) {\n      try { area = await geocodeArea({ colonia, ciudad, estado, cp }); }\n      catch(e){ console.warn('[MAP] geocodeArea error', e); }\n    }\n\n    // 2) Si hay calle, intenta ubicarla dentro del bbox del área\n    if (street) {\n      try {\n        const hit = await geocodeStreetInViewbox({ street, ciudad, estado, cp, bbox: area?.bbox });\n        if (hit && isValidLatLng(hit.lat, hit.lon)) {\n          if ($id(IDS.lat)) $id(IDS.lat).value = hit.lat;\n          if ($id(IDS.lng)) $id(IDS.lng).value = hit.lon;\n          updateMarkerAndView(hit.lat, hit.lon, 18);\n          geocodeAbort = null;\n          return;\n        }\n      } catch(e){\n        console.warn('[MAP] geocodeStreetInViewbox error', e);\n      }\n    }\n\n    // 3) Sin calle (o sin hit), usa el centro de la colonia/CP si existe\n    if (area && isValidLatLng(area.lat, area.lon)) {\n      if ($id(IDS.lat)) $id(IDS.lat).value = area.lat;\n      if ($id(IDS.lng)) $id(IDS.lng).value = area.lon;\n      const zoom = colonia ? 16 : 15;\n      updateMarkerAndView(area.lat, area.lon, zoom);\n      geocodeAbort = null;\n      return;\n    }\n\n    // 4) Fallback total: búsqueda libre con todo\n    try {\n      const free = [street, colonia, ciudad, estado, cp, 'México'].filter(Boolean).join(', ');\n      const url = `https://nominatim.openstreetmap.org/search?` + new URLSearchParams({\n        format:'json', addressdetails:'1', limit:'1', countrycodes:'mx', q: free\n      }).toString();\n      const resp = await fetch(url, { headers: { 'Accept':'application/json' } });\n      const data = await resp.json();\n      if (Array.isArray(data) && data.length) {\n        const lat = parseFloat(data[0].lat), lon = parseFloat(data[0].lon);\n        if (isValidLatLng(lat, lon)) {\n          if ($id(IDS.lat)) $id(IDS.lat).value = lat;\n          if ($id(IDS.lng)) $id(IDS.lng).value = lon;\n          updateMarkerAndView(lat, lon, street ? 18 : (colonia ? 16 : 15));\n        }\n      }\n    } catch(e){\n      console.error('[MAP] fallback free-text error', e);\n    } finally {\n      geocodeAbort = null;\n    }\n  }\n\n  // ========= LISTENERS (sin temporizadores) =========\n  function attachListeners(){\n    const finishEvents = ['change','blur','focusout','compositionend','keydown'];\n\n    function onFinish(ev){\n      if (ev.type === 'keydown' && ev.key !== 'Enter') return;\n      if (!ev.isTrusted) return; // ignora cambios programáticos\n      invalidateCoordsAndMarker();\n      geocodeAddressAndUpdateStructured(true);\n    }\n\n    // Disparadores: calle, colonia, ciudad, estado, CP\n    [IDS.calle, IDS.colonia, IDS.ciudad, IDS.estado, IDS.cp].forEach(id => {\n      const el = $id(id);\n      if (!el) return;\n      finishEvents.forEach(evt => el.addEventListener(evt, onFinish));\n    });\n\n    // Lat/Lng manuales\n    function moveByLatLng(ev){\n      if (ev.type === 'keydown' && ev.key !== 'Enter') return;\n      const lat = safeTrim($id(IDS.lat)?.value);\n      const lng = safeTrim($id(IDS.lng)?.value);\n      if (isValidLatLng(lat, lng)) updateMarkerAndView(Number(lat), Number(lng), 18);\n    }\n    [IDS.lat, IDS.lng].forEach(id => {\n      const el = $id(id);\n      if (!el) return;\n      ['change','blur','focusout','keydown'].forEach(evt => el.addEventListener(evt, moveByLatLng));\n    });\n  }\n\n  // ========= ARRANQUE =========\n  document.addEventListener('DOMContentLoaded', () => {\n    attachListeners();\n\n    // Si ya hay coords, centra ahí\n    const lat = safeTrim($id(IDS.lat)?.value);\n    const lng = safeTrim($id(IDS.lng)?.value);\n    if (isValidLatLng(lat, lng)){\n      updateMarkerAndView(Number(lat), Number(lng), 18);\n    } else {\n      // Si hay (calle o colonia o CP) + ciudad/estado, geocodifica de entrada\n      const calle   = safeTrim($id(IDS.calle)?.value);\n      const colonia = safeTrim($id(IDS.colonia)?.value);\n      const ciudad  = safeTrim($id(IDS.ciudad)?.value) || 'MERIDA';\n      const estado  = safeTrim($id(IDS.estado)?.value) || 'YUCATAN';\n      const cp      = safeTrim($id(IDS.cp)?.value);\n      if ((calle || colonia || cp) && ciudad && estado){\n        geocodeAddressAndUpdateStructured(true);\n      }\n    }\n  });\n\n})();\n</script>\n",
						"type": 0
					},
					"editedByRte": false
				},
				"integrated_edit_field16": {
					"field": "colonia",
					"type": "integrated_edit_field",
					"updateOnEdit": false,
					"customCSS": "/* Put  your custom CSS code here */\n\n",
					"orientation": 0
				},
				"integrated_edit_field13": {
					"field": "calle",
					"type": "integrated_edit_field",
					"updateOnEdit": false,
					"orientation": 0
				},
				"integrated_edit_field14": {
					"field": "numeroext",
					"type": "integrated_edit_field",
					"updateOnEdit": false,
					"orientation": 0
				},
				"integrated_edit_field15": {
					"field": "numeroint",
					"type": "integrated_edit_field",
					"updateOnEdit": false,
					"orientation": 0
				},
				"integrated_edit_field11": {
					"field": "ciudad",
					"type": "integrated_edit_field",
					"updateOnEdit": false,
					"orientation": 0
				},
				"integrated_edit_field10": {
					"field": "estado",
					"type": "integrated_edit_field",
					"updateOnEdit": false,
					"orientation": 0
				},
				"integrated_edit_field12": {
					"field": "cp",
					"type": "integrated_edit_field",
					"updateOnEdit": false,
					"orientation": 0
				},
				"integrated_edit_field17": {
					"field": "lat",
					"type": "integrated_edit_field",
					"updateOnEdit": false,
					"orientation": 0
				},
				"integrated_edit_field18": {
					"field": "lng",
					"type": "integrated_edit_field",
					"updateOnEdit": false,
					"orientation": 0
				},
				"section2": {
					"type": "section",
					"title": {
						"text": "<i class=\"fa-solid fa-location-dot\" style=\"font-size:1.5em; color:#fff;\"></i> Dirección de Entrega",
						"type": 0
					},
					"location": "section2",
					"bsStyle": "default",
					"panelType": 3,
					"initiallyClosed": true
				},
				"sec_venta": {
					"type": "section",
					"title": {
						"text": "<i class=\"fa-solid fa-cart-shopping\" style=\"font-size:1.5em; color:#fff;\"></i> Información de la Venta",
						"type": 0
					},
					"location": "section1",
					"bsStyle": "default",
					"panelType": 3,
					"headerBg": "",
					"headerColor": "",
					"bodyBg": "",
					"bodyColor": "",
					"panelBorder": null,
					"borderColor": "",
					"initiallyClosed": true
				},
				"sec_cliente": {
					"type": "section",
					"title": {
						"text": "<i class=\"fa-solid fa-user\" style=\"font-size:1.5em; color:#fff;\"></i> Datos del Cliente",
						"type": 0
					},
					"location": "section",
					"bsStyle": "default",
					"panelType": 3,
					"headerBg": "",
					"headerColor": "",
					"bodyBg": "",
					"bodyColor": "",
					"panelBorder": null,
					"borderColor": "",
					"initiallyClosed": true
				},
				"image": {
					"type": "image",
					"image": {
						"image": "LOGO NEGRO Y AZUL PEQUE.png",
						"source": 2
					},
					"width": "168px",
					"height": "80px"
				}
			},
			"dbProps": {},
			"version": 13,
			"pageWidth": "standard",
			"imageItem": {
				"type": "page_image",
				"image": null
			},
			"imageBgColor": "#f2f2f2",
			"controlsBgColor": "white",
			"imagePosition": "right",
			"pageCSS": "\n/* Put  your custom CSS code here */\n\n\n\n/* ========================================================= */\n/* VARIABLES DE COLOR */\n/* ========================================================= */\n:root {\n    --color-elegante: #FFFFFF; /* Texto Blanco para contrastar con el fondo oscuro */\n    --naranja-degradado-inicio: #03478A; /* Naranja Suave (Light Salmon) */\n    --naranja-degradado-fin: #6D98C2; /* Naranja Medio (Coral) */\n    --color-borde-base: #FF7F50; /* Color simple para el borde base */\n}\n\n/* ========================================================= */\n/* 1. Fondo de la Página: Degradado Azul Cielo (Se mantiene) */\n/* ========================================================= */\nbody, .container-fluid {\nbackground: linear-gradient(180deg, #FAFAF7 0%, #D6D6D4 100%) !important;    min-height: 100vh;\n}\n\n/* ========================================================= */\n/* 2. Estilo de las Secciones: Efecto Tarjeta/Sombreado (Se mantiene) */\n/* ========================================================= */\n.panel, .rnr-c-body, .rnr-c-grid {\n    background-color: #FFFFFF !important; \n    border: none !important; \n    border-radius: 12px !important; \n    padding: 20px;\n    margin-bottom: 25px; \n    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1), \n                0 2px 6px rgba(0, 0, 0, 0.05) !important; \n                \n    /* 🔑 CAMBIO CLAVE: Agrega 'transform' a la transición */\n    transition: box-shadow 0.3s ease-in-out, \n                transform 0.3s ease-in-out; /* Transición para el movimiento y escala */            \n                \n}\n\n/* ========================================================= */\n/* 3. Estilo de Encabezados de Sección (EL CAMBIO PRINCIPAL) */\n/* ========================================================= */\n.panel-heading, .rnr-c-head {\n    /* Aplicamos el degradado al fondo completo del encabezado */\n    background: linear-gradient(to right, var(--naranja-degradado-inicio), var(--naranja-degradado-fin)) !important;\n    \n    /* El texto del título ahora es blanco para contrastar con el fondo naranja */\n    color: var(--color-elegante) !important; \n    \n    font-weight: 600;\n    \n    /* Mantenemos el centrado vertical */\n    display: flex;\n    align-items: center;\n    height: 40px; /* Aseguramos una altura suficiente */\n    \n    /* Eliminamos el borde degradado y aplicamos un borde simple y fino abajo */\n    border-bottom: 1px solid var(--color-borde-base) !important; \n    border-image-source: none !important; /* Desactivar la propiedad border-image anterior */\n    \n    /* Ajustes de relleno/bordes para que el degradado se vea bien */\n    padding: 0 15px !important; \n    border-top-left-radius: 12px !important; /* Mantenemos el radio del panel superior */\n    border-top-right-radius: 12px !important;\n}\n\n/* ========================================================= */\n/* 3. Estilo de HOVER: Efecto de Elevación/Intensificación    */\n/* ========================================================= */\n.panel:hover, .rnr-c-body:hover, .rnr-c-grid:hover {\n    /* Nueva sombra más intensa y \"elevada\" */\n    box-shadow: 0 15px 400px rgba(0, 0, 0, 0.3), \n                0 5px 15px rgba(0, 0, 0, 0.1) !important; \n    \n    /* Pequeño movimiento hacia arriba para dar más sensación de elevación (opcional) */\n    transform: translateY(-5px) scale(1.005); \n}\n\n\n\n/* 4. Estilo de los Inputs (Se mantiene) */\n.form-control {\n    border-radius: 8px !important; \n    border: 1px solid #e0e0e0 !important;\n}\n.form-control:focus {\n    border-color: #48C9B0 !important; \n    box-shadow: 0 0 0 0.2rem rgba(72, 201, 176, 0.25) !important;\n}\n\n/* Aplica solo a formularios con esas secciones */\n.panel.panel-default.form-section > .panel-body { display: none; }\n\n.panel.panel-default.form-section > .panel-heading:hover {\n  cursor: pointer;\n  filter: brightness(0.98);\n}\n\n.panel-collapse.no-bs-trans {\n  transition: none !important;\n}\n\n/* ========================================================= */\n/* ARREGLO DE COLOR DE TEXTO DE ENCABEZADO DURANTE MODAL     */\n/* ========================================================= */\n\n/* Apuntamos directamente al panel-title, que es el elemento que contiene \n   el texto del encabezado de la sección. \n*/\n.panel-heading .panel-title {\n    color: #FFFFFF !important; \n}\n\n/* Si dentro del panel-title hay un enlace (Ej. si el encabezado permite colapsar/expandir \n   y el título es un <a>), también debemos forzar el color del enlace.\n*/\n.panel-heading .panel-title a {\n    color: #FFFFFF !important;\n}\n\n/* Asegurar que el texto dentro del panel-title no se vea afectado por reglas generales\n   que usen el estado 'modal-open' en el cuerpo de la página.\n*/\n.modal-open .panel-heading .panel-title {\n    color: #FFFFFF !important;\n}",
			"listTotals": 1,
			"title": {}
		},
		{
			"id": "view",
			"type": "view",
			"layoutId": "nomenu",
			"disabled": false,
			"default": 0,
			"forms": {
				"above-grid": {
					"modelId": "view-above-grid",
					"grid": [
						{
							"cells": [
								{
									"cell": "c1",
									"colspan": 2
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c1": {
							"model": "c1",
							"items": []
						}
					},
					"deferredItems": [],
					"recsPerRow": 1
				},
				"below-grid": {
					"modelId": "view-below-grid",
					"grid": [
						{
							"cells": [
								{
									"cell": "c1"
								},
								{
									"cell": "c2"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c1": {
							"model": "c1",
							"items": [
								"view_back_list",
								"view_close"
							]
						},
						"c2": {
							"model": "c2",
							"items": [
								"hamburger"
							]
						}
					},
					"deferredItems": [],
					"recsPerRow": 1
				},
				"top": {
					"modelId": "view-header",
					"grid": [
						{
							"cells": [
								{
									"cell": "c1"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c1": {
							"model": "c1",
							"items": [
								"view_header"
							]
						}
					},
					"deferredItems": [],
					"recsPerRow": 1
				},
				"grid": {
					"modelId": "simple-edit",
					"grid": [
						{
							"cells": [
								{
									"cell": "c3"
								},
								{
									"cell": "c"
								}
							],
							"section": ""
						},
						{
							"cells": [
								{
									"cell": "c4",
									"colspan": 2,
									"rowspan": 1
								}
							],
							"section": ""
						},
						{
							"cells": [
								{
									"cell": "c5",
									"colspan": 2
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c3": {
							"model": "c3",
							"items": [
								"section"
							],
							"border": [
								{
									"side": "",
									"width": "0"
								}
							],
							"padding": {
								"right": "10px"
							}
						},
						"c": {
							"model": "c3",
							"items": [
								"section1"
							]
						},
						"c4": {
							"model": "c3",
							"items": [
								"section2"
							]
						},
						"c5": {
							"model": "c3",
							"items": [
								"integrated_edit_field17",
								"integrated_edit_field18",
								"integrated_edit_field19",
								"integrated_edit_field20",
								"integrated_edit_field21",
								"integrated_edit_field22",
								"integrated_edit_field23",
								"integrated_edit_field24",
								"integrated_edit_field25",
								"integrated_edit_field26",
								"integrated_edit_field27",
								"integrated_edit_field28",
								"integrated_edit_field29"
							]
						}
					},
					"deferredItems": [],
					"columnCount": 1,
					"inlineLabels": false,
					"separateLabels": false
				},
				"section": {
					"modelId": "simple-edit",
					"grid": [
						{
							"cells": [
								{
									"cell": "c1"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c1": {
							"model": "c1",
							"items": [
								"integrated_edit_field3",
								"integrated_edit_field4",
								"integrated_edit_field5",
								"integrated_edit_field1",
								"integrated_edit_field6",
								"integrated_edit_field9"
							]
						}
					},
					"deferredItems": [],
					"columnCount": 1,
					"inlineLabels": false,
					"separateLabels": false
				},
				"section1": {
					"modelId": "simple-edit",
					"grid": [
						{
							"cells": [
								{
									"cell": "c1"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c1": {
							"model": "c1",
							"items": [
								"integrated_edit_field",
								"integrated_edit_field2",
								"integrated_edit_field7",
								"integrated_edit_field8"
							]
						}
					},
					"deferredItems": [],
					"columnCount": 1,
					"inlineLabels": false,
					"separateLabels": false
				},
				"section2": {
					"modelId": "simple-edit",
					"grid": [
						{
							"cells": [
								{
									"cell": "c1"
								},
								{
									"cell": "c"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c1": {
							"model": "c1",
							"items": [
								"integrated_edit_field13",
								"integrated_edit_field14",
								"integrated_edit_field15",
								"integrated_edit_field16"
							]
						},
						"c": {
							"model": "c1",
							"items": [
								"integrated_edit_field11",
								"integrated_edit_field10",
								"integrated_edit_field12",
								"text"
							]
						}
					},
					"deferredItems": [],
					"columnCount": 1,
					"inlineLabels": false,
					"separateLabels": false
				}
			},
			"items": {
				"view_header": {
					"type": "view_header"
				},
				"view_back_list": {
					"type": "view_back_list"
				},
				"view_close": {
					"type": "view_close"
				},
				"hamburger": {
					"type": "hamburger",
					"items": [
						"view_edit"
					]
				},
				"view_edit": {
					"type": "view_edit"
				},
				"section": {
					"type": "section",
					"title": {
						"type": 0,
						"text": "Datos del cliente"
					},
					"location": "section",
					"bsStyle": "default",
					"panelType": 3,
					"headerBg": "#3e58f3",
					"headerColor": "#f9f6c1",
					"bodyBg": "#565050",
					"bodyColor": "#f3f3f2",
					"panelBorder": "1px",
					"borderColor": "#d7f5e2"
				},
				"integrated_edit_field3": {
					"field": "idcliente",
					"type": "integrated_edit_field",
					"orientation": 0,
					"placeholder": {
						"field": "idcliente",
						"table": "solicitudes",
						"type": 5
					}
				},
				"integrated_edit_field4": {
					"field": "paterno",
					"type": "integrated_edit_field",
					"orientation": 0,
					"placeholder": {
						"field": "paterno",
						"table": "solicitudes",
						"type": 5
					}
				},
				"integrated_edit_field5": {
					"field": "materno",
					"type": "integrated_edit_field",
					"orientation": 0,
					"placeholder": {
						"field": "materno",
						"table": "solicitudes",
						"type": 5
					}
				},
				"integrated_edit_field1": {
					"field": "nombre",
					"type": "integrated_edit_field",
					"orientation": 0,
					"placeholder": {
						"field": "nombre",
						"table": "solicitudes",
						"type": 5
					},
					"label": {
						"field": "nombre",
						"table": "solicitudes",
						"type": 3
					}
				},
				"integrated_edit_field6": {
					"field": "rfc",
					"type": "integrated_edit_field",
					"orientation": 0
				},
				"integrated_edit_field9": {
					"field": "idcli",
					"type": "integrated_edit_field",
					"orientation": 0
				},
				"section1": {
					"type": "section",
					"title": {
						"type": 0,
						"text": "Datos de la solicitud"
					},
					"location": "section1",
					"bsStyle": "default",
					"panelType": 3,
					"headerBg": "#3e58f3",
					"headerColor": "#f9f6c1",
					"bodyBg": "#565050",
					"bodyColor": "#f3f3f2",
					"panelBorder": "1px",
					"borderColor": "#d7f5e2"
				},
				"integrated_edit_field": {
					"field": "idproducto",
					"type": "integrated_edit_field",
					"orientation": 0,
					"placeholder": {
						"field": "idproducto",
						"table": "solicitudes",
						"type": 5
					}
				},
				"integrated_edit_field2": {
					"field": "idplan",
					"type": "integrated_edit_field",
					"orientation": 0,
					"placeholder": {
						"field": "idplan",
						"table": "solicitudes",
						"type": 5
					}
				},
				"integrated_edit_field7": {
					"field": "orden",
					"type": "integrated_edit_field",
					"orientation": 0,
					"placeholder": {
						"field": "orden",
						"table": "solicitudes",
						"type": 5
					}
				},
				"integrated_edit_field8": {
					"field": "plazo",
					"type": "integrated_edit_field",
					"orientation": 0,
					"placeholder": {
						"field": "plazo",
						"table": "solicitudes",
						"type": 5
					}
				},
				"section2": {
					"type": "section",
					"title": {
						"type": 0,
						"text": "Datos de entrega"
					},
					"location": "section2",
					"bsStyle": "default",
					"panelType": 3,
					"headerBg": "#3e58f3",
					"headerColor": "#f9f6c1",
					"bodyBg": "#565050",
					"bodyColor": "#f3f3f2",
					"panelBorder": "1px",
					"borderColor": "#d7f5e2"
				},
				"integrated_edit_field13": {
					"field": "calle",
					"type": "integrated_edit_field",
					"orientation": 0
				},
				"integrated_edit_field14": {
					"field": "numeroext",
					"type": "integrated_edit_field",
					"orientation": 0
				},
				"integrated_edit_field15": {
					"field": "numeroint",
					"type": "integrated_edit_field",
					"orientation": 0
				},
				"integrated_edit_field16": {
					"field": "colonia",
					"type": "integrated_edit_field",
					"orientation": 0
				},
				"integrated_edit_field11": {
					"field": "ciudad",
					"type": "integrated_edit_field",
					"orientation": 0
				},
				"integrated_edit_field10": {
					"field": "estado",
					"type": "integrated_edit_field",
					"orientation": 0
				},
				"integrated_edit_field12": {
					"field": "cp",
					"type": "integrated_edit_field",
					"orientation": 0
				},
				"text": {
					"type": "text",
					"label": {
						"text": "<div id=\"map\" style=\"height: 400px; width: 100%; margin-bottom: 10px; border: 1px solid #ccc;\"></div>\n<p><strong>Haz clic en el mapa para establecer la ubicación.</strong></p>\n\n<!-- Cargar la API de Google Maps (Reemplaza TU_API_KEY) -->\n<script src=\"https://maps.googleapis.com/maps/api/js?key=AIzaSyA2P1eBUfOvpeXBIWM5t5Drg3EjZc25Tzs&callback=initMap&libraries=places&v=weekly\" async defer></script>\n\n<script>\n// Variables globales\nlet map;\nlet marker;\nlet geocoder;\n\nfunction initMap() {\n    // Coordenadas iniciales\n    const initialLocation = { lat: 21.0038, lng: -89.6183 };\n    // Crear el mapa\n    map = new google.maps.Map(document.getElementById(\"map\"), {\n        zoom: 12,\n        center: initialLocation,\n        mapTypeId: google.maps.MapTypeId.ROADMAP\n    });\n    // Inicializar el geocoder\n    geocoder = new google.maps.Geocoder();\n    // Escuchar el evento de clic en el mapa\n    map.addListener('click', function(event) {\n        placeMarkerAndGeocode(event.latLng);\n    });\n}\n\nfunction placeMarkerAndGeocode(location) {\n    // Limpiar el marcador anterior si existe\n    if (marker) {\n        marker.setMap(null);\n    }\n    // Colocar un nuevo marcador\n    marker = new google.maps.Marker({\n        position: location,\n        map: map\n    });\n    // Centrar el mapa en la nueva ubicación\n    map.panTo(location);\n    // Obtener la dirección a partir de las coordenadas (Geocodificación Inversa)\n    geocoder.geocode({ 'location': location }, function(results, status) {\n        if (status === 'OK') {\n            if (results[0]) {\n                // Llenar los campos del formulario con los datos obtenidos\n                populateAddressFields(results[0]);\n            } else {\n                alert('No se encontraron resultados para esta ubicación.');\n            }\n        } else {\n            alert('Falló la geocodificación: ' + status);\n        }\n    });\n}\n\nfunction populateAddressFields(addressData) {\n    // Esta función descompone la respuesta de geocodificación y llena los campos.\n    // La estructura de 'address_components' puede variar, ¡debes ajustarla!\n    \n    let addressComponents = addressData.address_components;\n    let addressLookup = {};\n    \n    // Crear un objeto fácil de buscar a partir de los componentes\n    addressComponents.forEach(component => {\n        component.types.forEach(type => {\n            addressLookup[type] = component.long_name;\n        });\n    });\n    // Llenar los campos del formulario de PHPRunner.\n    // ¡IMPORTANTE! Reemplaza 'Editbox1' con los nombres REALES de tus campos.\n    // Puedes encontrar el nombre real del campo en la pestaña \"Fields\" de PHPRunner.\n    \n    // Usar getElementById o un selector por nombre\n    document.getElementById('value_estado_1').value = addressLookup['administrative_area_level_1'] || ''; // Estado\n    document.getElementById('value_ciudad_1').value = addressLookup['locality'] || addressLookup['administrative_area_level_2'] || ''; // Ciudad o Municipio\n    document.getElementById('value_cp_1').value = addressLookup['postal_code'] || ''; // Código Postal\n    document.getElementById('value_colonia_1').value = addressLookup['sublocality_level_1'] || addressLookup['neighborhood'] || ''; // Colonia\n    document.getElementById('value_calle_1').value = getRoute(addressComponents) || ''; // Calle\n}\n\n// Función de ayuda para obtener el nombre de la calle\nfunction getRoute(components) {\n    for (let i = 0; i < components.length; i++) {\n        if (components[i].types.includes('route')) {\n            return components[i].long_name;\n        }\n    }\n    return '';\n}\n// Inicializar el mapa cuando la página esté cargada\n// Google Maps llama a 'initMap' automáticamente por el callback en la URL de la API\n</script>",
						"type": 0
					},
					"editedByRte": false
				},
				"integrated_edit_field17": {
					"field": "idtipoventa",
					"type": "integrated_edit_field",
					"orientation": 0
				},
				"integrated_edit_field18": {
					"field": "dn",
					"type": "integrated_edit_field",
					"orientation": 0
				},
				"integrated_edit_field19": {
					"field": "cuenta",
					"type": "integrated_edit_field",
					"orientation": 0
				},
				"integrated_edit_field20": {
					"field": "contrato",
					"type": "integrated_edit_field",
					"orientation": 0
				},
				"integrated_edit_field21": {
					"field": "contratoportal",
					"type": "integrated_edit_field",
					"orientation": 0
				},
				"integrated_edit_field22": {
					"field": "plazopendiente",
					"type": "integrated_edit_field",
					"orientation": 0
				},
				"integrated_edit_field23": {
					"field": "factura",
					"type": "integrated_edit_field",
					"orientation": 0
				},
				"integrated_edit_field24": {
					"field": "fechavenci",
					"type": "integrated_edit_field",
					"orientation": 0
				},
				"integrated_edit_field25": {
					"field": "ciclo",
					"type": "integrated_edit_field",
					"orientation": 0
				},
				"integrated_edit_field26": {
					"field": "dnpreferido",
					"type": "integrated_edit_field",
					"orientation": 0
				},
				"integrated_edit_field27": {
					"field": "lat",
					"type": "integrated_edit_field",
					"orientation": 0
				},
				"integrated_edit_field28": {
					"field": "lng",
					"type": "integrated_edit_field",
					"orientation": 0
				},
				"integrated_edit_field29": {
					"field": "noserie",
					"type": "integrated_edit_field",
					"orientation": 0
				}
			},
			"dbProps": {},
			"version": 13,
			"imageItem": {
				"type": "page_image"
			},
			"imageBgColor": "#f2f2f2",
			"controlsBgColor": "white",
			"imagePosition": "right",
			"listTotals": 1,
			"title": {}
		},
		{
			"id": "list",
			"type": "list",
			"layoutId": "leftbar",
			"disabled": false,
			"default": 0,
			"forms": {
				"above-grid": {
					"modelId": "list-above-grid",
					"grid": [
						{
							"cells": [
								{
									"cell": "c1"
								},
								{
									"cell": "c2"
								}
							],
							"section": ""
						},
						{
							"cells": [
								{
									"cell": "c3"
								},
								{
									"cell": "c4"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c1": {
							"model": "c1",
							"items": [
								"add",
								"inline_save_all",
								"inline_cancel_all",
								"delete"
							]
						},
						"c2": {
							"model": "c2",
							"items": [
								"text1",
								"snippet",
								"text",
								"snippet1",
								"details_found",
								"page_size",
								"print_panel"
							]
						},
						"c3": {
							"model": "c3",
							"items": []
						},
						"c4": {
							"model": "c4",
							"items": []
						}
					},
					"deferredItems": [],
					"recsPerRow": 1
				},
				"below-grid": {
					"modelId": "list-below-grid",
					"grid": [
						{
							"cells": [
								{
									"cell": "c1"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c1": {
							"model": "c1",
							"items": [
								"pagination"
							]
						}
					},
					"deferredItems": [],
					"recsPerRow": 1
				},
				"left": {
					"modelId": "leftbar-menu",
					"grid": [
						{
							"cells": [
								{
									"cell": "c0"
								}
							],
							"section": ""
						},
						{
							"cells": [
								{
									"cell": "c1"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c0": {
							"model": "c0",
							"items": [
								"logo",
								"expand_button"
							]
						},
						"c1": {
							"model": "c1",
							"items": [
								"menu"
							]
						}
					},
					"deferredItems": [],
					"recsPerRow": 1
				},
				"supertop": {
					"modelId": "leftbar-top",
					"grid": [
						{
							"cells": [
								{
									"cell": "c1"
								},
								{
									"cell": "c2"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c1": {
							"model": "c1",
							"items": [
								"expand_menu_button",
								"collapse_button",
								"breadcrumb"
							]
						},
						"c2": {
							"model": "c2",
							"items": [
								"simple_search",
								"list_options",
								"loginform_login",
								"username_button"
							]
						}
					},
					"deferredItems": [],
					"recsPerRow": 1
				},
				"top": {
					"modelId": "list-sidebar-top",
					"grid": [],
					"cells": {},
					"deferredItems": [],
					"recsPerRow": 1
				},
				"grid": {
					"modelId": "horizontal-grid",
					"grid": [
						{
							"section": "head",
							"cells": [
								{
									"cell": "headcell_icons"
								},
								{
									"cell": "headcell_checkbox"
								},
								{
									"cell": "headcell_field2"
								},
								{
									"cell": "headcell_field3"
								},
								{
									"cell": "headcell_field17"
								},
								{
									"cell": "headcell_field4"
								},
								{
									"cell": "headcell_field12"
								},
								{
									"cell": "headcell_field"
								},
								{
									"cell": "headcell_field7"
								},
								{
									"cell": "headcell_field9"
								},
								{
									"cell": "headcell_field10"
								},
								{
									"cell": "headcell_field8"
								},
								{
									"cell": "headcell_field13"
								}
							]
						},
						{
							"section": "body",
							"cells": [
								{
									"cell": "cell_icons"
								},
								{
									"cell": "cell_checkbox"
								},
								{
									"cell": "cell_field2"
								},
								{
									"cell": "headcell_field5"
								},
								{
									"cell": "headcell_field15"
								},
								{
									"cell": "cell_field4"
								},
								{
									"cell": "cell_field12"
								},
								{
									"cell": "cell_field"
								},
								{
									"cell": "cell_field3"
								},
								{
									"cell": "cell_field6"
								},
								{
									"cell": "headcell_field11"
								},
								{
									"cell": "cell_field5"
								},
								{
									"cell": "cell_field7"
								}
							]
						},
						{
							"cells": [
								{
									"cell": "cell_dpreview",
									"colspan": 13
								}
							],
							"section": "body"
						},
						{
							"section": "foot",
							"cells": [
								{
									"cell": "footcell_icons"
								},
								{
									"cell": "footcell_checkbox"
								},
								{
									"cell": "footcell_field2"
								},
								{
									"cell": "headcell_field6",
									"colspan": 2
								},
								{
									"cell": "footcell_field4"
								},
								{
									"cell": "footcell_field12"
								},
								{
									"cell": "footcell_field"
								},
								{
									"cell": "footcell_field3"
								},
								{
									"cell": "footcell_field6"
								},
								{
									"cell": "headcell_field14"
								},
								{
									"cell": "footcell_field5"
								},
								{
									"cell": "footcell_field7"
								}
							]
						}
					],
					"cells": {
						"headcell_field2": {
							"model": "headcell_field",
							"items": [
								"simple_grid_field31"
							],
							"field": "fecha",
							"columnName": "field"
						},
						"cell_field2": {
							"model": "cell_field",
							"items": [
								"simple_grid_field2"
							],
							"field": "fecha",
							"columnName": "field"
						},
						"footcell_field2": {
							"model": "footcell_field",
							"items": [],
							"columnName": "field",
							"field": "fecha"
						},
						"headcell_field4": {
							"model": "headcell_field",
							"items": [
								"grid_field_label"
							],
							"field": "descripcion",
							"columnName": "field"
						},
						"cell_field4": {
							"model": "cell_field",
							"items": [
								"grid_field"
							],
							"field": "descripcion",
							"columnName": "field"
						},
						"footcell_field4": {
							"model": "footcell_field",
							"items": [],
							"columnName": "field",
							"field": "descripcion"
						},
						"headcell_field12": {
							"model": "headcell_field",
							"items": [
								"simple_grid_field41"
							],
							"field": "estatus",
							"columnName": "field"
						},
						"cell_field12": {
							"model": "cell_field",
							"items": [
								"simple_grid_field12"
							],
							"field": "estatus",
							"columnName": "field"
						},
						"footcell_field12": {
							"model": "footcell_field",
							"items": [],
							"columnName": "field",
							"field": "estatus"
						},
						"headcell_checkbox": {
							"model": "headcell_checkbox",
							"items": [
								"grid_checkbox_head"
							],
							"columnName": "checkbox",
							"field": ""
						},
						"cell_checkbox": {
							"model": "cell_checkbox",
							"items": [
								"grid_checkbox"
							],
							"columnName": "checkbox",
							"field": ""
						},
						"footcell_checkbox": {
							"model": "footcell_checkbox",
							"items": [],
							"columnName": "checkbox",
							"field": ""
						},
						"headcell_icons": {
							"model": "headcell_icons",
							"items": [],
							"columnName": "list-icons",
							"field": ""
						},
						"cell_icons": {
							"model": "cell_icons",
							"items": [
								"grid_edit",
								"grid_inline_edit",
								"grid_inline_save",
								"grid_inline_cancel",
								"grid_view"
							],
							"orientation": "horizontal",
							"columnName": "list-icons",
							"field": ""
						},
						"footcell_icons": {
							"model": "footcell_icons",
							"items": [],
							"columnName": "list-icons",
							"field": ""
						},
						"headcell_field": {
							"model": "headcell_field",
							"items": [
								"simple_grid_field39"
							],
							"field": "orden",
							"columnName": "field"
						},
						"cell_field": {
							"model": "cell_field",
							"items": [
								"simple_grid_field10"
							],
							"field": "orden",
							"columnName": "field"
						},
						"footcell_field": {
							"model": "footcell_field",
							"items": [],
							"columnName": "field",
							"field": "orden"
						},
						"headcell_field3": {
							"model": "headcell_field",
							"items": [
								"simple_grid_field33"
							],
							"field": "",
							"columnName": ""
						},
						"headcell_field5": {
							"model": "cell_field",
							"items": [
								"simple_grid_field4"
							],
							"field": "",
							"columnName": ""
						},
						"headcell_field6": {
							"model": "footcell_field",
							"items": [],
							"columnName": "",
							"field": ""
						},
						"headcell_field7": {
							"model": "headcell_field",
							"items": [
								"grid_field_label2"
							],
							"field": "estatusentrega",
							"columnName": "field"
						},
						"cell_field3": {
							"model": "cell_field",
							"items": [
								"grid_field2"
							],
							"field": "estatusentrega",
							"columnName": "field",
							"align": "center",
							"bold": true,
							"underline": true
						},
						"footcell_field3": {
							"model": "footcell_field",
							"items": [],
							"columnName": "field",
							"field": "estatusentrega"
						},
						"headcell_field9": {
							"model": "headcell_field",
							"items": [
								"grid_field_label4"
							],
							"field": "chip",
							"columnName": "field"
						},
						"cell_field6": {
							"model": "cell_field",
							"items": [
								"grid_field4"
							],
							"field": "chip",
							"columnName": "field"
						},
						"footcell_field6": {
							"model": "footcell_field",
							"items": [],
							"columnName": "field",
							"field": "chip"
						},
						"cell_dpreview": {
							"model": "cell_dpreview",
							"items": [],
							"columnName": "",
							"field": ""
						},
						"headcell_field10": {
							"model": "headcell_field",
							"items": [
								"grid_field_label3"
							],
							"columnName": "field",
							"field": "noserie"
						},
						"headcell_field11": {
							"model": "cell_field",
							"items": [
								"grid_field3"
							],
							"columnName": "field",
							"field": "noserie"
						},
						"headcell_field14": {
							"model": "footcell_field",
							"items": [],
							"columnName": "field",
							"field": "noserie"
						},
						"headcell_field8": {
							"model": "headcell_field",
							"items": [
								"text2"
							],
							"field": "",
							"columnName": "details"
						},
						"cell_field5": {
							"model": "cell_field",
							"items": [
								"grid_details_link"
							],
							"field": "",
							"columnName": "details"
						},
						"footcell_field5": {
							"model": "footcell_field",
							"items": [],
							"field": "",
							"columnName": "details"
						},
						"headcell_field13": {
							"model": "headcell_field",
							"items": [],
							"field": "",
							"columnName": ""
						},
						"cell_field7": {
							"model": "cell_field",
							"items": [],
							"field": "",
							"columnName": ""
						},
						"footcell_field7": {
							"model": "footcell_field",
							"items": [],
							"field": "",
							"columnName": ""
						},
						"headcell_field15": {
							"model": "cell_field",
							"items": [
								"grid_field5"
							],
							"field": "",
							"columnName": ""
						},
						"headcell_field17": {
							"model": "headcell_field",
							"items": [
								"grid_field_label5"
							],
							"field": "",
							"columnName": ""
						}
					},
					"deferredItems": [],
					"recsPerRow": 1
				}
			},
			"items": {
				"page_size": {
					"type": "page_size"
				},
				"breadcrumb": {
					"type": "breadcrumb"
				},
				"logo": {
					"type": "logo"
				},
				"menu": {
					"type": "menu"
				},
				"simple_search": {
					"type": "simple_search"
				},
				"pagination": {
					"type": "pagination"
				},
				"details_found": {
					"type": "details_found"
				},
				"list_options": {
					"type": "list_options",
					"items": [
						"edit_selected",
						"export_selected",
						"delete_selected",
						"-10",
						"advsearch_link",
						"-9",
						"export"
					]
				},
				"expand_menu_button": {
					"type": "expand_menu_button"
				},
				"collapse_button": {
					"type": "collapse_button"
				},
				"add": {
					"type": "add"
				},
				"export": {
					"type": "export"
				},
				"-": {
					"type": "-"
				},
				"export_selected": {
					"type": "export_selected"
				},
				"-1": {
					"type": "-"
				},
				"-2": {
					"type": "-"
				},
				"delete": {
					"type": "delete"
				},
				"delete_selected": {
					"type": "delete_selected"
				},
				"simple_grid_field2": {
					"field": "fecha",
					"type": "grid_field",
					"inlineAdd": false,
					"inlineEdit": true
				},
				"simple_grid_field31": {
					"type": "grid_field_label",
					"field": "fecha"
				},
				"simple_grid_field4": {
					"field": "idcliente",
					"type": "grid_field",
					"inlineAdd": false,
					"inlineEdit": true
				},
				"simple_grid_field33": {
					"type": "grid_field_label",
					"field": "idcliente"
				},
				"simple_grid_field10": {
					"field": "orden",
					"type": "grid_field",
					"inlineAdd": false,
					"inlineEdit": true
				},
				"simple_grid_field39": {
					"type": "grid_field_label",
					"field": "orden"
				},
				"simple_grid_field12": {
					"field": "estatus",
					"type": "grid_field",
					"inlineAdd": false,
					"inlineEdit": true
				},
				"simple_grid_field41": {
					"type": "grid_field_label",
					"field": "estatus"
				},
				"grid_checkbox": {
					"type": "grid_checkbox"
				},
				"grid_checkbox_head": {
					"type": "grid_checkbox_head"
				},
				"grid_edit": {
					"type": "grid_edit",
					"icon": {
						"glyph": "pencil"
					}
				},
				"grid_view": {
					"type": "grid_view",
					"icon": {
						"glyph": "search"
					}
				},
				"username_button": {
					"type": "username_button",
					"items": [
						"userinfo_link",
						"logout_link",
						"adminarea_link"
					]
				},
				"loginform_login": {
					"type": "loginform_login",
					"popup": false
				},
				"userinfo_link": {
					"type": "userinfo_link"
				},
				"logout_link": {
					"type": "logout_link"
				},
				"adminarea_link": {
					"type": "adminarea_link"
				},
				"grid_field": {
					"field": "descripcion",
					"type": "grid_field",
					"inlineAdd": false,
					"inlineEdit": true
				},
				"grid_field_label": {
					"type": "grid_field_label",
					"field": "descripcion"
				},
				"-3": {
					"type": "-"
				},
				"edit_selected": {
					"type": "edit_selected"
				},
				"grid_inline_edit": {
					"type": "grid_inline_edit"
				},
				"grid_inline_save": {
					"type": "grid_inline_save"
				},
				"grid_inline_cancel": {
					"type": "grid_inline_cancel"
				},
				"inline_save_all": {
					"type": "inline_save_all"
				},
				"inline_cancel_all": {
					"type": "inline_cancel_all"
				},
				"-4": {
					"type": "-"
				},
				"-5": {
					"type": "-"
				},
				"grid_field2": {
					"field": "estatusentrega",
					"type": "grid_field",
					"inlineEdit": true,
					"inlineAdd": true
				},
				"grid_field_label2": {
					"type": "grid_field_label",
					"field": "estatusentrega"
				},
				"-6": {
					"type": "-"
				},
				"-7": {
					"type": "-"
				},
				"grid_field4": {
					"field": "chip",
					"type": "grid_field",
					"inlineEdit": false,
					"inlineAdd": false
				},
				"grid_field_label4": {
					"type": "grid_field_label",
					"field": "chip"
				},
				"-8": {
					"type": "-"
				},
				"-9": {
					"type": "-"
				},
				"snippet": {
					"type": "snippet",
					"eventGid": 3482841917
				},
				"text": {
					"type": "text",
					"label": {
						"text": "-",
						"type": 0
					},
					"editedByRte": false
				},
				"snippet1": {
					"type": "snippet",
					"eventGid": 1209004018
				},
				"advsearch_link": {
					"type": "advsearch_link"
				},
				"-10": {
					"type": "-"
				},
				"text1": {
					"type": "text",
					"label": {
						"type": 0,
						"text": "Rango de fechas: "
					},
					"editedByRte": false
				},
				"grid_details_link": {
					"type": "grid_details_link",
					"table": 3847630651,
					"badge": true,
					"hideIfNone": true,
					"showCount": true,
					"icon": {}
				},
				"print_panel": {
					"type": "print_panel",
					"items": [
						"print_details"
					]
				},
				"print_details": {
					"type": "print_details",
					"tables": {
						"3847630651": true
					}
				},
				"text2": {
					"type": "text",
					"label": {
						"text": "Logística",
						"type": 0
					},
					"editedByRte": false
				},
				"expand_button": {
					"type": "expand_button"
				},
				"grid_field3": {
					"field": "noserie",
					"type": "grid_field",
					"inlineEdit": false,
					"inlineAdd": false
				},
				"grid_field_label3": {
					"type": "grid_field_label",
					"field": "noserie"
				},
				"grid_field5": {
					"field": "idtipoventa",
					"type": "grid_field",
					"inlineAdd": false,
					"inlineEdit": false
				},
				"grid_field_label5": {
					"type": "grid_field_label",
					"field": "idtipoventa"
				}
			},
			"dbProps": {},
			"spreadsheetGrid": false,
			"autoAddNewRecord": false,
			"version": 13,
			"pageWidth": "full",
			"imageItem": {
				"type": "page_image"
			},
			"imageBgColor": "#f2f2f2",
			"controlsBgColor": "white",
			"imagePosition": "right",
			"pageCSS": "/* Put  your custom CSS code here */\n/*\n.table {\n    font-family: 'Arial', sans-serif !important;\n    font-size: 12px !important;\n    border-collapse: collapse !important;\n}*/\n\n\n/* ========================================================= */\n/* VARIABLES DE COLOR */\n/* ========================================================= */\n:root {\n    /* Color de acento para botones, foco y texto */\n    --color-acento: #48C9B0; /* Turquesa/Menta */ \n    --color-elegante: #1C334A; /* Azul Marino Oscuro */\n}\n\n/* ========================================================= */\n/* 1. Fondo de la Página: Degradado Azul Cielo Intenso       */\n/* ========================================================= */\nbody, .container-fluid {\n    /* Mismo fondo azul que usamos en el formulario de agregar */\n    background: linear-gradient(180deg, #E0F7FA 0%, #B3E5FC 100%) !important; \n    min-height: 100vh;\n}\n\n/* ========================================================= */\n/* 2. Contenedor de la Lista (El \"Body\" principal de la tabla) */\n/* Aplicamos el efecto de Tarjeta y Sombra a este contenedor */\n/* El selector depende del tema, pero '.rnr-b-grid' suele ser el contenedor de la tabla */\n.rnr-body .rnr-c-body, \n.rnr-b-grid, \n.rnr-c-grid,\n.panel-default {\n    background-color: #FFFFFF !important; \n    border: none !important; \n    border-radius: 12px !important; \n    \n    /* Sombreado elegante de la tarjeta */\n    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1), \n                0 2px 6px rgba(0, 0, 0, 0.05) !important; \n}\n\n/* 3. Encabezados y Barras de Herramientas (Parte superior e inferior) */\n/* Limpiamos el diseño de los paneles que rodean la tabla */\n.rnr-c-hsucc, .rnr-c-message, .rnr-c-hcell {\n    background-color: transparent !important;\n    border: none !important;\n}\n\n/* 4. Estilo de las Filas de Datos (Efecto Hover de Elevación) */\n/* Le da interactividad a la tabla */\n.rnr-body tr {\n    transition: box-shadow 0.3s ease-in-out, transform 0.3s ease-in-out;\n}\n\n.rnr-body tr:hover {\n    background-color: #fcfcfc !important; /* Ligeramente más claro al pasar el mouse */\n    \n    /* Sombra y elevación sutil para destacar la fila */\n    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1), \n                0 1px 3px rgba(0, 0, 0, 0.05) !important;\n    transform: translateY(-1px);\n}\n\n/* 5. Asegurar que las celdas del encabezado de la tabla se vean bien */\n.rnr-c-grid th {\n    background-color: #f7f7f7 !important; /* Fondo sutil para el header de la tabla */\n    color: var(--color-elegante) !important;\n    font-weight: 600;\n    border-bottom: 2px solid var(--color-acento) !important;\n}\n\n/* 6. Barras de Paginación y Búsqueda */\n.rnr-bottom .panel, .rnr-c-search, .rnr-c-top, .rnr-bottom-nav {\n    background-color: transparent !important;\n    border: none !important;\n    box-shadow: none !important; /* Quitamos la sombra a estos elementos */\n}\n\n\n\n/* ========================================================= */\n/* ESTILOS PARA CELDAS DE ESTADO (FORMATO CONDICIONAL)       */\n/* ========================================================= */\n\n/* Clase base para el estilo de \"badge\" o \"tag\" */\n.status-badge {\n    display: inline-block; /* Para que tome el tamaño del contenido */\n    padding: 5px 10px; /* Relleno interno */\n    border-radius: 20px; /* MUY REDONDEADO para el efecto de píldora */\n    font-weight: bold;\n    font-size: 0.85em;\n    text-align: center;\n    min-width: 80px; /* Ancho mínimo para que no se vea muy pequeño */\n    box-shadow: 0 1px 3px rgba(0,0,0,0.1); /* Sombra sutil */\n}\n\n/* Estado: Entregado (Verde) */\n.status-entregado {\n    background-color: #D4EDDA; /* Verde pastel claro */\n    color: #155724; /* Texto verde oscuro */\n    border: 1px solid #C3E6CB; /* Borde sutil */\n}\n\n/* Estado: Pendiente (Amarillo) */\n.status-pendiente {\n    background-color: #FFF3CD; /* Amarillo pastel claro */\n    color: #856404; /* Texto amarillo oscuro */\n    border: 1px solid #FFEEBA;\n}\n\n/* Estado: Cancelado (Rojo) */\n.status-cancelado {\n    background-color: #F8D7DA; /* Rojo pastel claro */\n    color: #721C24; /* Texto rojo oscuro */\n    border: 1px solid #F5C6CB;\n}\n\n/* Agrega más estados según sea necesario */\n/* Estado: En Proceso (Azul) */\n.status-en-proceso {\n    background-color: #D1ECF1; /* Azul pastel claro */\n    color: #0C5460; /* Texto azul oscuro */\n    border: 1px solid #BEE5EB;\n}\n\n\n/* ========================================================= */\n/* ELIMINAR SEPARADORES DE COLUMNA (LÍNEAS VERTICALES)        */\n/* ========================================================= */\n/* Mantén líneas horizontales ligeras, borra las verticales */\n.rnr-gridtable td,\n.rnr-gridtable th {\n  border-left: none !important;\n  border-right: none !important;\n  box-shadow: none !important; /* algunos temas usan sombras como divisores */\n}\n\n/* Si quieres una línea horizontal sutil */\n.rnr-gridtable td {\n  border-top: 1px solid #eee !important;\n}\n.rnr-gridtable thead th {\n  border-bottom: 1px solid #e6e6e6 !important;\n}\n",
			"listTotals": 1,
			"title": {}
		},
		{
			"id": "print",
			"type": "print",
			"layoutId": "basic",
			"disabled": true,
			"default": 0,
			"forms": {
				"above-grid": {
					"modelId": "print-above-grid",
					"grid": [
						{
							"cells": [
								{
									"cell": "c1"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c1": {
							"model": "c1",
							"items": [
								"print_pages"
							]
						}
					},
					"deferredItems": [],
					"recsPerRow": 1
				},
				"below-grid": {
					"modelId": "print-below-grid",
					"grid": [
						{
							"cells": [
								{
									"cell": "c1"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c1": {
							"model": "c1",
							"items": []
						}
					},
					"deferredItems": [],
					"recsPerRow": 1
				},
				"top": {
					"modelId": "print-header",
					"grid": [
						{
							"cells": [
								{
									"cell": "c2"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c2": {
							"model": "c2",
							"items": [
								"print_header",
								"print_subheader"
							]
						}
					},
					"deferredItems": [],
					"recsPerRow": 1
				},
				"grid": {
					"modelId": "simple-grid",
					"grid": [
						{
							"cells": [
								{
									"cell": "c1"
								}
							],
							"section": ""
						},
						{
							"cells": [
								{
									"cell": "c2"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c1": {
							"model": "c1",
							"items": [
								"simple_grid_field",
								"simple_grid_field1",
								"simple_grid_field2"
							]
						},
						"c2": {
							"model": "c2",
							"items": [
								"details_preview"
							]
						}
					},
					"deferredItems": [],
					"recsPerRow": 1
				}
			},
			"items": {
				"print_header": {
					"type": "print_header"
				},
				"print_subheader": {
					"type": "print_subheader"
				},
				"print_pages": {
					"type": "print_pages"
				},
				"simple_grid_field": {
					"field": "direccion",
					"type": "simple_grid_field"
				},
				"simple_grid_field1": {
					"field": "lat",
					"type": "simple_grid_field"
				},
				"simple_grid_field2": {
					"field": "lng",
					"type": "simple_grid_field"
				},
				"details_preview": {
					"type": "details_preview",
					"table": 3847630651,
					"items": [],
					"popup": false
				}
			},
			"dbProps": {},
			"version": 13,
			"imageItem": {
				"type": "page_image"
			},
			"imageBgColor": "#f2f2f2",
			"controlsBgColor": "white",
			"imagePosition": "right",
			"listTotals": 1,
			"title": {}
		},
		{
			"id": "search",
			"type": "search",
			"layoutId": "nomenu",
			"disabled": false,
			"default": 0,
			"forms": {
				"above-grid": {
					"modelId": "search-above-grid",
					"grid": [
						{
							"cells": [
								{
									"cell": "c1",
									"colspan": 2
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c1": {
							"model": "c1",
							"items": []
						}
					},
					"deferredItems": [],
					"recsPerRow": 1
				},
				"below-grid": {
					"modelId": "search-below-grid",
					"grid": [
						{
							"cells": [
								{
									"cell": "c1"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c1": {
							"model": "c1",
							"items": [
								"search_search",
								"search_reset",
								"search_back_list",
								"search_cancel"
							]
						}
					},
					"deferredItems": [],
					"recsPerRow": 1
				},
				"top": {
					"modelId": "search-header",
					"grid": [
						{
							"cells": [
								{
									"cell": "c1"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c1": {
							"model": "c1",
							"items": [
								"search_header"
							]
						}
					},
					"deferredItems": [],
					"recsPerRow": 1
				},
				"grid": {
					"modelId": "simple-search",
					"grid": [
						{
							"cells": [
								{
									"cell": "c3"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c3": {
							"model": "c3",
							"items": [
								"integrated_search_field",
								"integrated_search_field1",
								"integrated_search_field2",
								"integrated_search_field3",
								"integrated_search_field4",
								"integrated_search_field5",
								"integrated_search_field6",
								"integrated_search_field7",
								"integrated_search_field8",
								"integrated_search_field9"
							]
						}
					},
					"deferredItems": [],
					"separateLabels": false
				}
			},
			"items": {
				"search_header": {
					"type": "search_header"
				},
				"search_reset": {
					"type": "search_reset"
				},
				"search_back_list": {
					"type": "search_back_list"
				},
				"search_search": {
					"type": "search_search"
				},
				"search_cancel": {
					"type": "search_cancel"
				},
				"integrated_search_field": {
					"field": "noserie",
					"type": "integrated_search_field",
					"orientation": 0
				},
				"integrated_search_field1": {
					"field": "dn",
					"type": "integrated_search_field",
					"orientation": 0
				},
				"integrated_search_field2": {
					"field": "cuenta",
					"type": "integrated_search_field",
					"orientation": 0
				},
				"integrated_search_field3": {
					"field": "contrato",
					"type": "integrated_search_field",
					"orientation": 0
				},
				"integrated_search_field4": {
					"field": "contratoportal",
					"type": "integrated_search_field",
					"orientation": 0
				},
				"integrated_search_field5": {
					"field": "plazopendiente",
					"type": "integrated_search_field",
					"orientation": 0
				},
				"integrated_search_field6": {
					"field": "factura",
					"type": "integrated_search_field",
					"orientation": 0
				},
				"integrated_search_field7": {
					"field": "fechavenci",
					"type": "integrated_search_field",
					"orientation": 0
				},
				"integrated_search_field8": {
					"field": "ciclo",
					"type": "integrated_search_field",
					"orientation": 0
				},
				"integrated_search_field9": {
					"field": "dnpreferido",
					"type": "integrated_search_field",
					"orientation": 0
				}
			},
			"dbProps": {},
			"version": 13,
			"imageItem": {
				"type": "page_image"
			},
			"imageBgColor": "#f2f2f2",
			"controlsBgColor": "white",
			"imagePosition": "right",
			"listTotals": 1,
			"title": {}
		},
		{
			"id": "masterlist",
			"type": "masterlist",
			"layoutId": "masterlist",
			"disabled": false,
			"default": 0,
			"forms": {
				"above-grid": {
					"modelId": "empty-above-grid",
					"grid": [
						{
							"cells": [
								{
									"cell": "c1"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c1": {
							"model": "c1",
							"items": []
						}
					},
					"deferredItems": [],
					"recsPerRow": 1
				},
				"below-grid": {
					"modelId": "empty-above-grid",
					"grid": [
						{
							"cells": [
								{
									"cell": "c1"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c1": {
							"model": "c1",
							"items": []
						}
					},
					"deferredItems": [],
					"recsPerRow": 1
				},
				"top": {
					"modelId": "masterlist-top",
					"grid": [
						{
							"cells": [
								{
									"cell": "c1"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c1": {
							"model": "c1",
							"items": [
								"back_master",
								"masterlist_header"
							]
						}
					},
					"deferredItems": [],
					"recsPerRow": 1
				},
				"grid": {
					"modelId": "simple-grid",
					"grid": [
						{
							"cells": [
								{
									"cell": "c1"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c1": {
							"model": "c1",
							"items": [
								"simple_grid_field",
								"simple_grid_field1",
								"simple_grid_field2",
								"simple_grid_field3",
								"simple_grid_field4",
								"simple_grid_field5",
								"simple_grid_field6",
								"simple_grid_field7",
								"simple_grid_field8",
								"simple_grid_field9",
								"simple_grid_field10",
								"simple_grid_field11",
								"simple_grid_field12",
								"simple_grid_field13",
								"simple_grid_field14",
								"simple_grid_field15",
								"simple_grid_field16",
								"simple_grid_field17",
								"simple_grid_field18",
								"simple_grid_field19",
								"simple_grid_field20",
								"simple_grid_field21",
								"simple_grid_field22",
								"simple_grid_field23",
								"simple_grid_field24",
								"simple_grid_field25",
								"simple_grid_field26",
								"simple_grid_field27",
								"simple_grid_field28",
								"simple_grid_field29",
								"simple_grid_field30",
								"simple_grid_field31",
								"simple_grid_field32",
								"simple_grid_field33",
								"simple_grid_field34",
								"simple_grid_field35",
								"simple_grid_field36",
								"simple_grid_field37",
								"simple_grid_field38",
								"simple_grid_field39",
								"simple_grid_field40",
								"simple_grid_field41",
								"simple_grid_field42",
								"simple_grid_field44",
								"simple_grid_field45",
								"simple_grid_field46",
								"simple_grid_field43",
								"simple_grid_field47",
								"simple_grid_field48",
								"simple_grid_field49",
								"simple_grid_field50",
								"simple_grid_field51",
								"simple_grid_field52",
								"simple_grid_field53",
								"simple_grid_field54",
								"simple_grid_field55"
							]
						}
					},
					"deferredItems": [],
					"recsPerRow": 1
				}
			},
			"items": {
				"masterlist_header": {
					"type": "masterlist_header"
				},
				"back_master": {
					"type": "back_master"
				},
				"simple_grid_field": {
					"field": "idsolicitud",
					"type": "simple_grid_field"
				},
				"simple_grid_field1": {
					"field": "idtipoventa",
					"type": "simple_grid_field"
				},
				"simple_grid_field2": {
					"field": "fecha",
					"type": "simple_grid_field"
				},
				"simple_grid_field3": {
					"field": "fechacaptura",
					"type": "simple_grid_field"
				},
				"simple_grid_field4": {
					"field": "idcliente",
					"type": "simple_grid_field"
				},
				"simple_grid_field5": {
					"field": "idproducto",
					"type": "simple_grid_field"
				},
				"simple_grid_field6": {
					"field": "idplan",
					"type": "simple_grid_field"
				},
				"simple_grid_field7": {
					"field": "usuario",
					"type": "simple_grid_field"
				},
				"simple_grid_field8": {
					"field": "idtienda",
					"type": "simple_grid_field"
				},
				"simple_grid_field9": {
					"field": "fechamodif",
					"type": "simple_grid_field"
				},
				"simple_grid_field10": {
					"field": "orden",
					"type": "simple_grid_field"
				},
				"simple_grid_field11": {
					"field": "solicitudimg",
					"type": "simple_grid_field"
				},
				"simple_grid_field12": {
					"field": "estatus",
					"type": "simple_grid_field"
				},
				"simple_grid_field13": {
					"field": "idsolrazon",
					"type": "simple_grid_field"
				},
				"simple_grid_field14": {
					"field": "importeatt",
					"type": "simple_grid_field"
				},
				"simple_grid_field15": {
					"field": "importesms",
					"type": "simple_grid_field"
				},
				"simple_grid_field16": {
					"field": "plazo",
					"type": "simple_grid_field"
				},
				"simple_grid_field17": {
					"field": "observaciones",
					"type": "simple_grid_field"
				},
				"simple_grid_field18": {
					"field": "equipoincluido",
					"type": "simple_grid_field"
				},
				"simple_grid_field19": {
					"field": "rfc",
					"type": "simple_grid_field"
				},
				"simple_grid_field20": {
					"field": "idtratamiento",
					"type": "simple_grid_field"
				},
				"simple_grid_field21": {
					"field": "riesgo",
					"type": "simple_grid_field"
				},
				"simple_grid_field22": {
					"field": "observacionest",
					"type": "simple_grid_field"
				},
				"simple_grid_field23": {
					"field": "idcli",
					"type": "simple_grid_field"
				},
				"simple_grid_field24": {
					"field": "fecha1avta",
					"type": "simple_grid_field"
				},
				"simple_grid_field25": {
					"field": "idplan1avta",
					"type": "simple_grid_field"
				},
				"simple_grid_field26": {
					"field": "dn1avta",
					"type": "simple_grid_field"
				},
				"simple_grid_field27": {
					"field": "idproceso",
					"type": "simple_grid_field"
				},
				"simple_grid_field28": {
					"field": "idorigenventa",
					"type": "simple_grid_field"
				},
				"simple_grid_field29": {
					"field": "nombre",
					"type": "simple_grid_field"
				},
				"simple_grid_field30": {
					"field": "paterno",
					"type": "simple_grid_field"
				},
				"simple_grid_field31": {
					"field": "materno",
					"type": "simple_grid_field"
				},
				"simple_grid_field32": {
					"field": "estado",
					"type": "simple_grid_field"
				},
				"simple_grid_field33": {
					"field": "ciudad",
					"type": "simple_grid_field"
				},
				"simple_grid_field34": {
					"field": "cp",
					"type": "simple_grid_field"
				},
				"simple_grid_field35": {
					"field": "calle",
					"type": "simple_grid_field"
				},
				"simple_grid_field36": {
					"field": "numeroext",
					"type": "simple_grid_field"
				},
				"simple_grid_field37": {
					"field": "numeroint",
					"type": "simple_grid_field"
				},
				"simple_grid_field38": {
					"field": "colonia",
					"type": "simple_grid_field"
				},
				"simple_grid_field39": {
					"field": "descripcion",
					"type": "simple_grid_field"
				},
				"simple_grid_field40": {
					"field": "maps_url",
					"type": "simple_grid_field"
				},
				"simple_grid_field41": {
					"field": "direccion",
					"type": "simple_grid_field"
				},
				"simple_grid_field42": {
					"field": "estatusentrega",
					"type": "simple_grid_field"
				},
				"simple_grid_field44": {
					"field": "chip",
					"type": "simple_grid_field"
				},
				"simple_grid_field45": {
					"field": "lat",
					"type": "simple_grid_field"
				},
				"simple_grid_field46": {
					"field": "lng",
					"type": "simple_grid_field"
				},
				"simple_grid_field43": {
					"field": "noserie",
					"type": "simple_grid_field"
				},
				"simple_grid_field47": {
					"field": "dn",
					"type": "simple_grid_field"
				},
				"simple_grid_field48": {
					"field": "cuenta",
					"type": "simple_grid_field"
				},
				"simple_grid_field49": {
					"field": "contrato",
					"type": "simple_grid_field"
				},
				"simple_grid_field50": {
					"field": "contratoportal",
					"type": "simple_grid_field"
				},
				"simple_grid_field51": {
					"field": "plazopendiente",
					"type": "simple_grid_field"
				},
				"simple_grid_field52": {
					"field": "factura",
					"type": "simple_grid_field"
				},
				"simple_grid_field53": {
					"field": "fechavenci",
					"type": "simple_grid_field"
				},
				"simple_grid_field54": {
					"field": "ciclo",
					"type": "simple_grid_field"
				},
				"simple_grid_field55": {
					"field": "dnpreferido",
					"type": "simple_grid_field"
				}
			},
			"dbProps": {},
			"version": 13,
			"imageItem": {
				"type": "page_image"
			},
			"imageBgColor": "#f2f2f2",
			"controlsBgColor": "white",
			"imagePosition": "right",
			"listTotals": 1,
			"title": {}
		},
		{
			"id": "masterprint",
			"type": "masterprint",
			"layoutId": "masterprint",
			"disabled": false,
			"default": 0,
			"forms": {
				"above-grid": {
					"modelId": "empty-above-grid",
					"grid": [
						{
							"cells": [
								{
									"cell": "c1"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c1": {
							"model": "c1",
							"items": []
						}
					},
					"deferredItems": [],
					"recsPerRow": 1
				},
				"below-grid": {
					"modelId": "empty-above-grid",
					"grid": [
						{
							"cells": [
								{
									"cell": "c1"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c1": {
							"model": "c1",
							"items": []
						}
					},
					"deferredItems": [],
					"recsPerRow": 1
				},
				"top": {
					"modelId": "masterlist-top",
					"grid": [
						{
							"cells": [
								{
									"cell": "c1"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c1": {
							"model": "c1",
							"items": [
								"masterprint_header"
							]
						}
					},
					"deferredItems": [],
					"recsPerRow": 1
				},
				"grid": {
					"modelId": "simple-grid",
					"grid": [
						{
							"cells": [
								{
									"cell": "c1"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c1": {
							"model": "c1",
							"items": [
								"simple_grid_field",
								"simple_grid_field1",
								"simple_grid_field2",
								"simple_grid_field3",
								"simple_grid_field4",
								"simple_grid_field5",
								"simple_grid_field6",
								"simple_grid_field7",
								"simple_grid_field8",
								"simple_grid_field9",
								"simple_grid_field10",
								"simple_grid_field11",
								"simple_grid_field12",
								"simple_grid_field13",
								"simple_grid_field14",
								"simple_grid_field15",
								"simple_grid_field16",
								"simple_grid_field17",
								"simple_grid_field18",
								"simple_grid_field19",
								"simple_grid_field20",
								"simple_grid_field21",
								"simple_grid_field22",
								"simple_grid_field23",
								"simple_grid_field24",
								"simple_grid_field25",
								"simple_grid_field26",
								"simple_grid_field27",
								"simple_grid_field28",
								"simple_grid_field29",
								"simple_grid_field30",
								"simple_grid_field31",
								"simple_grid_field32",
								"simple_grid_field33",
								"simple_grid_field34",
								"simple_grid_field35",
								"simple_grid_field36",
								"simple_grid_field37",
								"simple_grid_field38",
								"simple_grid_field39",
								"simple_grid_field40",
								"simple_grid_field41",
								"simple_grid_field42",
								"simple_grid_field44",
								"simple_grid_field45",
								"simple_grid_field46",
								"simple_grid_field43",
								"simple_grid_field47",
								"simple_grid_field48",
								"simple_grid_field49",
								"simple_grid_field50",
								"simple_grid_field51",
								"simple_grid_field52",
								"simple_grid_field53",
								"simple_grid_field54",
								"simple_grid_field55"
							]
						}
					},
					"deferredItems": [],
					"recsPerRow": 1
				}
			},
			"items": {
				"masterprint_header": {
					"type": "masterprint_header"
				},
				"simple_grid_field": {
					"field": "idsolicitud",
					"type": "simple_grid_field"
				},
				"simple_grid_field1": {
					"field": "idtipoventa",
					"type": "simple_grid_field"
				},
				"simple_grid_field2": {
					"field": "fecha",
					"type": "simple_grid_field"
				},
				"simple_grid_field3": {
					"field": "fechacaptura",
					"type": "simple_grid_field"
				},
				"simple_grid_field4": {
					"field": "idcliente",
					"type": "simple_grid_field"
				},
				"simple_grid_field5": {
					"field": "idproducto",
					"type": "simple_grid_field"
				},
				"simple_grid_field6": {
					"field": "idplan",
					"type": "simple_grid_field"
				},
				"simple_grid_field7": {
					"field": "usuario",
					"type": "simple_grid_field"
				},
				"simple_grid_field8": {
					"field": "idtienda",
					"type": "simple_grid_field"
				},
				"simple_grid_field9": {
					"field": "fechamodif",
					"type": "simple_grid_field"
				},
				"simple_grid_field10": {
					"field": "orden",
					"type": "simple_grid_field"
				},
				"simple_grid_field11": {
					"field": "solicitudimg",
					"type": "simple_grid_field"
				},
				"simple_grid_field12": {
					"field": "estatus",
					"type": "simple_grid_field"
				},
				"simple_grid_field13": {
					"field": "idsolrazon",
					"type": "simple_grid_field"
				},
				"simple_grid_field14": {
					"field": "importeatt",
					"type": "simple_grid_field"
				},
				"simple_grid_field15": {
					"field": "importesms",
					"type": "simple_grid_field"
				},
				"simple_grid_field16": {
					"field": "plazo",
					"type": "simple_grid_field"
				},
				"simple_grid_field17": {
					"field": "observaciones",
					"type": "simple_grid_field"
				},
				"simple_grid_field18": {
					"field": "equipoincluido",
					"type": "simple_grid_field"
				},
				"simple_grid_field19": {
					"field": "rfc",
					"type": "simple_grid_field"
				},
				"simple_grid_field20": {
					"field": "idtratamiento",
					"type": "simple_grid_field"
				},
				"simple_grid_field21": {
					"field": "riesgo",
					"type": "simple_grid_field"
				},
				"simple_grid_field22": {
					"field": "observacionest",
					"type": "simple_grid_field"
				},
				"simple_grid_field23": {
					"field": "idcli",
					"type": "simple_grid_field"
				},
				"simple_grid_field24": {
					"field": "fecha1avta",
					"type": "simple_grid_field"
				},
				"simple_grid_field25": {
					"field": "idplan1avta",
					"type": "simple_grid_field"
				},
				"simple_grid_field26": {
					"field": "dn1avta",
					"type": "simple_grid_field"
				},
				"simple_grid_field27": {
					"field": "idproceso",
					"type": "simple_grid_field"
				},
				"simple_grid_field28": {
					"field": "idorigenventa",
					"type": "simple_grid_field"
				},
				"simple_grid_field29": {
					"field": "nombre",
					"type": "simple_grid_field"
				},
				"simple_grid_field30": {
					"field": "paterno",
					"type": "simple_grid_field"
				},
				"simple_grid_field31": {
					"field": "materno",
					"type": "simple_grid_field"
				},
				"simple_grid_field32": {
					"field": "estado",
					"type": "simple_grid_field"
				},
				"simple_grid_field33": {
					"field": "ciudad",
					"type": "simple_grid_field"
				},
				"simple_grid_field34": {
					"field": "cp",
					"type": "simple_grid_field"
				},
				"simple_grid_field35": {
					"field": "calle",
					"type": "simple_grid_field"
				},
				"simple_grid_field36": {
					"field": "numeroext",
					"type": "simple_grid_field"
				},
				"simple_grid_field37": {
					"field": "numeroint",
					"type": "simple_grid_field"
				},
				"simple_grid_field38": {
					"field": "colonia",
					"type": "simple_grid_field"
				},
				"simple_grid_field39": {
					"field": "descripcion",
					"type": "simple_grid_field"
				},
				"simple_grid_field40": {
					"field": "maps_url",
					"type": "simple_grid_field"
				},
				"simple_grid_field41": {
					"field": "direccion",
					"type": "simple_grid_field"
				},
				"simple_grid_field42": {
					"field": "estatusentrega",
					"type": "simple_grid_field"
				},
				"simple_grid_field44": {
					"field": "chip",
					"type": "simple_grid_field"
				},
				"simple_grid_field45": {
					"field": "lat",
					"type": "simple_grid_field"
				},
				"simple_grid_field46": {
					"field": "lng",
					"type": "simple_grid_field"
				},
				"simple_grid_field43": {
					"field": "noserie",
					"type": "simple_grid_field"
				},
				"simple_grid_field47": {
					"field": "dn",
					"type": "simple_grid_field"
				},
				"simple_grid_field48": {
					"field": "cuenta",
					"type": "simple_grid_field"
				},
				"simple_grid_field49": {
					"field": "contrato",
					"type": "simple_grid_field"
				},
				"simple_grid_field50": {
					"field": "contratoportal",
					"type": "simple_grid_field"
				},
				"simple_grid_field51": {
					"field": "plazopendiente",
					"type": "simple_grid_field"
				},
				"simple_grid_field52": {
					"field": "factura",
					"type": "simple_grid_field"
				},
				"simple_grid_field53": {
					"field": "fechavenci",
					"type": "simple_grid_field"
				},
				"simple_grid_field54": {
					"field": "ciclo",
					"type": "simple_grid_field"
				},
				"simple_grid_field55": {
					"field": "dnpreferido",
					"type": "simple_grid_field"
				}
			},
			"dbProps": {},
			"version": 13,
			"imageItem": {
				"type": "page_image"
			},
			"imageBgColor": "#f2f2f2",
			"controlsBgColor": "white",
			"imagePosition": "right",
			"listTotals": 1,
			"title": {}
		},
		{
			"id": "edit1",
			"type": "edit",
			"layoutId": "nomenu",
			"disabled": false,
			"default": 6,
			"forms": {
				"above-grid": {
					"modelId": "edit-above-grid",
					"grid": [
						{
							"cells": [
								{
									"cell": "c1"
								}
							],
							"section": ""
						},
						{
							"cells": [
								{
									"cell": "c2"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c1": {
							"model": "c1",
							"items": [
								"edit_message"
							]
						},
						"c2": {
							"model": "c2",
							"items": []
						}
					},
					"deferredItems": [],
					"recsPerRow": 1
				},
				"below-grid": {
					"modelId": "edit-below-grid",
					"grid": [
						{
							"cells": [
								{
									"cell": "c1"
								},
								{
									"cell": "c2"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c1": {
							"model": "c1",
							"items": [
								"edit_save",
								"edit_back_list",
								"edit_close"
							]
						},
						"c2": {
							"model": "c2",
							"items": [
								"hamburger"
							]
						}
					},
					"deferredItems": [],
					"recsPerRow": 1
				},
				"top": {
					"modelId": "edit-header",
					"grid": [
						{
							"cells": [
								{
									"cell": "c1"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c1": {
							"model": "c1",
							"items": [
								"edit_header"
							]
						}
					},
					"deferredItems": [],
					"recsPerRow": 1
				},
				"grid": {
					"modelId": "simple-edit",
					"grid": [
						{
							"cells": [
								{
									"cell": "c1"
								}
							],
							"section": ""
						},
						{
							"cells": [
								{
									"cell": "c3"
								}
							],
							"section": ""
						}
					],
					"cells": {
						"c1": {
							"model": "c1",
							"items": [
								"text"
							],
							"align": "center"
						},
						"c3": {
							"model": "c3",
							"items": [
								"details_preview"
							],
							"align": "center"
						}
					},
					"deferredItems": [],
					"columnCount": 1,
					"inlineLabels": false,
					"separateLabels": false
				}
			},
			"items": {
				"edit_header": {
					"type": "edit_header"
				},
				"hamburger": {
					"type": "hamburger",
					"items": [
						"edit_reset",
						"edit_view"
					]
				},
				"edit_reset": {
					"type": "edit_reset"
				},
				"edit_message": {
					"type": "edit_message"
				},
				"edit_save": {
					"type": "edit_save"
				},
				"edit_back_list": {
					"type": "edit_back_list"
				},
				"edit_close": {
					"type": "edit_close"
				},
				"edit_view": {
					"type": "edit_view"
				},
				"details_preview": {
					"type": "details_preview",
					"table": 3847630651,
					"items": [],
					"popup": false,
					"pageId": "list"
				},
				"text": {
					"type": "text",
					"label": {
						"text": "<!-- QUICK ADD logisticavnp -->\n<style>\n  .qa-card{background:#fff;border:1px solid #e5e7eb;border-radius:16px;margin:12px 0 18px;\n           box-shadow:0 10px 25px -5px rgba(0,0,0,.1),0 10px 10px -5px rgba(0,0,0,.04)}\n  .qa-head{padding:14px 18px;border-bottom:1px solid #eef2ff;\n           background:linear-gradient(90deg,#667eea,#764ba2);color:#fff;\n           border-top-left-radius:16px;border-top-right-radius:16px}\n  .qa-title{font-size:18px;font-weight:700;display:flex;align-items:center;gap:8px}\n  /* 2 columnas para Fecha y SIM; el botón ocupa toda la fila de abajo */\n  .qa-body{padding:16px 18px;display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:end}\n  .qa-input{width:100%;padding:10px 12px;border:1px solid #d1d5db;border-radius:10px;font-size:14px}\n  .qa-btn{grid-column:1 / -1; display:inline-flex;align-items:center;justify-content:center;\n          padding:12px 14px;border:none;border-radius:10px;color:#fff;font-weight:700;cursor:pointer;\n          background:linear-gradient(90deg,#10b981,#3b82f6); transition:transform .06s ease}\n  .qa-btn:active{transform:scale(.98)} /* efecto de click */\n  .qa-btn:disabled{opacity:.6;cursor:not-allowed}\n  @media (max-width: 900px){ .qa-body{grid-template-columns:1fr} }\n</style>\n\n<div id=\"qa_logisticavnp\" class=\"qa-card\">\n  <div class=\"qa-head\"><div class=\"qa-title\">📱 Nueva SIM Card</div></div>\n  <div class=\"qa-body\">\n    <div>\n      <label style=\"display:block;margin:0 0 6px 4px;color:#374151;font-weight:600;font-size:12px\">Fecha</label>\n      <input id=\"qa_fecha\" class=\"qa-input\" type=\"date\">\n    </div>\n    <div>\n      <label style=\"display:block;margin:0 0 6px 4px;color:#374151;font-weight:600;font-size:12px\">Número de SIM Card</label>\n      <input id=\"qa_sim\" class=\"qa-input\" type=\"text\" placeholder=\"Ej: 1234567890\">\n    </div>\n    <button id=\"qa_add\" class=\"qa-btn\" type=\"button\">Agregar Nueva SIM Card</button>\n  </div>\n</div>\n\n<script>\n(function(){\n  // ===== Ajusta SI tus nombres de campos son distintos =====\n  var DATE_FIELD    = 'fechaHora';     // campo fecha en logisticavnp\n  var SIM_FIELD     = 'SIMEntregado';  // campo sim en logisticavnp\n  var IDSOL_FIELD   = 'idsolicitud';   // por si está visible/editable en el detalle (normalmente PHPRunner lo hereda)\n  var AUTO_SAVE     = true;            // pulsa “Guardar todo” tras llenar\n\n  // ===== helpers =====\n  function $(s,root){ return (root||document).querySelector(s); }\n  function $all(s,root){ return Array.prototype.slice.call((root||document).querySelectorAll(s)); }\n  function todayISO(){ try{ var z=(new Date()).getTimezoneOffset()*60000; return new Date(Date.now()-z).toISOString().slice(0,10);}catch(_){return ''} }\n  function toast(msg, ok){\n    var id='qa_toast', el=document.getElementById(id);\n    if(!el){ el=document.createElement('div'); el.id=id; document.body.appendChild(el); }\n    el.textContent = msg || 'Listo';\n    el.style.cssText='position:fixed;top:16px;right:16px;padding:10px 14px;border-radius:10px;color:#fff;font-weight:700;z-index:99999;'\n                    +'box-shadow:0 10px 20px rgba(0,0,0,.18);background:'+(ok?'#10b981':'#ef4444');\n    setTimeout(function(){ el && el.remove(); }, 1600);\n  }\n  function waitFor(fn, ms, step){\n    var t0 = Date.now();\n    return new Promise(function(res,rej){\n      (function tick(){\n        try{ var v = fn(); if(v) return res(v); }catch(_){}\n        if(Date.now()-t0 >= (ms||6000)) return rej(new Error('timeout'));\n        setTimeout(tick, step||90);\n      })();\n    });\n  }\n  function findLogisticaPanel(){\n    // por título “Logisticavnp”\n    var p = $all('.bs-details .panel.panel-info.details-grid').find(function(node){\n      var h = node.querySelector('.panel-heading .panel-title');\n      return h && /logisticavnp/i.test(h.textContent||'');\n    });\n    if (p) return p;\n    // fallback: por data-table\n    var any = document.querySelector('[data-table=\"logisticavnp\"]');\n    return any ? any.closest('.panel,.bs-details,.rnr-b-grid,.rnr-grid-block') : null;\n  }\n\n  // valor por defecto de fecha\n  var inpFecha = $('#qa_fecha'); if (inpFecha) inpFecha.value = todayISO();\n\n  // botón: efecto visual ya lo da :active en CSS; aquí manejamos la lógica de inserción\n  document.addEventListener('click', async function(ev){\n    var btn = ev.target.closest('#qa_add'); if (!btn) return;\n\n    var fecha = ($('#qa_fecha')||{}).value || '';\n    var sim   = (($('#qa_sim')||{}).value||'').trim();\n    if (!fecha || !sim){ toast('Completa Fecha y SIM', false); return; }\n\n    var panel = findLogisticaPanel();\n    if (!panel){ toast('No encuentro el subform logisticavnp', false); return; }\n\n    btn.disabled = true;\n    try{\n      // 1) disparar “Añadir nuevo”\n      var addBtn = panel.querySelector('[data-buttonevent=\"inlineadd\"], #inlineAdd2');\n      if (!addBtn) throw new Error('No encontré el botón \"Añadir nuevo\"');\n      addBtn.click();\n\n      // 2) esperar a que esté la fila inline con los controles\n      var row = await waitFor(function(){\n        var fe = panel.querySelector('[id^=\"value_'+DATE_FIELD+'_\"]');\n        var si = panel.querySelector('[id^=\"value_'+SIM_FIELD+'_\"]');\n        return (fe && si) ? fe.closest('tr') : null;\n      }, 7000, 100);\n\n      // 3) llenar valores\n      var feIn = row.querySelector('[id^=\"value_'+DATE_FIELD+'_\"]');\n      var siIn = row.querySelector('[id^=\"value_'+SIM_FIELD+'_\"]');\n      feIn.value = fecha; feIn.dispatchEvent(new Event('change', {bubbles:true}));\n      siIn.value = sim;   siIn.dispatchEvent(new Event('input',{bubbles:true}));\n                           siIn.dispatchEvent(new Event('change',{bubbles:true}));\n\n      // 3.1) si el detalle muestra editable el idsolicitud, lo ponemos\n      var idSol = (document.querySelector('[id^=\"value_idsolicitud_\"]')||{}).value\n               || (document.querySelector('[name=\"editid1\"]')||{}).value\n               || (new URLSearchParams(location.search).get('editid1'));\n      var idIn = row.querySelector('[id^=\"value_'+IDSOL_FIELD+'_\"]');\n      if (idIn && idSol){ idIn.value = idSol; idIn.dispatchEvent(new Event('change',{bubbles:true})); }\n\n      // 4) guardar todo (opcional)\n      if (AUTO_SAVE){\n        var saveBtn = panel.querySelector('[data-buttonevent=\"saveall\"]');\n        if (saveBtn) setTimeout(function(){ saveBtn.click(); }, 150);\n      }\n\n      // limpiar SIM para siguiente alta\n      var simInput = $('#qa_sim'); if (simInput) simInput.value = '';\n      toast('Registro agregado', true);\n    } catch(e){\n      console.error(e);\n      toast('No se pudo agregar', false);\n    } finally {\n      btn.disabled = false;\n    }\n  });\n})();\n</script>\n",
						"type": 0
					},
					"editedByRte": false
				}
			},
			"dbProps": {},
			"version": 13,
			"imageItem": {
				"type": "page_image"
			},
			"imageBgColor": "#f2f2f2",
			"controlsBgColor": "white",
			"imagePosition": "right",
			"listTotals": 1,
			"title": {}
		}
	],
	"geoCoding": {
		"enabled": false,
		"latField": "lat",
		"lonField": "lng",
		"addressFields": [
			"calle",
			"numeroext",
			"numeroint",
			"colonia",
			"ciudad",
			"estado",
			"cp",
			"lat",
			"lng"
		]
	},
	"caption": {
		"English": "Solicitudes"
	}
}