{
	"type": "EVENT_BUTTON",
	"name": "Button2",
	"serverCode": "// Put your code here.\n",
	"beforeJsCode": "try{\r\n  // ===== Utilidades PHPRunner (LIST + EDIT) =====\r\n  var page = (typeof pageObj !== \"undefined\" && pageObj) ? pageObj : null;\r\n\r\n  function getIdFromSelection(pg){\r\n    if (!pg || !pg.getSelectedKeys) return null;\r\n    var sel = pg.getSelectedKeys() || [];\r\n    if (!sel.length) return null;\r\n    return sel[0].keys ? sel[0].keys[0] : (sel[0].id || sel[0]);\r\n  }\r\n  function getIdFromPage(pg){\r\n    if (!pg) return null;\r\n    if (pg.getKeys && pg.getKeys().length) return pg.getKeys()[0];\r\n    if (pg.getRecordData){\r\n      var r = pg.getRecordData() || {};\r\n      if (typeof r.idsolicitud !== \"undefined\") return r.idsolicitud;\r\n    }\r\n    return null;\r\n  }\r\n  var id = getIdFromSelection(page) || getIdFromPage(page);\r\n  if (!id){\r\n    var m = location.search.match(/[?&](editid1|id|key1)=([^&]+)/i);\r\n    if (m) id = decodeURIComponent(m[2]);\r\n  }\r\n\r\n  // Lee valores visibles (LIST/EDIT)\r\n  function gv(field){\r\n    try{\r\n      if (window.Runner && Runner.getControl){\r\n        var pidEl = document.querySelector(\"[data-pageid]\");\r\n        var pid = pidEl ? pidEl.getAttribute(\"data-pageid\") : (page && page.id ? page.id : \"\");\r\n        var c = Runner.getControl(pid, field);\r\n        if (c && typeof c.getValue===\"function\"){\r\n          var v = c.getValue();\r\n          if (v!=null && v!==\"\") return v;\r\n        }\r\n      }\r\n    }catch(_){}\r\n    var el = document.querySelector('[data-field=\"'+field+'\"]');\r\n    if (el){\r\n      var t = (el.textContent || \"\").trim();\r\n      if (t) return t;\r\n    }\r\n    return \"\";\r\n  }\r\n\r\n  // Datos del documento\r\n  var imei = gv(\"noserie\") || \"\";\r\n  var icc  = gv(\"simcard\") || \"\";\r\n\r\n  function fechaLarga(){\r\n    var d = new Date();\r\n    var meses = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];\r\n    return \"Mérida, Yucatán a \" + d.getDate() + \" de \" + meses[d.getMonth()] + \" de \" + d.getFullYear();\r\n  }\r\n  var fechaEnc = fechaLarga();\r\n\r\n  function absPath(p){\r\n    var base = location.pathname.substring(0, location.pathname.lastIndexOf(\"/\") + 1);\r\n    return base + p.replace(/^\\/+/, \"\");\r\n  }\r\n  var logoUrl = absPath(\"images/LOGO NEGRO Y AZUL PEQUE.png\");\r\n\r\n  function esc(x){ return (x==null ? \"\" : String(x)); }\r\n  function safeIdPart(x){ return String(x==null?\"\":x).replace(/[^\\w\\-]+/g,\"_\"); }\r\n\r\n  // ===== HTML de la vista previa (con barra de acciones) =====\r\n  function buildHTML(){\r\n    var parts = [];\r\n    parts.push('<!doctype html>');\r\n    parts.push('<html lang=\"es\"><head><meta charset=\"utf-8\">');\r\n    parts.push('<title>Checklist de Entrega</title>');\r\n    parts.push('<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">');\r\n    parts.push('<style>');\r\n    parts.push('  @page { size: A4; margin: 18mm 18mm 18mm 18mm; }');\r\n    parts.push('  body { font-family: Arial, Helvetica, sans-serif; color:#111; font-size: 11.5pt; }');\r\n    parts.push('  .wrap { max-width: 760px; margin: 0 auto; }');\r\n    parts.push('  .toolbar { display:flex; gap:10px; justify-content:flex-end; margin:10px 0 14px; }');\r\n    parts.push('  .btn { padding:8px 12px; border:0; border-radius:8px; cursor:pointer; font-weight:700; color:#fff; }');\r\n    parts.push('  .btn-print { background:#111; }');\r\n    parts.push('  .btn-doc   { background:#1565c0; display: none }');\r\n    parts.push('  @media print { .toolbar { display:none; } }');\r\n\r\n    // Encabezado\r\n    parts.push('  .hdr { display:flex; align-items:flex-start; justify-content:space-between; margin-bottom: 6px; }');\r\n    parts.push('  .logo { height: 44px; }');\r\n    parts.push('  .fecha { text-align:right; font-weight:700; margin-top: 10px; }');\r\n    parts.push('  h1 { text-align:center; font-size: 16pt; margin: 10px 0 16px 0; font-weight:700; }');\r\n\r\n    // Tabla base\r\n    parts.push('  .grid { width:100%; border-collapse:collapse; table-layout:fixed; }');\r\n    parts.push('  .grid col:first-child { width: calc(100% - 34px); }');\r\n    parts.push('  .grid col:last-child  { width: 34px; }');\r\n    parts.push('  .grid td { padding: 6px 4px; vertical-align: top; }');\r\n    parts.push('  /* Encabezado de columnas con ancho propio */');\r\n    parts.push('  .grid-head col:first-child { width: calc(100% - 110px); }');\r\n    parts.push('  .grid-head col:last-child  { width: 110px; }');\r\n    parts.push('  .grid-head .th-right{ text-align:right; white-space:nowrap; }');\r\n    parts.push('  .grid-head .th-right small{ display:block; line-height:1; }');\r\n    parts.push('  /* Encabezado de columnas: ancho y tick alineado a la columna de checks */');\r\n    parts.push('  .grid-head{ position:relative; }');\r\n    parts.push('  .grid-head col:first-child { width: calc(100% - 100px); }');   // texto\r\n    parts.push('  .grid-head col:last-child  { width: 100px; }');               // columna de checks\r\n    parts.push('  .grid-head .th-right{ position:relative; text-align:center; }');\r\n    parts.push('  .grid-head .tick{ position:absolute; left:50%; transform:translateX(-50%);');\r\n    parts.push('     height:12px; line-height:12px; font-weight:700; }');\r\n/* Ajusta este offset para clavar el (✓) justo sobre la fila de cuadros */\r\nparts.push('  .grid-head .tick{ bottom:-6px; }');\r\n\r\n    parts.push('  .head td { font-weight:700; padding-top:4px; padding-bottom:10px; }');\r\n    parts.push('  .th-left { text-align:left; }');\r\n    parts.push('  .th-right{ text-align:left; }');\r\n    parts.push('  .lbl { font-weight:400; }');\r\n    parts.push('  .lbl-head { font-weight:600; }');\r\n    parts.push('  .chk { text-align:center; }');\r\n    parts.push('  .box { display:inline-block; width:12px; height:12px; border:1px solid #111; }');\r\n\r\n    // Sangrías\r\n    parts.push('  .indent-1 { padding-left: 24px; }');\r\n    parts.push('  .indent-2 { padding-left: 48px; }');\r\n\r\n    // Líneas IMEI/ICC\r\n    parts.push('  .line { display:inline-block; border-bottom:1px solid #222; min-width: 360px; transform: translateY(-2px); }');\r\n\r\n    // Secciones\r\n    parts.push('  .section { border:1px solid #bbb; border-radius:10px; padding:8px 10px; margin:10px 0 12px; }');\r\n\r\n    // Firmas\r\n    parts.push('  .sign-block { }');\r\n    parts.push('  .sign-row   { display:flex; justify-content:space-between; gap:48px; }');\r\n    parts.push('  .sign-col   { width:48%; text-align:center; }');\r\n    parts.push('  .sign-title { font-weight:700; margin-bottom: 60px; }');\r\n    parts.push('  .sign-hr    { border:0; border-top:1px solid #111; margin: 0 auto 6px; width: 92%; }');\r\n    parts.push('  .sign-name  { font-weight:700; }');\r\n    parts.push('</style></head><body>');\r\n    parts.push('<div class=\"wrap\">');\r\n\r\n    // Barra de acciones (vista previa)\r\n    parts.push('  <div class=\"toolbar\">');\r\n    parts.push('    <button class=\"btn btn-print\" onclick=\"window.print()\">Imprimir / PDF</button>');\r\n    parts.push('    <button class=\"btn btn-doc\" id=\"dlDoc\">Descargar Word</button>');\r\n    parts.push('  </div>');\r\n\r\n    // Encabezado con logo y fecha\r\n    parts.push('  <div class=\"hdr\">');\r\n    parts.push('    <img class=\"logo\" src=\"'+esc(logoUrl)+'\" alt=\"Logo\">');\r\n    parts.push('    <div class=\"fecha\">'+esc(fechaEnc)+'</div>');\r\n    parts.push('  </div>');\r\n    parts.push('  <h1>CHECKLIST DE ENTREGA VALIDADOR - ENTREGADOR</h1>');\r\n\r\n    // Encabezado columnas\r\n    parts.push('  <table class=\"grid grid-head\"><col><col>');\r\n    parts.push('    <tr class=\"head\">');\r\n    parts.push('      <td class=\"th-left\">Documentos / Equipos</td>');\r\n    parts.push('      <td class=\"th-right\">Verificado<span class=\"tick\">✓</span></td>');\r\n    parts.push('    </tr>');\r\n    parts.push('  </table>');\r\n\r\n    // Sección 1\r\n    parts.push('  <div class=\"section\">');\r\n    parts.push('    <table class=\"grid\"><col><col>');\r\n    parts.push('      <tr><td class=\"lbl\">CARTA DE BIENVENIDA</td><td class=\"chk\"><span class=\"box\"></span></td></tr>');\r\n    parts.push('      <tr><td class=\"lbl\">CONTRATO</td><td class=\"chk\"><span class=\"box\"></span></td></tr>');\r\n    parts.push('      <tr><td class=\"lbl\">CARTA BURÓ</td><td class=\"chk\"><span class=\"box\"></span></td></tr>');\r\n    parts.push('    </table>');\r\n    parts.push('  </div>');\r\n\r\n    // Sección 2\r\n    parts.push('  <div class=\"section\">');\r\n    parts.push('    <table class=\"grid\"><col><col>');\r\n    parts.push('      <tr><td class=\"lbl-head\">RESUMEN DE EQUIPO</td><td class=\"chk\"></td></tr>');\r\n    parts.push('      <tr><td class=\"lbl indent-1\">EQUIPO CELULAR COMPLETO Y EN BUEN ESTADO</td><td class=\"chk\"><span class=\"box\"></span></td></tr>');\r\n    parts.push('      <tr><td class=\"lbl indent-2\">IMEI DEL EQUIPO:&nbsp;<span class=\"line\">'+esc(imei)+'</span></td><td class=\"chk\"></td></tr>');\r\n    parts.push('      <tr><td class=\"lbl indent-1\">SIM</td><td class=\"chk\"><span class=\"box\"></span></td></tr>');\r\n    parts.push('      <tr><td class=\"lbl indent-2\">ICC ID DE SIM:&nbsp;<span class=\"line\">'+esc(icc)+'</span></td><td class=\"chk\"></td></tr>');\r\n    parts.push('      <tr><td class=\"lbl\">FACTURA DE EQUIPO</td><td class=\"chk\"><span class=\"box\"></span></td></tr>');\r\n    parts.push('      <tr><td class=\"lbl\">PÓLIZA DE SEGURO / CARTA DE RECHAZO</td><td class=\"chk\"><span class=\"box\"></span></td></tr>');\r\n    parts.push('    </table>');\r\n    parts.push('  </div>');\r\n\r\n    // Sección 3\r\n    parts.push('  <div class=\"section\">');\r\n    parts.push('    <table class=\"grid\"><col><col>');\r\n    parts.push('      <tr><td class=\"lbl-head\">OPCIONES DE IDENTIFICACIÓN</td><td class=\"chk\"></td></tr>');\r\n    parts.push('      <tr><td class=\"lbl indent-1\">INE</td><td class=\"chk\"><span class=\"box\"></span></td></tr>');\r\n    parts.push('      <tr><td class=\"lbl indent-1\">PASAPORTE</td><td class=\"chk\"><span class=\"box\"></span></td></tr>');\r\n    parts.push('      <tr><td class=\"lbl indent-1\">FORMA MIGRATORIA</td><td class=\"chk\"><span class=\"box\"></span></td></tr>');\r\n    parts.push('      <tr><td class=\"lbl\">COMPROBANTE DE DOMICILIO</td><td class=\"chk\"><span class=\"box\"></span></td></tr>');\r\n    parts.push('    </table>');\r\n    parts.push('  </div>');\r\n\r\n    // Sección 4 (firmas)\r\n    parts.push('  <div class=\"section\">');\r\n    parts.push('    <div class=\"sign-block\">');\r\n    parts.push('      <div class=\"sign-row\">');\r\n    parts.push('        <div class=\"sign-col\"><div class=\"sign-title\">ENTREGA</div></div>');\r\n    parts.push('        <div class=\"sign-col\"><div class=\"sign-title\">RECIBE</div></div>');\r\n    parts.push('      </div>');\r\n    parts.push('      <div class=\"sign-row\">');\r\n    parts.push('        <div class=\"sign-col\"><hr class=\"sign-hr\"><div class=\"sign-name\">Ing. Martín Torres Zenteno</div></div>');\r\n    parts.push('        <div class=\"sign-col\"><hr class=\"sign-hr\"><div class=\"sign-name\">Entregador - Validador</div></div>');\r\n    parts.push('      </div>');\r\n    parts.push('    </div>');\r\n    parts.push('  </div>');\r\n\r\n    parts.push('  <div style=\"text-align:right; font-size:10pt; opacity:.85; margin-top:8px;\">Página 1 | 1</div>');\r\n    parts.push('</div>'); // wrap\r\n\r\n    // Script DENTRO de la vista previa: adjunta handler a #dlDoc\r\n    parts.push('<script>(function(){');\r\n    parts.push('  function saveAsWord(html, filename){');\r\n    parts.push('    if (window.navigator && window.navigator.msSaveOrOpenBlob){');\r\n    parts.push('      var blobIE = new Blob([html], { type: \"application/msword;charset=utf-8\" });');\r\n    parts.push('      return window.navigator.msSaveOrOpenBlob(blobIE, filename);');\r\n    parts.push('    }');\r\n    parts.push('    try{');\r\n    parts.push('      var blob = new Blob([html], { type: \"application/msword;charset=utf-8\" });');\r\n    parts.push('      var url  = URL.createObjectURL(blob);');\r\n    parts.push('      var a = document.createElement(\"a\");');\r\n    parts.push('      a.href = url; a.download = filename;');\r\n    parts.push('      document.body.appendChild(a); a.click();');\r\n    parts.push('      setTimeout(function(){ URL.revokeObjectURL(url); if(a.parentNode) a.parentNode.removeChild(a); }, 500);');\r\n    parts.push('      return true;');\r\n    parts.push('    }catch(e){}');\r\n    parts.push('    try{');\r\n    parts.push('      var dataUrl = \"data:application/msword;charset=utf-8,\" + encodeURIComponent(html);');\r\n    parts.push('      var w = window.open(dataUrl, \"_blank\");');\r\n    parts.push('      if (!w || w.closed || typeof w.closed === \"undefined\") { location.href = dataUrl; }');\r\n    parts.push('      return true;');\r\n    parts.push('    }catch(e2){ alert(\"No fue posible generar el Word: \" + e2.message); return false; }');\r\n    parts.push('  }');\r\n\r\n    parts.push('  function getHTMLForDoc(){');\r\n    parts.push('    var clone = document.documentElement.cloneNode(true);');\r\n    parts.push('    var tb = clone.querySelector(\".toolbar\"); if (tb && tb.parentNode) tb.parentNode.removeChild(tb);');\r\n    parts.push('    var scripts = clone.querySelectorAll(\"script\");');\r\n    parts.push('    for (var i=0;i<scripts.length;i++){ var s = scripts[i]; if (s.parentNode) s.parentNode.removeChild(s); }');\r\n    parts.push('    return \"\\\\ufeff\" + \"<!doctype html>\\\\n\" + clone.outerHTML;');\r\n    parts.push('  }');\r\n\r\n    parts.push('  var btn = document.getElementById(\"dlDoc\");');\r\n    parts.push('  if(btn){');\r\n    parts.push('    btn.addEventListener(\"click\", function(){');\r\n    parts.push('      try{');\r\n    parts.push('        var html = getHTMLForDoc();');\r\n    parts.push('        var fname = \"Checklist_Entrega'+(id?('_'+safeIdPart(id)):'')+'.doc\";');\r\n    parts.push('        var ok = saveAsWord(html, fname);');\r\n    parts.push('        if(!ok){ alert(\"El navegador bloqueó la descarga. Permite pop-ups/descargas para este sitio.\"); }');\r\n    parts.push('      }catch(e){ alert(\"No fue posible generar el Word: \" + e.message); }');\r\n    parts.push('    });');\r\n    parts.push('  }');\r\n    parts.push('})();<\\/script>');\r\n\r\n    parts.push('</body></html>');\r\n    return parts.join('');\r\n  }\r\n\r\n  // ===== Abrir vista previa en nueva pestaña y cargar el HTML =====\r\n  var w = window.open(\"about:blank\",\"_blank\");\r\n  if (w && !w.closed){\r\n    w.document.open();\r\n    w.document.write(buildHTML());\r\n    w.document.close();\r\n    w.focus();\r\n  } else {\r\n    // Fallback si bloquean popups: navegar al blob de la vista previa\r\n    var blob = new Blob([buildHTML()], {type:\"text/html\"});\r\n    var url  = URL.createObjectURL(blob);\r\n    location.href = url;\r\n  }\r\n\r\n  return false;\r\n}catch(e){\r\n  alert(\"Error al generar el checklist: \" + e.message);\r\n  return false;\r\n}\r\n",
	"afterJsCode": "// Put your code here.\n"
}