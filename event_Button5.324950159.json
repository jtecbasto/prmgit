{
	"type": "EVENT_BUTTON",
	"name": "Button5",
	"beforeJsCode": "try{\r\n  // ===== Utilidades PHPRunner (LIST + EDIT) =====\r\n  var page = (typeof pageObj !== \"undefined\" && pageObj) ? pageObj : null;\r\n\r\n  function limpio(x){\r\n    return (x == null ? \"\" : String(x).trim());\r\n  }\r\n\r\n  // ===== ID DESDE LA FILA DEL LIST =====\r\n  var id = null;\r\n\r\n  // PHPRunner nuevo: row.data\r\n  if (row && row.data && typeof row.data[\"idsolicitud\"] !== \"undefined\"){\r\n    id = row.data[\"idsolicitud\"];\r\n  }\r\n  // Fallback: getFieldValue\r\n  if (!id && row && typeof row.getFieldValue === \"function\"){\r\n    id = row.getFieldValue(\"idsolicitud\");\r\n  }\r\n\r\n  // Fallbacks extra (por si acaso)\r\n  function getIdFromSelection(pg){\r\n    if (!pg || !pg.getSelectedKeys) return null;\r\n    var sel = pg.getSelectedKeys() || [];\r\n    if (!sel.length) return null;\r\n    return sel[0].keys ? sel[0].keys[0] : (sel[0].id || sel[0]);\r\n  }\r\n  function getIdFromPage(pg){\r\n    if (!pg) return null;\r\n    if (pg.getKeys && pg.getKeys().length) return pg.getKeys()[0];\r\n    if (pg.getRecordData){\r\n      var r = pg.getRecordData() || {};\r\n      if (typeof r.idsolicitud !== \"undefined\") return r.idsolicitud;\r\n    }\r\n    return null;\r\n  }\r\n\r\n  if (!id){\r\n    id = getIdFromSelection(page) || getIdFromPage(page);\r\n  }\r\n  if (!id){\r\n    var m = location.search.match(/[?&](editid1|id|key1)=([^&]+)/i);\r\n    if (m) id = decodeURIComponent(m[2]);\r\n  }\r\n  if (!id){\r\n    alert(\"No se pudo determinar el ID de la solicitud.\\nAsegúrate de que 'idsolicitud' está en el SELECT del LIST.\");\r\n    return false;\r\n  }\r\n\r\n  // ===== Lee valores visibles, priorizando la fila del LIST =====\r\n  function gv(field){\r\n    var v;\r\n\r\n    // 1) Desde la fila (row)\r\n    if (row){\r\n      if (row.data && typeof row.data[field] !== \"undefined\" && row.data[field] !== null && row.data[field] !== \"\"){\r\n        return String(row.data[field]);\r\n      }\r\n      if (typeof row.getFieldValue === \"function\"){\r\n        v = row.getFieldValue(field);\r\n        if (v != null && v !== \"\") return String(v);\r\n      }\r\n    }\r\n\r\n    // 2) Desde controles Runner (EDIT o LIST editable)\r\n    try{\r\n      if (window.Runner && Runner.getControl){\r\n        var pidEl = document.querySelector(\"[data-pageid]\");\r\n        var pid = pidEl ? pidEl.getAttribute(\"data-pageid\") : (page && page.id ? page.id : \"\");\r\n        var c = Runner.getControl(pid, field);\r\n        if (c && typeof c.getValue===\"function\"){\r\n          var v2 = c.getValue();\r\n          if (v2!=null && v2!==\"\") return v2;\r\n        }\r\n      }\r\n    }catch(_){}\r\n\r\n    // 3) Fallback DOM (primer match)\r\n    var el = document.querySelector('[data-field=\"'+field+'\"]');\r\n    if (el){\r\n      var t = (el.textContent || \"\").trim();\r\n      if (t) return t;\r\n    }\r\n    return \"\";\r\n  }\r\n\r\n  // ===== Datos del documento (por fila) =====\r\n  var imei = gv(\"noserie\") || \"\";\r\n\r\n  // Leer valor crudo del campo simcard\r\n  var iccRaw = gv(\"simcard\") || \"\";\r\n  var icc    = \"\";\r\n\r\n  // Limpiar ruidos típicos de la celda del lookup\r\n  if (iccRaw) {\r\n    var txt = String(iccRaw).trim();\r\n\r\n    // Si trae el texto del filtro/lookup, lo consideramos vacío\r\n    if ( /Seleccionar todo|resultados de búsqueda|Agregar a la existencia|Borrar todos los filtros|Cancelar/i.test(txt) ) {\r\n      icc = \"\";\r\n    } else {\r\n      // Si trae varias palabras, nos quedamos con la primera (normalmente el ICC)\r\n      var first = txt.split(/\\s+/)[0];\r\n      icc = first;\r\n    }\r\n  }\r\n\r\n  var dn = gv(\"dn\") || \"\";\r\n  var totalapagar = gv(\"totalapagar\") || \"\";\r\n\r\n  // Dirección sugerida (si tienes esos campos en la solicitud)\r\n  var partesDir = [];\r\n  var cCalle  = gv(\"calle\");\r\n  var cNumExt = gv(\"numeroext\");\r\n  var cNumInt = gv(\"numeroint\");\r\n  var cCol    = gv(\"colonia\");\r\n  var cCP     = gv(\"cp\");\r\n  var cCd     = gv(\"ciudad\");\r\n  var cEst    = gv(\"estado\");\r\n\r\n  if (cCalle)  partesDir.push(cCalle + (cNumExt ? \" \" + cNumExt : \"\") + (cNumInt ? \" Int. \" + cNumInt : \"\"));\r\n  if (cCol)    partesDir.push(\"Col. \" + cCol);\r\n  if (cCP)     partesDir.push(\"C.P. \" + cCP);\r\n  if (cCd)     partesDir.push(cCd);\r\n  if (cEst)    partesDir.push(cEst);\r\n\r\n  var dirEntrega = partesDir.join(\", \");\r\n  var dirEntrega = gv(\"direccion\");\r\n\r\n  function fechaLarga(){\r\n    var d = new Date();\r\n    var meses = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];\r\n    return \"Mérida, Yucatán a \" + d.getDate() + \" de \" + meses[d.getMonth()] + \" de \" + d.getFullYear();\r\n  }\r\n  var fechaEnc = fechaLarga();\r\n\r\n  function esc(x){ return (x==null ? \"\" : String(x)); }\r\n  function safeIdPart(x){ return String(x==null?\"\":x).replace(/[^\\w\\-]+/g,\"_\"); }\r\n\r\n    // ==== Formato de moneda ====\r\n  function formatMoneda(val){\r\n    if (val === null || val === undefined) return \"\";\r\n    var s = String(val).replace(/[^\\d.-]/g, \"\"); // quita símbolos\r\n    if (s === \"\") return \"\";\r\n    var num = parseFloat(s);\r\n    if (isNaN(num)) return \"\";\r\n    // es-MX -> coma miles, punto decimales\r\n    return num.toLocaleString(\"es-MX\", {\r\n      minimumFractionDigits: 2,\r\n      maximumFractionDigits: 2\r\n    });\r\n  }\r\n\r\n  // ==== Número a letras para pesos mexicanos ====\r\n  function numeroALetrasMoneda(val){\r\n    if (val === null || val === undefined) return \"\";\r\n    var s = String(val).replace(/[^\\d.-]/g, \"\");\r\n    if (s === \"\") return \"\";\r\n    var num = parseFloat(s);\r\n    if (isNaN(num)) return \"\";\r\n\r\n    num = Math.round(num * 100) / 100;\r\n    var entero = Math.floor(Math.abs(num));\r\n    var cent   = Math.round((Math.abs(num) - entero) * 100);\r\n    var centText = (cent < 10 ? \"0\"+cent : \"\"+cent);\r\n\r\n    var textoEntero = numeroALetras(entero);\r\n    var moneda = (entero === 1 ? \"peso\" : \"pesos\");\r\n\r\n    return textoEntero + \" \" + moneda + \" \" + centText + \"/100 MN\";\r\n  }\r\n\r\n  function numeroALetras(num){\r\n    num = Math.floor(num);\r\n    if (num === 0) return \"cero\";\r\n    if (num < 0)   return \"menos \" + numeroALetras(-num);\r\n\r\n    var texto = \"\";\r\n\r\n    if (num >= 1000000){\r\n      var millones = Math.floor(num / 1000000);\r\n      var restoM   = num % 1000000;\r\n      texto += (millones === 1 ? \"un millón\" : numeroALetras(millones) + \" millones\");\r\n      if (restoM > 0) texto += \" \" + numeroALetras(restoM);\r\n      return texto;\r\n    }\r\n\r\n    if (num >= 1000){\r\n      var miles = Math.floor(num / 1000);\r\n      var resto = num % 1000;\r\n      if (miles === 1) texto += \"mil\";\r\n      else texto += numeroALetras(miles) + \" mil\";\r\n      if (resto > 0) texto += \" \" + centenas(resto);\r\n      return texto;\r\n    }\r\n\r\n    return centenas(num);\r\n  }\r\n\r\n  function centenas(num){\r\n    if (num < 100) return decenas(num);\r\n    var c = Math.floor(num / 100);\r\n    var resto = num % 100;\r\n    var texto = \"\";\r\n\r\n    switch(c){\r\n      case 1: texto = (resto === 0 ? \"cien\" : \"ciento\"); break;\r\n      case 2: texto = \"doscientos\";   break;\r\n      case 3: texto = \"trescientos\";  break;\r\n      case 4: texto = \"cuatrocientos\";break;\r\n      case 5: texto = \"quinientos\";   break;\r\n      case 6: texto = \"seiscientos\";  break;\r\n      case 7: texto = \"setecientos\";  break;\r\n      case 8: texto = \"ochocientos\";  break;\r\n      case 9: texto = \"novecientos\";  break;\r\n    }\r\n    if (resto > 0) texto += \" \" + decenas(resto);\r\n    return texto;\r\n  }\r\n\r\n  function decenas(num){\r\n    if (num < 10) return unidades(num);\r\n\r\n    if (num >= 10 && num < 20){\r\n      var especiales = [\r\n        \"diez\",\"once\",\"doce\",\"trece\",\"catorce\",\r\n        \"quince\",\"dieciséis\",\"diecisiete\",\"dieciocho\",\"diecinueve\"\r\n      ];\r\n      return especiales[num - 10];\r\n    }\r\n\r\n    if (num >= 20 && num < 30){\r\n      if (num === 20) return \"veinte\";\r\n      return \"veinti\" + unidades(num - 20);\r\n    }\r\n\r\n    var d = Math.floor(num / 10);\r\n    var u = num % 10;\r\n    var tensName = \"\";\r\n\r\n    switch(d){\r\n      case 3: tensName = \"treinta\";  break;\r\n      case 4: tensName = \"cuarenta\"; break;\r\n      case 5: tensName = \"cincuenta\";break;\r\n      case 6: tensName = \"sesenta\";  break;\r\n      case 7: tensName = \"setenta\";  break;\r\n      case 8: tensName = \"ochenta\";  break;\r\n      case 9: tensName = \"noventa\";  break;\r\n    }\r\n    if (u === 0) return tensName;\r\n    return tensName + \" y \" + unidades(u);\r\n  }\r\n\r\n  function unidades(num){\r\n    switch(num){\r\n      case 1: return \"un\";\r\n      case 2: return \"dos\";\r\n      case 3: return \"tres\";\r\n      case 4: return \"cuatro\";\r\n      case 5: return \"cinco\";\r\n      case 6: return \"seis\";\r\n      case 7: return \"siete\";\r\n      case 8: return \"ocho\";\r\n      case 9: return \"nueve\";\r\n      default: return \"\";\r\n    }\r\n  }\r\n\r\n  // Precalcular monto formateado y en letras\r\n  var totalapagarNum    = formatMoneda(totalapagar);\r\n  var totalapagarLetras = numeroALetrasMoneda(totalapagar);\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n  // Ruta absoluta para el logo\r\n  function absPath(p){\r\n    var base = location.pathname.substring(0, location.pathname.lastIndexOf(\"/\") + 1);\r\n    return base + p.replace(/^\\/+/, \"\");\r\n  }\r\n  var logoUrl = absPath(\"images/LOGO NEGRO Y AZUL PEQUE.png\");\r\n\r\n  // Preparamos el nombre base del archivo Word\r\n  var fnameBase = \"Checklist_Entrega\" + (id ? \"_\" + safeIdPart(id) : \"\");\r\n\r\n  // ===== HTML de la vista previa (formato igual al documento) =====\r\n  function buildHTML(){\r\n    var parts = [];\r\n    parts.push('<!doctype html>');\r\n    parts.push('<html lang=\"es\"><head><meta charset=\"utf-8\">');\r\n    parts.push('<title>Checklist Proceso de Entrega</title>');\r\n    parts.push('<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">');\r\n    parts.push('<style>');\r\n    parts.push('  @page { size: A4; margin: 18mm 18mm 18mm 18mm; }');\r\n    parts.push('  body { font-family: Arial, Helvetica, sans-serif; color:#111; font-size: 11.5pt; }');\r\n    parts.push('  .wrap { max-width: 760px; margin: 0 auto; }');\r\n    parts.push('  .logo{ height: 48px; display:block; }');\r\n    parts.push('  .toolbar { display:flex; gap:10px; justify-content:flex-end; margin:10px 0 14px; }');\r\n    parts.push('  .btn { padding:8px 12px; border:0; border-radius:8px; cursor:pointer; font-weight:700; color:#fff; }');\r\n    parts.push('  .btn-print { background:#111; }');\r\n    parts.push('  .btn-doc   { background:#1565c0; display: none }');\r\n    parts.push('  @media print { .toolbar { display:none; } }');\r\n\r\n    // Encabezado (logo izquierda, fecha derecha)\r\n    parts.push('  .hdr { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom: 6px; }');\r\n    parts.push('  .fecha { text-align:right; font-weight:700; }');\r\n    parts.push('  h1 { text-align:center; font-size: 13.5pt; margin: 6px 0 12px 0; font-weight:700; }');\r\n\r\n    // Tabla principal\r\n    parts.push('  .grid { width:100%; border-collapse:collapse; table-layout:fixed; }');\r\n    parts.push('  .grid col:first-child { width: calc(100% - 90px); }');\r\n    parts.push('  .grid col:last-child  { width: 90px; }');\r\n    parts.push('  .grid td { padding: 4px 4px; vertical-align: top; }');\r\n    parts.push('  .head-row td { font-weight:700; padding-bottom:8px; border-bottom:1px solid #000; }');\r\n    parts.push('  .head-doc { text-align:left; }');\r\n    parts.push('  .head-ver { text-align:center; }');\r\n    parts.push('  .lbl { }');\r\n    parts.push('  .chk { text-align:center; }');\r\n    parts.push('  .box { display:inline-block; width:12px; height:12px; border:1px solid #111; }');\r\n    parts.push('  .sec-title { font-weight:700; padding-top:10px; }');\r\n\r\n    parts.push('  .indent { padding-left: 24px; }');\r\n\r\n    // Líneas de texto\r\n    parts.push('  .line { display:inline-block; border-bottom:1px solid #222; min-width: 360px; transform: translateY(-2px); }');\r\n    parts.push('  .line-wide { display:inline-block; border-bottom:1px solid #222; min-width: 580px; transform: translateY(-2px); margin-top: 15px; }');\r\n    parts.push('  .line-mid { display:inline-block; border-bottom:1px solid #222; min-width: 260px; transform: translateY(-2px); }');\r\n\r\n    // Firmas (3 columnas)\r\n    parts.push('  .sign-block { margin-top: 24px; }');\r\n    parts.push('  .sign-row3 { display:flex; justify-content:space-between; gap:24px; }');\r\n    parts.push('  .sign-col  { width:33%; text-align:center; }');\r\n    parts.push('  .sign-title { font-weight:600; margin-bottom: 40px; }');\r\n    parts.push('  .sign-hr    { border:0; border-top:1px solid #111; margin: 0 auto 6px; width: 92%; }');\r\n    parts.push('  .sign-name  { font-weight:700; }');\r\n    parts.push('</style></head><body>');\r\n    parts.push('<div class=\"wrap\">');\r\n\r\n    // Barra de acciones (vista previa)\r\n    parts.push('  <div class=\"toolbar\">');\r\n    parts.push('    <button class=\"btn btn-print\" onclick=\"window.print()\">Imprimir / PDF</button>');\r\n    parts.push('    <button class=\"btn btn-doc\" id=\"dlDoc\">Descargar Word</button>');\r\n    parts.push('  </div>');\r\n\r\n    // Encabezado: logo izquierda + fecha derecha\r\n    parts.push('  <div class=\"hdr\">');\r\n    parts.push('    <img class=\"logo\" src=\"'+esc(logoUrl)+'\" alt=\"Logo\">');\r\n    parts.push('    <div class=\"fecha\">'+esc(fechaEnc)+'</div>');\r\n    parts.push('  </div>');\r\n\r\n    // Título\r\n    parts.push('  <h1>CHECKLIST DE PROCESO DE ENTREGA / EN TRANSITO / EXPEDIENTE-CORTE</h1>');\r\n\r\n    // Tabla principal (Documentos / Equipos + Verificado)\r\n    parts.push('  <table class=\"grid\"><col><col>');\r\n    parts.push('    <tr class=\"head-row\">');\r\n    parts.push('      <td class=\"head-doc\">Documentos / Equipos</td>');\r\n    parts.push('      <td class=\"head-ver\">Verificado (&#10003;)</td>');\r\n    parts.push('    </tr>');\r\n\r\n    // Filas de documentos\r\n    parts.push('    <tr><td class=\"lbl\">CARTA DE BIENVENIDA</td><td class=\"chk\"><span class=\"box\"></span></td></tr>');\r\n    parts.push('    <tr><td class=\"lbl\">CONTRATO</td><td class=\"chk\"><span class=\"box\"></span></td></tr>');\r\n    parts.push('    <tr><td class=\"lbl\">CARTA BURÓ</td><td class=\"chk\"><span class=\"box\"></span></td></tr>');\r\n\r\n    parts.push('    <tr><td class=\"sec-title\" colspan=\"2\">RESUMEN DE EQUIPO</td></tr>');\r\n    parts.push('    <tr><td class=\"lbl indent\" >&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EQUIPO CELULAR COMPLETO Y EN BUEN ESTADO</td><td class=\"chk\"><span class=\"box\"></span></td></tr>');\r\n    parts.push('    <tr><td class=\"lbl indent\" colspan=\"2\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IMEI DEL EQUIPO:&nbsp;&nbsp;<span class=\"line\">'+esc(imei)+'</span></td></tr>');\r\n    parts.push('    <tr><td class=\"lbl indent\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SIM</td><td class=\"chk\"><span class=\"box\"></span></td></tr>');\r\n    parts.push('    <tr><td class=\"lbl indent\" colspan=\"2\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ICC ID DE SIM:&nbsp;&nbsp;<span class=\"line\">'+esc(icc)+'</span></td></tr>');\r\n    parts.push('    <tr><td class=\"lbl indent\" colspan=\"2\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DN:&nbsp;&nbsp;<span class=\"line\">'+esc(dn)+'</span></td></tr>');\r\n    parts.push('    <tr><td class=\"lbl\">FACTURA DE EQUIPO</td><td class=\"chk\"><span class=\"box\"></span></td></tr>');\r\n    parts.push('    <tr><td class=\"lbl\">PÓLIZA DE SEGURO / CARTA DE RECHAZO</td><td class=\"chk\"><span class=\"box\"></span></td></tr>');\r\n\r\n    parts.push('    <tr><td class=\"sec-title\" colspan=\"2\">OPCIONES DE IDENTIFICACIÓN</td></tr>');\r\n    parts.push('    <tr><td class=\"lbl indent\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;INE</td><td class=\"chk\"><span class=\"box\"></span></td></tr>');\r\n    parts.push('    <tr><td class=\"lbl indent\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PASAPORTE</td><td class=\"chk\"><span class=\"box\"></span></td></tr>');\r\n    parts.push('    <tr><td class=\"lbl indent\">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FORMA MIGRATORIA</td><td class=\"chk\"><span class=\"box\"></span></td></tr>');\r\n    parts.push('    <tr><td class=\"lbl\">COMPROBANTE DE DOMICILIO</td><td class=\"chk\"><span class=\"box\"></span></td></tr>');\r\n\r\n    parts.push('    <tr><td class=\"lbl\" colspan=\"2\" style=\"padding-top:10px;\">DIRECCIÓN DE ENTREGA:&nbsp;<span class=\"line-wide\">'+esc(dirEntrega)+'</span></td></tr>');\r\nparts.push(\r\n  '    <tr><td class=\"lbl\" colspan=\"2\" style=\"padding-top:8px;\">' +\r\n  'TOTAL, A PAGAR:&nbsp;&nbsp;&nbsp;$<span class=\"line\">'+esc(totalapagarNum)+\r\n  '&nbsp;&nbsp;SON: ('+esc(totalapagarLetras.toUpperCase())+')' + '</span>' +\r\n  '</td></tr>'\r\n);\r\n\r\n    parts.push('  </table>');\r\n\r\n    // Sección de firmas (3 columnas)\r\n    parts.push('  <div class=\"sign-block\">');\r\n    parts.push('    <div class=\"sign-row3\">');\r\n    parts.push('      <div class=\"sign-col\"><div class=\"sign-title\">ENTREGÓ</div></div>');\r\n    parts.push('      <div class=\"sign-col\"><div class=\"sign-title\">RECIBE</div></div>');\r\n    parts.push('      <div class=\"sign-col\"><div class=\"sign-title\">RECEPCIÓN DE EXPEDIENTE Y CORTE</div></div>');\r\n    parts.push('    </div>');\r\n    parts.push('    <div class=\"sign-row3\">');\r\n    parts.push('      <div class=\"sign-col\"><hr class=\"sign-hr\"><div class=\"sign-name\">Ing. Martín Torres Zenteno</div></div>');\r\n    parts.push('      <div class=\"sign-col\"><hr class=\"sign-hr\"><div class=\"sign-name\">Entregador - Validador</div></div>');\r\n    parts.push('      <div class=\"sign-col\"><hr class=\"sign-hr\"><div class=\"sign-name\">Lic. Sol Mora Ortiz</div></div>');\r\n    parts.push('    </div>');\r\n    parts.push('  </div>');\r\n\r\n    parts.push('  <div style=\"text-align:right; font-size:10pt; opacity:.85; margin-top:8px;\">Página 1 | 1</div>');\r\n    parts.push('</div>'); // wrap\r\n\r\n    // Script DENTRO de la vista previa: handler de #dlDoc\r\n    parts.push('<script>(function(){');\r\n    parts.push('  function saveAsWord(html, filename){');\r\n    parts.push('    if (window.navigator && window.navigator.msSaveOrOpenBlob){');\r\n    parts.push('      var blobIE = new Blob([html], { type: \"application/msword;charset=utf-8\" });');\r\n    parts.push('      return window.navigator.msSaveOrOpenBlob(blobIE, filename);');\r\n    parts.push('    }');\r\n    parts.push('    try{');\r\n    parts.push('      var blob = new Blob([html], { type: \"application/msword;charset=utf-8\" });');\r\n    parts.push('      var url  = URL.createObjectURL(blob);');\r\n    parts.push('      var a = document.createElement(\"a\");');\r\n    parts.push('      a.href = url; a.download = filename;');\r\n    parts.push('      document.body.appendChild(a); a.click();');\r\n    parts.push('      setTimeout(function(){ URL.revokeObjectURL(url); if(a.parentNode) a.parentNode.removeChild(a); }, 500);');\r\n    parts.push('      return true;');\r\n    parts.push('    }catch(e){}');\r\n    parts.push('    try{');\r\n    parts.push('      var dataUrl = \"data:application/msword;charset=utf-8,\" + encodeURIComponent(html);');\r\n    parts.push('      var w = window.open(dataUrl, \"_blank\");');\r\n    parts.push('      if (!w || w.closed || typeof w.closed === \"undefined\") { location.href = dataUrl; }');\r\n    parts.push('      return true;');\r\n    parts.push('    }catch(e2){ alert(\"No fue posible generar el Word: \" + e2.message); return false; }');\r\n    parts.push('  }');\r\n\r\n    parts.push('  function getHTMLForDoc(){');\r\n    parts.push('    var clone = document.documentElement.cloneNode(true);');\r\n    parts.push('    var tb = clone.querySelector(\".toolbar\"); if (tb && tb.parentNode) tb.parentNode.removeChild(tb);');\r\n    parts.push('    var scripts = clone.querySelectorAll(\"script\");');\r\n    parts.push('    for (var i=0;i<scripts.length;i++){ var s = scripts[i]; if (s.parentNode) s.parentNode.removeChild(s); }');\r\n    parts.push('    return \"\\\\ufeff\" + \"<!doctype html>\\\\n\" + clone.outerHTML;');\r\n    parts.push('  }');\r\n\r\n    parts.push('  var btn = document.getElementById(\"dlDoc\");');\r\n    parts.push('  if(btn){');\r\n    parts.push('    btn.addEventListener(\"click\", function(){');\r\n    parts.push('      try{');\r\n    parts.push('        var html = getHTMLForDoc();');\r\n    parts.push('        var fname = \"'+fnameBase+'.doc\";');\r\n    parts.push('        var ok = saveAsWord(html, fname);');\r\n    parts.push('        if(!ok){ alert(\"El navegador bloqueó la descarga. Permite pop-ups/descargas para este sitio.\"); }');\r\n    parts.push('      }catch(e){ alert(\"No fue posible generar el Word: \" + e.message); }');\r\n    parts.push('    });');\r\n    parts.push('  }');\r\n    parts.push('})();<\\/script>');\r\n\r\n    parts.push('</body></html>');\r\n    return parts.join('');\r\n  }\r\n\r\n  // ===== Abrir vista previa en nueva pestaña y cargar el HTML =====\r\n  var w = window.open(\"about:blank\",\"_blank\");\r\n  if (w && !w.closed){\r\n    w.document.open();\r\n    w.document.write(buildHTML());\r\n    w.document.close();\r\n    w.focus();\r\n  } else {\r\n    // Fallback si bloquean popups: navegar al blob de la vista previa\r\n    var blob = new Blob([buildHTML()], {type:\"text/html\"});\r\n    var url  = URL.createObjectURL(blob);\r\n    location.href = url;\r\n  }\r\n\r\n  // Muy importante: cancelar llamada al servidor\r\n  return false;\r\n}catch(e){\r\n  alert(\"Error al generar el checklist: \" + e.message);\r\n  return false;\r\n}\r\n"
}