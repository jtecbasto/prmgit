{
	"type": "EVENT_BUTTON",
	"name": "Button3",
	"serverCode": "// Put your code here.\n\n$result[\"txt\"] = $params[\"txt\"].\" world!\";\n",
	"beforeJsCode": "try{\r\n  // ===== Utilidades PHPRunner (LIST + EDIT) =====\r\n  var page = (typeof pageObj !== \"undefined\" && pageObj) ? pageObj : null;\r\n\r\n  function getIdFromSelection(pg){\r\n    if (!pg || !pg.getSelectedKeys) return null;\r\n    var sel = pg.getSelectedKeys() || [];\r\n    if (!sel.length) return null;\r\n    return sel[0].keys ? sel[0].keys[0] : (sel[0].id || sel[0]);\r\n  }\r\n  function getIdFromPage(pg){\r\n    if (!pg) return null;\r\n    if (pg.getKeys && pg.getKeys().length) return pg.getKeys()[0];\r\n    if (pg.getRecordData){\r\n      var r = pg.getRecordData() || {};\r\n      if (typeof r.idsolicitud !== \"undefined\") return r.idsolicitud;\r\n    }\r\n    return null;\r\n  }\r\n\r\n  var id = getIdFromSelection(page) || getIdFromPage(page);\r\n  if (!id){\r\n    var m = location.search.match(/[?&](editid1|id|key1)=([^&]+)/i);\r\n    if (m) id = decodeURIComponent(m[2]);\r\n  }\r\n  if (!id){\r\n    alert(\"Seleccione un registro o abra un registro para imprimir la carta.\");\r\n    return false;\r\n  }\r\n\r\n  // Lee un valor visible del formulario/página si existe\r\n  function gv(field){\r\n    try{\r\n      if (window.Runner && Runner.getControl){\r\n        var pidEl = document.querySelector(\"[data-pageid]\");\r\n        var pid = pidEl ? pidEl.getAttribute(\"data-pageid\") : (page && page.id ? page.id : \"\");\r\n        var c = Runner.getControl(pid, field);\r\n        if (c && typeof c.getValue===\"function\"){\r\n          var v = c.getValue();\r\n          if (v!=null && v!==\"\") return v;\r\n        }\r\n      }\r\n    }catch(e){}\r\n    // En LIST, intentar por data-field (primer match visible)\r\n    var el = document.querySelector('[data-field=\"'+field+'\"]');\r\n    if (el) {\r\n      var t = (el.textContent||\"\").trim();\r\n      if (t) return t;\r\n    }\r\n    return \"\";\r\n  }\r\n\r\n  // Nombre del cliente: nombre + paterno + materno (con varios alias)\r\n  var nombreCliente = (function(){\r\n    var n = gv(\"nombre\")  || gv(\"Nombre\")  || \"\";\r\n    var p = gv(\"paterno\") || gv(\"Paterno\") || \"\";\r\n    var m = gv(\"materno\") || gv(\"Materno\") || \"\";\r\n    var full = [n,p,m].filter(Boolean).join(\" \").replace(/\\s+/g,\" \").trim();\r\n    var alt  = gv(\"cliente\") || gv(\"nombrecliente\") || \"\";\r\n    return (full || alt || \"[Nombre del Cliente]\");\r\n  })();\r\n\r\n  // RFC y DN opcionales\r\n  var rfc = gv(\"rfc\") || \"\";\r\n  var dn  = gv(\"dn\")  || gv(\"dnpreferido\") || \"\";\r\n\r\n  // Fecha actual tipo 12/Nov/2025\r\n  function formatFecha(){\r\n    var d = new Date();\r\n    var meses = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];\r\n    var dd = ('0'+d.getDate()).slice(-2);\r\n    var mm = meses[d.getMonth()];\r\n    var yy = d.getFullYear();\r\n    return dd + '/' + mm + '/' + yy;\r\n  }\r\n  var fechaHoy = formatFecha();\r\n\r\n  // Ruta absoluta al logo respetando subcarpeta (p.ej. /prm1/)\r\n  function buildAbs(path){\r\n    var p = location.pathname;\r\n    var base = p.substring(0, p.lastIndexOf(\"/\") + 1); // /prm1/\r\n    return base + path.replace(/^\\/+/, '');\r\n  }\r\n  var LOGO_FILE = 'images/LOGO NEGRO Y AZUL PEQUE.png';\r\n  var logoUrl   = buildAbs(LOGO_FILE);\r\n\r\n  function esc(x){ return (x==null ? \"\" : String(x)); }\r\n\r\n  // HTML seguro usando arrays + join\r\n  function buildLetterHTML(){\r\n    var parts = [];\r\n    parts.push('<!doctype html>');\r\n    parts.push('<html lang=\"es\"><head><meta charset=\"utf-8\">');\r\n    parts.push('<title>Carta de Bienvenida - '+esc(nombreCliente)+'</title>');\r\n    parts.push('<style>');\r\n    parts.push('  @page { size: A4; margin: 20mm 18mm 22mm 18mm; }');\r\n    parts.push('  html,body{ height:100%; }');\r\n    parts.push('  body{ font-family: Arial, Helvetica, sans-serif; font-size: 12pt; color:#111; }');\r\n    parts.push('  .wrap{ max-width: 700px; margin: 0 auto; }');\r\n    parts.push('  .logo{ height: 48px; display:block; margin: 0 0 6px 0; }');\r\n    parts.push('  .empresa{ text-align:center; font-weight:700; font-size:14pt; margin-top:4px; }');\r\n    parts.push('  .linea{ height:0; border:0; border-top:1.5px solid #1f2937; margin:10px 0 6px 0; }');\r\n    parts.push('  .fecha{ text-align:right; font-weight:700; margin:0 0 12px 0; }');\r\n    parts.push('  .titulo{ text-align:center; font-size:16pt; font-weight:700; margin:6px 0; }');\r\n    parts.push('  .linea2{ height:0; border:0; border-top:1.5px solid #1f2937; margin:6px 0 16px 0; }');\r\n    parts.push('  .cuerpo{ text-align:justify; text-justify:inter-word; line-height:1.5; }');\r\n    parts.push('  .cuerpo p{ margin:10pt 0 10pt 0; }');\r\n    parts.push('  .firma{ margin-top: 10pt; }');\r\n    parts.push('  .toolbar{ display:flex; gap:10px; justify-content:flex-end; margin:6px 0 14px; }');\r\n    parts.push('  .btn{ padding:8px 12px; border:0; border-radius:8px; cursor:pointer; font-weight:700; color:#fff; }');\r\n    parts.push('  .btn-print{ background:#111; }');\r\n    parts.push('  .btn-doc{ background:#1565c0; display:none; }');\r\n    parts.push('  @media print{ .toolbar{ display:none; } }');\r\n    parts.push('</style></head><body>');\r\n    parts.push('<div class=\"wrap\">');\r\n    parts.push('  <div class=\"toolbar\">');\r\n    parts.push('    <button class=\"btn btn-print\" onclick=\"window.print()\">Imprimir / PDF</button>');\r\n    parts.push('    <button class=\"btn btn-doc\" id=\"dlDoc\">Descargar Word</button>');\r\n    parts.push('  </div>');\r\n    parts.push('  <img class=\"logo\" src=\"'+esc(logoUrl)+'\" alt=\"Logo\">');\r\n    parts.push('  <div class=\"empresa\">Grupo ROCASA Peninsular, S.A. de C.V.</div>');\r\n    parts.push('  <hr class=\"linea\">');\r\n    parts.push('  <div class=\"fecha\">Fecha: '+esc(fechaHoy)+'</div>');\r\n    parts.push('  <div class=\"titulo\">Carta de Bienvenida</div>');\r\n    parts.push('  <hr class=\"linea2\">');\r\n    parts.push('  <div class=\"cuerpo\">');\r\n    parts.push('    <p></p>');\r\n    parts.push('    <p><b>Estimado(a) '+esc(nombreCliente)+':</b></p>');\r\n    parts.push('    <p>Reciba un cordial saludo de parte de todo el equipo de Grupo Rocasa Peninsular. ');\r\n    parts.push('    Nos complace enormemente que haya decidido <b>renovar su plan de servicio con nosotros</b>.</p>');\r\n    parts.push('    <p>Su confianza es el motor que nos impulsa a seguir mejorando día con día, ofreciéndole soluciones de comunicación confiables, modernas y adaptadas a sus necesidades.</p>');\r\n    parts.push('    <p>Queremos agradecerle sinceramente por seguir formando parte de nuestra comunidad de clientes. Valoramos su lealtad y la oportunidad de continuar brindándole un servicio de calidad, respaldado por la atención y el compromiso que nos caracterizan.</p>');\r\n    parts.push('    <p>Nos ponemos a su entera disposición para atender cualquier consulta o gestión relacionada con su servicio en cualquiera de nuestras sucursales o a través de nuestros canales de atención habituales. Nuestro personal estará siempre dispuesto a apoyarle en todo momento.</p>');\r\n    parts.push('    <p>Agradecemos nuevamente la confianza depositada en nosotros y reiteramos nuestro compromiso de seguir siendo su mejor aliado en comunicación.</p>');\r\n    parts.push('    <p></p>');\r\n    parts.push('    <p class=\"firma\">Con aprecio,</p>');\r\n    parts.push('    <p></p>');\r\n    parts.push('    <p></p>');\r\n    parts.push('    <p><b>Grupo Rocasa Peninsular</b></p>');\r\n    parts.push('    <p></p>');\r\n    parts.push('    <p><b>990 101 4993 / gerente.vnp@rocasamexico.com</b></p>');\r\n    parts.push('    <p></p>');\r\n    parts.push('    <p><b>www.rocasamexico.com</b></p>');\r\n    parts.push('  </div>');\r\n    parts.push('</div>');\r\n\r\n    // Script embebido para descargar DOC (sin romper cadenas)\r\n    parts.push('<script>(function(){');\r\n    parts.push('  var btn = document.getElementById(\"dlDoc\");');\r\n    parts.push('  if(!btn) return;');\r\n\r\n    parts.push('  function getHTMLForDoc(){');\r\n    parts.push('    var clone = document.documentElement.cloneNode(true);');\r\n    parts.push('    var tb = clone.querySelector(\".toolbar\"); if (tb) tb.parentNode.removeChild(tb);');\r\n    parts.push('    var scripts = clone.querySelectorAll(\"script\");');\r\n    parts.push('    for (var i=0;i<scripts.length;i++){ var s = scripts[i]; if (s.parentNode) s.parentNode.removeChild(s); }');\r\n    parts.push('    return \"\\\\ufeff\" + \"<!doctype html>\" + clone.outerHTML;');\r\n    parts.push('  }');\r\n\r\n    parts.push('  function saveAsWord(html, filename){');\r\n    parts.push('    if (window.navigator && window.navigator.msSaveOrOpenBlob){');\r\n    parts.push('      var blobIE = new Blob([html], { type: \"application/msword;charset=utf-8\" });');\r\n    parts.push('      return window.navigator.msSaveOrOpenBlob(blobIE, filename);');\r\n    parts.push('    }');\r\n    parts.push('    try{');\r\n    parts.push('      var blob = new Blob([html], { type: \"application/msword;charset=utf-8\" });');\r\n    parts.push('      var url  = URL.createObjectURL(blob);');\r\n    parts.push('      var a = document.createElement(\"a\");');\r\n    parts.push('      a.href = url; a.download = filename;');\r\n    parts.push('      document.body.appendChild(a); a.click();');\r\n    parts.push('      setTimeout(function(){ URL.revokeObjectURL(url); if(a.parentNode) a.parentNode.removeChild(a); }, 500);');\r\n    parts.push('      return true;');\r\n    parts.push('    }catch(e){ }');\r\n    parts.push('    try{');\r\n    parts.push('      var dataUrl = \"data:application/msword;charset=utf-8,\" + encodeURIComponent(html);');\r\n    parts.push('      var w = window.open(dataUrl, \"_blank\");');\r\n    parts.push('      if (!w || w.closed || typeof w.closed === \"undefined\") { location.href = dataUrl; }');\r\n    parts.push('      return true;');\r\n    parts.push('    }catch(e2){ alert(\"No fue posible generar el Word: \" + e2.message); return false; }');\r\n    parts.push('  }');\r\n\r\n    parts.push('  btn.addEventListener(\"click\", function(){');\r\n    parts.push('    var safeId = String(\"'+String(id).replace(/[^\\\\w\\\\-]+/g,\"_\")+'\");');\r\n    parts.push('    var html = getHTMLForDoc();');\r\n    parts.push('    var ok = saveAsWord(html, \"Carta_Bienvenida_\" + safeId + \".doc\");');\r\n    parts.push('    if(!ok){ alert(\"El navegador bloqueó la descarga. Permite pop-ups/descargas para este sitio.\"); }');\r\n    parts.push('  });');\r\n    parts.push('})();<\\/script>');\r\n\r\n    parts.push('</body></html>');\r\n    return parts.join('');\r\n  }\r\n\r\n  // Abrir en nueva pestaña/ventana\r\n  var w = window.open(\"about:blank\",\"_blank\");\r\n  if (w && !w.closed){\r\n    w.document.open();\r\n    w.document.write(buildLetterHTML());\r\n    w.document.close();\r\n    w.focus();\r\n  } else {\r\n    // Fallback si bloquean popups\r\n    var blob = new Blob([buildLetterHTML()], {type: \"text/html\"});\r\n    var url  = URL.createObjectURL(blob);\r\n    location.href = url;\r\n  }\r\n\r\n  return false;\r\n}catch(e){\r\n  alert(\"Error al generar la carta: \" + e.message);\r\n  return false;\r\n}\r\n",
	"afterJsCode": "// Put your code here.\n\nvar message = result[\"txt\"] + \" !!!\";\najax.setMessage(message);\n"
}